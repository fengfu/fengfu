<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="宁静·致远">
<meta property="og:url" content="http://fengfu.io/index.html">
<meta property="og:site_name" content="宁静·致远">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="宁静·致远">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://fengfu.io/"/>





  <title>宁静·致远</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">宁静·致远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-rss">
          <a href="/atom.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            RSS
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2018/03/26/Caffeine-比Guava-Cache更好的缓存/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/26/Caffeine-比Guava-Cache更好的缓存/" itemprop="url">Caffeine-比Guava Cache更好的缓存</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-26T17:09:15+08:00">
                2018-03-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/26/Caffeine-比Guava-Cache更好的缓存/" class="leancloud_visitors" data-flag-title="Caffeine-比Guava Cache更好的缓存">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>说起Guava Cache，很多人都不会陌生，它是Google Guava工具包中的一个非常方便易用的本地化缓存实现，基于LRU算法实现，支持多种缓存过期策略。由于Guava的大量使用，Guava Cache也得到了大量的应用。但是，Guava Cache的性能一定是最好的吗？也许，曾经，它的性能是非常不错的。但所谓长江后浪推前浪，总会有更加优秀的技术出现。今天，我就来介绍一个比Guava Cache性能更高的缓存框架：Caffeine。</p>
<p>下面的内容是转载的一篇译文，如果需要查看译文原文，请点击<a href="https://segmentfault.com/a/1190000008751999" target="_blank" rel="external">这里</a>,英语好的同学也可以直接查看<a href="http://highscalability.com/blog/2016/1/25/design-of-a-modern-cache.html" target="_blank" rel="external">英文原作</a>。</p>
<p>==========以下是原文内容==========</p>
<p>缓存是提升性能的通用方法，现在大多数的缓存实现都使用了经典的技术。这篇文章中，我们会发掘<a href="https://github.com/ben-manes/caffeine" target="_blank" rel="external">Caffeine</a>中的现代的实现方法。Caffeine是一个开源的Java缓存库，它能提供高命中率和出色的并发能力。期望读者们能被这些想法激发，进而将它们应用到任何你喜欢的编程语言中。</p>
<h2 id="驱逐策略"><a href="#驱逐策略" class="headerlink" title="驱逐策略"></a>驱逐策略</h2><p>缓存的驱逐策略是为了预测哪些数据在短期内最可能被再次用到，从而提升缓存的命中率。由于简洁的实现、高效的运行时表现以及在常规的使用场景下有不错的命中率，LRU（Least Recently Used）策略或许是最流行的驱逐策略。但LRU通过历史数据来预测未来是局限的，它会认为最后到来的数据是最可能被再次访问的，从而给与它最高的优先级。</p>
<p>现代缓存扩展了对历史数据的使用，结合就近程度（recency）和访问频次（frequency）来更好的预测数据。其中一种保留历史信息的方式是使用popularity sketch（一种压缩、概率性的数据结构）来从一大堆访问事件中定位频繁的访问者。可以参考<a href="http://dimacs.rutgers.edu/~graham/pubs/papers/cmsoft.pdf" target="_blank" rel="external">CountMin Sketch</a>算法，它由计数矩阵和多个哈希方法实现。发生一次读取时，矩阵中每行对应的计数器增加计数，估算频率时，取数据对应是所有行中计数的最小值。这个方法让我们从空间、效率、以及适配矩阵的长宽引起的哈希碰撞的错误率上做权衡。</p>
<p><img src="https://sfault-image.b0.upaiyun.com/198/843/1988435212-58d64be00bb9d_articlex" alt="CountMin Sketch"></p>
<p><a href="https://arxiv.org/pdf/1512.00727.pdf" target="_blank" rel="external">Window TinyLFU</a>（W-TinyLFU）算法将sketch作为过滤器，当新来的数据比要驱逐的数据高频时，这个数据才会被缓存接纳。这个许可窗口给予每个数据项积累热度的机会，而不是立即过滤掉。这避免了持续的未命中，特别是在突然流量暴涨的的场景中，一些短暂的重复流量就不会被长期保留。为了刷新历史数据，一个时间衰减进程被周期性或增量的执行，给所有计数器减半。</p>
<p><img src="https://sfault-image.b0.upaiyun.com/274/307/2743073853-58d64be0088fe_articlex" alt="Window TinyLFU"></p>
<p>对于长期保留的数据，W-TinyLFU使用了分段LRU（Segmented LRU，缩写SLRU）策略。起初，一个数据项存储被存储在试用段（probationary segment）中，在后续被访问到时，它会被提升到保护段（protected segment）中（保护段占总容量的80%）。保护段满后，有的数据会被淘汰回试用段，这也可能级联的触发试用段的淘汰。这套机制确保了访问间隔小的热数据被保存下来，而被重复访问少的冷数据则被回收。</p>
<p><img src="https://sfault-image.b0.upaiyun.com/571/159/571159220-58d64be031155_articlex" alt=""></p>
<p>如图中数据库和搜索场景的结果展示，通过考虑就近程度和频率能大大提升LRU的表现。一些高级的策略，像ARC，LIRS和W-TinyLFU都提供了接近最理想的命中率。想看更多的场景测试，请查看相应的论文，也可以在使用simulator来测试自己的场景。</p>
<h2 id="过期策略"><a href="#过期策略" class="headerlink" title="过期策略"></a>过期策略</h2><p>过期的实现里，往往每个数据项拥有不同的过期时间。因为容量的限制，过期后数据需要被懒淘汰，否则这些已过期的脏数据会污染到整个缓存。一般缓存中会启用专有的清扫线程周期性的遍历清理缓存。这个策略相比在每次读写操作时按照过期时间排序的优先队列来清理过期缓存要好，因为后台线程隐藏了的过期数据清除的时间开销。</p>
<p>鉴于大多数场景里不同数据项使用的都是固定的过期时长，Caffien采用了统一过期时间的方式。这个限制让用O（1）的有序队列组织数据成为可能。针对数据的写后过期，维护了一个写入顺序队列，针对读后过期，维护了一个读取顺序队列。缓存能复用驱逐策略下的队列以及下面将要介绍的并发机制，让过期的数据项在缓存的维护阶段被抛弃掉。</p>
<h2 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h2><p>由于在大多数的缓存策略中，数据的读取都会伴随对缓存状态的写操作，并发的缓存读取被视为一个难点问题。传统的解决方式是用同步锁。这可以通过将缓存的数据划成多个分区来进行锁拆分优化。不幸的是热点数据所持有的锁会比其他数据更常的被占有，在这种场景下锁拆分的性能提升也就没那么好了。当单个锁的竞争成为瓶颈后，接下来的经典的优化方式是只更新单个数据的元数据信息，以及使用<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.110.8469&amp;rep=rep1&amp;type=pdf" target="_blank" rel="external">随机采样</a>、<a href="https://en.wikipedia.org/wiki/Page_replacement_algorithm#Second-chance" target="_blank" rel="external">基于FIFO</a>的驱逐策略来减少数据操作。这些策略会带来高性能的读和低性能的写，同时在选择驱逐对象时也比较困难。</p>
<p>另一种<a href="http://web.cse.ohio-state.edu/hpcs/WWW/HTML/publications/papers/TR-09-1.pdf" target="_blank" rel="external">可行方案</a>来自于数据库理论，通过提交日志的方式来扩展写的性能。写入操作先记入日志中，随后异步的批量执行，而不是立即写入到数据结构中。这种思想可以应用到缓存中，执行哈希表的操作，将操作记录到缓冲区，然后在合适的时机执行缓冲区中的内容。这个策略依然需要同步锁或者tryLock，不同的是把对锁的竞争转移到对缓冲区的追加写上。</p>
<p>在Caffeine中，有一组缓冲区被用来记录读写。一次访问首先会被因线程而异的哈希到stripped ring buffer上，当检测到竞争时，缓冲区会自动扩容。一个ring buffer容量满载后，会触发异步的执行操作，而后续的对该ring buffer的写入会被丢弃，直到这个ring buffer可被使用。虽然因为ring buffer容量满而无法被记录该访问，但缓存值依然会返回给调用方。这种策略信息的丢失不会带来大的影响，因为W-TinyLFU能识别出我们希望保存的热点数据。通过使用因线程而异的哈希算法替代在数据项的键上做哈希，缓存避免了瞬时的热点key的竞争问题。</p>
<p><img src="https://sfault-image.b0.upaiyun.com/270/327/2703271825-58d64be011a4f_articlex" alt=""></p>
<p>写数据时，采用更传统的并发队列，每次变更会引起一次立即的执行。虽然数据的损失是不可接受的，但我们仍然有很多方法可以来优化写缓冲区。所有类型的缓冲区都被多个的线程写入，但却通过单个线程来执行。这种多生产者/单个消费者的模式允许了更简单、高效的算法来实现。</p>
<p>缓冲区和细粒度的写带来了单个数据项的操作乱序的竞态条件。插入、读取、更新、删除都可能被各种顺序的重放，如果这个策略控制的不合适，则可能引起悬垂索引。解决方案是通过状态机来定义单个数据项的生命周期。</p>
<p><img src="https://sfault-image.b0.upaiyun.com/270/327/2703271825-58d64be011a4f_articlex" alt=""></p>
<p>在<a href="https://github.com/ben-manes/caffeine/wiki/Benchmarks#read-100-1" target="_blank" rel="external">基准测试</a>中，缓冲区随着哈希表的增长而增长，它的的使用相对更节省资源。读的性能随着CPU的核数线性增长，是哈希表吞吐量的33%。写入有10%的性能损耗，这是因为更新哈希表时的竞争是最主要的开销。</p>
<p><img src="https://sfault-image.b0.upaiyun.com/250/918/2509180021-58d64be00f7f4_articlex" alt=""></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>还有许多实用的话题没有被覆盖到。包括最小化内存的技巧，当复杂度上升时保证质量的测试技术以及确定优化是否值得的性能分析方法。这些都是缓存的实践者需要关注的点，因为一旦这些被忽视，就很难重拾掌控缓存带来的复杂度的信心。</p>
<p>Caffeine的设计实现来自于大量的洞见和许多贡献者的共同努力。它这些年的演化离不开一些人的帮助：Charles Fry, Adam Zell, Gil Einziger, Roy Friedman, Kevin Bourrillion, Bob Lee, Doug Lea, Josh Bloch, Bob Lane, Nitsan Wakart, Thomas Müeller, Dominic Tootell, Louis Wasserman, and Vladimir Blagojevic. Thanks to Nitsan Wakart, Adam Zell, Roy Friedman, and Will Chu for their feedback on drafts of this article.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2018/03/15/一起因限流引发的故障/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/15/一起因限流引发的故障/" itemprop="url">一起因限流引发的故障</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-15T20:56:05+08:00">
                2018-03-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/15/一起因限流引发的故障/" class="leancloud_visitors" data-flag-title="一起因限流引发的故障">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>限流是保证系统高可用性的一项很重要的举措，但是任何事情都有利弊，限流措施如果使用不当，有可能会引起比较大的问题，反而导致系统可用性降低。</p>
<h2 id="2-详细经过"><a href="#2-详细经过" class="headerlink" title="2.详细经过"></a>2.详细经过</h2><p>上周，我们负责的一个入口系统的几台服务器突然收到大量的线程池满的告警，根据以往的经验，初步判断是上游请求量激增导致的。通过监控也印证了我们的判断，因为激增的流量比较大，为保护集群，避免出现雪崩，我们开启了限流措施。本来这是保证集群可用性的一种常见措施，但因为其中某些环节做得不够细致，导致了后面故障的发生。</p>
<p>开启了限流措施之后，我们很快就收到了另外一个监控(搜索结果为空率)的告警。此监控是反映系统返回结果为空的比例的，当这个比例超过设定的阈值就会告警。当时这个告警飙升到了40%多，这个比例是非常恐怖的，意味着接近一半的搜索没有结果了。当时我们立刻断定是限流的影响，为了保护集群，同时不影响用户体验，我们将限流阈值调高，这时搜索为空率监控开始下降。</p>
<p>5分钟后，上游系统同事反馈系统请求量在下降，我们自己的监控也有所体现，为了避免伤害用户，我们关掉了限流，于是故障恢复。</p>
<h2 id="3-故障分析"><a href="#3-故障分析" class="headerlink" title="3.故障分析"></a>3.故障分析</h2><h3 id="3-1-Hash策略不合理"><a href="#3-1-Hash策略不合理" class="headerlink" title="3.1 Hash策略不合理"></a>3.1 Hash策略不合理</h3><p>事后分析原因，发现是平台上有个代理商发布了一个错误的航线价格，这个价格非常低，导致大量的用户前来搜索和购买。由于我们的集群是根据航线+日期进行hash，导致短时间内，特定的几台机器收到了大量的请求，导致机器负载过高，最终不可用。如果能够让集群的请求分布更加均匀，那么也不会导致雪崩的风险而不得不限流。</p>
<h3 id="3-2-限流措施不合理"><a href="#3-2-限流措施不合理" class="headerlink" title="3.2 限流措施不合理"></a>3.2 限流措施不合理</h3><p>故障以前系统的限流措施是：被限流后，请求立即返回为空的结果。但这里更加合理的措施是：如果被限流，让请求在队列里面等待一会再尝试请求。这样能够达到削峰的效果，让请求更加平滑，同时也降低对用户体验的伤害。</p>
<h3 id="3-3-请求合并不合理"><a href="#3-3-请求合并不合理" class="headerlink" title="3.3 请求合并不合理"></a>3.3 请求合并不合理</h3><p>为减轻对后端系统的压力，我们系统中保留了本地缓存，这样能够针对相同的请求使用缓存，也能提高缓存的利用率。但因为系统单次请求的结果集比较大，为降低对本地缓存的占用，我们并未将最终结果进行缓存，而是缓存了初始结果，这样就意味着在利用缓存的时候，还需要在本地经过一些计算才能返回结果，这无疑增加了系统的压力。</p>
<p>所以后续我们可以做进一步优化，在一个时间片内，如果存在相同的请求，如果结果还没有计算出来，就等结果计算出来再返回；如果结果已经计算出来并在缓存中有效，直接返回结果即可。这样也能进一步降低系统的负载。</p>
<h3 id="3-4-限流粒度太粗"><a href="#3-4-限流粒度太粗" class="headerlink" title="3.4 限流粒度太粗"></a>3.4 限流粒度太粗</h3><p>故障以前系统是对所有请求进行限流，但故障时，只是某条航线收到了大量的请求，其余航线请求是正常的。开启限流之后，虽然大量的问题航线请求被限制住了，但同时也限制了正常的用户请求。所以在限流的粒度上，我们还可以做得更加细致。当然这里有个前提，就是我们需要在第一时间知道哪条航线请求量飙升，这样才能有针对性地进行限流。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>高可用是一个很大的话题，就其中的限流措施来说，也可以做得非常细致。这里只是针对本次故障做一个简单的总结，对此如果你有任何意见或建议，还望不吝赐教。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2018/02/28/服务化架构-服务的熔断/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/28/服务化架构-服务的熔断/" itemprop="url">服务化架构-服务的熔断</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-28T20:20:23+08:00">
                2018-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/02/28/服务化架构-服务的熔断/" class="leancloud_visitors" data-flag-title="服务化架构-服务的熔断">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是熔断"><a href="#什么是熔断" class="headerlink" title="什么是熔断"></a>什么是熔断</h2><p>软件行业中的很多技术都是借鉴于工业的，熔断也不例外。熔断机制类似于工厂的保险丝/盒，当电流过大时，为了保护电器不受损，将电路熔断或者跳闸，断电后人工更换保险丝或者合闸。当然，在软件系统里面的熔断机制，其实可以实现自动熔断和恢复。</p>
<h2 id="为什么要熔断"><a href="#为什么要熔断" class="headerlink" title="为什么要熔断"></a>为什么要熔断</h2><p>有人可能要问了，软件系统如果健壮性做得很好，需要熔断吗？<br>前面我们说过，熔断是针对下游的系统来说的。举个栗子，如果下游C系统出问题了，服务100%超时，这时候你可以先不去请求C了，直到C恢复再去请求。有人说我去请求了也没关系吧，反正请求和不请求都是失败，我干嘛要把事情搞复杂了？我又不知道C什么时候能恢复，权当去测试C的可用性了呗。</p>
<p>嗯，你说得有道理，不过需要每个请求都要去测试吗？当然没必要，而且很多时候下游系统的超时有可能会拖垮你的系统。纳尼？这又是为啥？</p>
<p>我们继续举例子，如果你的系统与C系统是通过同步的方式交互，那么意味着在C返回结果前，你的系统的工作线程是要阻塞在那里的，这也就会导致你的系统吞吐量的降低，毕竟线程是不能无限创建的。</p>
<h2 id="熔断的实现"><a href="#熔断的实现" class="headerlink" title="熔断的实现"></a>熔断的实现</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>熔断的实现思路很简单，简而言之就是失败率统计，如果它在一段时间内侦测到许多类似的错误，会强迫其以后的多个调用快速失败，不再访问远程服务器，从而防止应用程序不断地尝试执行可能会失败的操作，使得应用程序继续执行而不用等待修正错误，或者浪费CPU时间去等到长时间的超时产生。熔断器也可以使应用程序能够诊断错误是否已经修正，如果已经修正，应用程序会再次尝试调用操作。</p>
<h3 id="实现要点"><a href="#实现要点" class="headerlink" title="实现要点"></a>实现要点</h3><p>熔断器工作过程中，有3个状态：闭合、打开、半开。</p>
<ul>
<li><p>闭合（Closed）状态：我们需要一个调用失败的计数器，如果调用失败，则使失败次数加 1。如果最近失败次数超过了在给定时间内允许失败的阈值，则切换到断开 (Open) 状态。此时开启了一个超时时钟，当该时钟超过了该时间，则切换到半断开（Half-Open）状态。该超时时间的设定是给了系统一次机会来修正导致调用失败的错误，以回到正常工作的状态。在 Closed 状态下，错误计数器是基于时间的。在特定的时间间隔内会自动重置。这能够防止由于某次的偶然错误导致熔断器进入断开状态。也可以基于连续失败的次数。</p>
</li>
<li><p>打开 (Open) 状态：在该状态下，对应用程序的请求会立即返回错误响应，而不调用后端的服务。这样也许比较粗暴，有些时候，我们可以 cache 住上次成功请求，直接返回缓存（当然，这个缓存放在本地内存就好了），如果没有缓存再返回错误（缓存的机制最好用在全站一样的数据，而不是用在不同的用户间不同的数据，因为后者需要缓存的数据有可能会很多）。</p>
</li>
<li><p>半开（Half-Open）状态：允许应用程序一定数量的请求去调用服务。如果这些请求对服务的调用成功，那么可以认为之前导致调用失败的错误已经修正，此时熔断器切换到闭合状态 (并且将错误计数器重置)。</p>
</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/4098122-55290c8ca6729751.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt=""></p>
<p>如果这一定数量的请求有调用失败的情况，则认为导致之前调用失败的问题仍然存在，熔断器切回到断开状态，然后重置计时器来给系统一定的时间来修正错误。半断开状态能够有效防止正在恢复中的服务被突然而来的大量请求再次拖垮。</p>
<h3 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h3><p>在业界，一说到熔断器，很多人很容易就会联想到Netflix开源的<a href="https://github.com/Netflix/Hystrix" target="_blank" rel="external">Hystrix</a>。是的Hyxtrix是一个非常优秀的保证系统高可用的组件，其中的熔断、舱壁(bulkhead)实现都能够帮助我们提高系统的可用性。</p>
<h2 id="熔断的其他注意事项"><a href="#熔断的其他注意事项" class="headerlink" title="熔断的其他注意事项"></a>熔断的其他注意事项</h2><p>在实现熔断器模式的时候，以下这些因素需可能需要考虑。</p>
<ul>
<li><p>避免侵入代码：熔断器应该作为一种比较基础的服务组件存在于系统中，尽量避免对业务代码的侵入，从而提高系统的可维护性。所以通用、可配置化是熔断组件的基本要求。</p>
</li>
<li><p>状态监控：熔断器处于打开、半开状态时，应该能够在第一时间通知维护人员，让相关人员及时获知熔断器的状态，并根据其他信息决定下一步采取的措施。</p>
</li>
<li><p>日志记录：熔断器应该能够记录所有失败的请求，以及一些可能会尝试成功的请求，使得管理员能够监控使用熔断器保护的服务的执行情况。</p>
</li>
<li><p>性能考虑：熔断器的实现不应该阻塞并发的请求或者增加每次请求调用的负担。尤其是其中的对调用结果的统计，一般来说会成为一个共享的数据结构，这个会导致有锁的情况。在这种情况下，最好使用一些无锁的数据结构，或是 atomic 的原子操作。这样会带来更好的性能。</p>
</li>
<li><p>错误区分。要能够区分出正常的调用失败和熔断失败，这样能够针对不同的失败制定不同的策略。比如对于正常的调用失败，可以采取重试机制；而对于熔断失败，那么快速失败即可。</p>
</li>
<li><p>服务测试。在断开状态下，熔断器可以采用定期地 ping 一下远程的服务的健康检查接口，来判断服务是否恢复，而不是使用计时器来自动切换到半开状态。这样做的一个好处是，在服务恢复的情况下，不需要真实的用户流量就可以把状态从半开状态切回关闭状态。否则在半开状态下，即便服务已恢复了，也需要用户真实的请求来恢复，这会影响用户的真实请求。</p>
</li>
<li><p>手动重置：在系统中对于失败操作的恢复时间是很难确定的，提供一个手动重置功能能够使得管理员可以手动地强制将熔断器切换到闭合状态。同样的，如果受熔断器保护的服务暂时不可用的话，管理员能够强制将熔断器设置为断开状态。</p>
</li>
<li><p>熔断隔离：对于不同的服务，要设置不同的熔断器，使他们相互隔离，避免互相影响。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2018/02/03/服务化架构-服务的限流与熔断/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/03/服务化架构-服务的限流与熔断/" itemprop="url">服务化架构-服务的限流与熔断</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-03T20:23:23+08:00">
                2018-02-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/02/03/服务化架构-服务的限流与熔断/" class="leancloud_visitors" data-flag-title="服务化架构-服务的限流与熔断">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>服务的限流、熔断是保证系统高可用的两个非常重要的举措，但有人会把限流和熔断的概念混淆，在这里做一个简单的区分。</p>
<p>为了方便说明，我们先做一个情景设定：有3个系统，A、B、C，他们之间的调用关系是这样的：A-&gt;B-&gt;C，也就是说，A是B的上游，C是B的下游。这里针对B系统做限流、熔断的说明。</p>
<h2 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h2><p>限流是针对上游系统的请求来说的，对于B来说，如果上游A的请求量过大，那么就需要对A做限流，来保护自己不被流量冲垮。<br>关于限流，请看这篇文章：<a href="http://fengfu.io/2017/04/22/%E6%9C%8D%E5%8A%A1%E5%8C%96%E6%9E%B6%E6%9E%84-%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%99%90%E6%B5%81/">《服务的限流》</a></p>
<h2 id="熔断"><a href="#熔断" class="headerlink" title="熔断"></a>熔断</h2><p>熔断是针对下游的系统来说的。举个栗子，如果下游C系统出问题了，服务100%超时，这时候你可以先不去请求C了，直到C恢复再去请求。这种措施就叫熔断。<br>关于熔断，请看这篇文章：<a href="http://fengfu.io/2018/02/28/%E6%9C%8D%E5%8A%A1%E5%8C%96%E6%9E%B6%E6%9E%84-%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%86%94%E6%96%AD/">《服务的熔断》</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2018/01/02/StringBuilder你应该知道的几件事情/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/StringBuilder你应该知道的几件事情/" itemprop="url">StringBuilder你应该知道的几件事情</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T20:33:21+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/01/02/StringBuilder你应该知道的几件事情/" class="leancloud_visitors" data-flag-title="StringBuilder你应该知道的几件事情">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>字符串拼接是我们在编写程序时经常要写的代码，在很多的系统中，字符串相关的处理甚至占用了系统非常多的资源，尤其是内存。因此，在一些高性能的场景中，字符串拼接使用方式不合理，往往会导致无谓的内存开销，增加GC压力。</p>
<p>有些同学会直接使用”+”的方式进行字符串拼接，在Jdk7u40之前，这种方式我们是不推荐使用的，因为String是不可变对象，每次对String的”+”操作都会产生一个新的String对象，尤其是在对多个String进行拼接处理的时候，从而导致内存的浪费。但在Jdk7u40之后，-XX:+OptimizeStringConcat被默认打开，这样Jdk在进行Jit编译的时候，会自动将”+”形式的字符串拼接优化成StringBuilder append的方式。</p>
<p>但是，让编译器帮你优化这种方式你就可以高枕无忧了吗？答案是否定的，请看下面的内容。</p>
<h2 id="1-new-StringBuilder-合理吗？"><a href="#1-new-StringBuilder-合理吗？" class="headerlink" title="1.new StringBuilder()合理吗？"></a>1.new StringBuilder()合理吗？</h2><p>很多时候我们使用new StringBuilder()来初始化实例，但这种方式是否合理呢？</p>
<p>通过阅读StringBuilder的源码我们可以看到，StringBuilder的内部存储是使用char[]来实现的，char[]的初始容量是16。在进行append时，首先会检查char[]容量是否够用，如果不够，则会创建一个新的char[]，容量为原来容量的2倍，原来的char[]则会丢弃。看到这里，细心的同学可能会想了，这不是浪费了吗？是的，这就是不设置初始容量所带来的弊端，会导致一定的内存浪费。举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">String a1 = &quot;1234567890&quot;;//length 10</div><div class="line">String a2 = &quot;0123456789&quot;;//length 10</div><div class="line">String a3 = &quot;123456789&quot;;//length 9</div><div class="line">String a4 = &quot;987654321&quot;;//length 9</div><div class="line"></div><div class="line">String a5 = new StringBuilder().append(a1).append(a2).append(a3).append(a4).toString();</div></pre></td></tr></table></figure>
<p>上面这段代码的执行共创建了几个char[]呢？答案是4个，详细过程看下面的描述。</p>
<ol>
<li><p>new StringBuilder()的时候，如果我们不指定StringBuilder的容量，那么会按照默认值是16创建第一个数组，我们命名为C1。在append(a1)的时候，容量是够用的；</p>
</li>
<li><p>在append(a2)的时候，C1容量不够了需要扩容，于是创建一个容量为以前2倍的数组C2，并将旧的数组C1的内容以及a2的内容按顺序copy到新数组C2中，这时候C2的大小是32；</p>
</li>
<li><p>在append(a3)的时候，C2的容量是够用的，所以直接将a3的内容copy进C2；</p>
</li>
<li><p>在append(a4)的时候，C2的容量也不够用了，于是再创建一个容量为C2两倍的数组C3，并将旧的数组C2的内容以及a4的内容按顺序copy到新数组C3中，这时候C3的大小是64；</p>
</li>
<li><p>在toString的时候，是调用的new String(value, 0, count)。这样并不是将C3的内容直接转换成String，而是会copy出一个副本C4再根据C4创建出一个String来；这一点，建议大家仔细去看看StringBuilder的toString代码，你会发现更多的真相……</p>
</li>
</ol>
<p><img src="https://farm5.staticflickr.com/4690/39073757202_23dcf8ee35_b.jpg" alt=""></p>
<p>看完上面的描述，你会觉得这个过程中浪费了多少内存呢？最起码C1、C2是没用了的，也就是说浪费掉了48byte的空间。那如果你最初根据预估的字符串大小，设置了StringBuilder初始容量为38，那么就不会存在这样的浪费了，同时也会省去StringBuilder扩容的时间。</p>
<p>所以，在使用StringBuilder的时候，还是估算一下字符串大小，乖乖的设置一个初始容量吧。</p>
<h2 id="2-不要重复创建StringBuilder"><a href="#2-不要重复创建StringBuilder" class="headerlink" title="2.不要重复创建StringBuilder"></a>2.不要重复创建StringBuilder</h2><p>这里说的重复是指在循环中重复new StringBuilder实例。前面我们也说过，StringBuilder的扩容和toString()方法会造成大量的char[]浪费，如果你在一个循环里面创建了很多StringBuilder实例，那么可以想象浪费的内存有多大……所以在一个循环里面复用StringBuilder比较好的方式是调用StringBuilder.setLength(0)重置指针进行复用，这样最起码就能避免再次扩容的内存消耗了。</p>
<h2 id="3-StringBuilder-toString-造成的内存浪费"><a href="#3-StringBuilder-toString-造成的内存浪费" class="headerlink" title="3.StringBuilder.toString()造成的内存浪费"></a>3.StringBuilder.toString()造成的内存浪费</h2><p>前面我们也提到过，每次StringBuilder.toString的时候，会copy一个char[]生成一个String对象，这样就相当于白白浪费了StringBuilder里面的数组。当然这里可以采用一些黑科技来避免这种浪费，比如用Unsafe这种黑科技，绕过构造函数直接给String的char[]属性赋值，示例代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Unsafe unsafe =</div><div class="line">long fieldOffset = Unsafe.getUnsafe();</div><div class="line">unsafe.objectFieldOffset(String.class.getDeclaredField(&quot;value&quot;));</div><div class="line">String ret = new String();</div><div class="line"></div><div class="line">unsafe.putObjectVolatile(ret, fieldOffset, char[]);//char[]为StringBuilder中的char[]</div></pre></td></tr></table></figure></p>
<p>这种方式虽然能够避免内存浪费，但也存在一定的风险，所以使用的时候还是要慎重。</p>
<h2 id="4-StringBuilder-vs-StringBuffer"><a href="#4-StringBuilder-vs-StringBuffer" class="headerlink" title="4.StringBuilder vs StringBuffer"></a>4.StringBuilder vs StringBuffer</h2><p>StringBuffer与StringBuilder都是继承于AbstractStringBuilder，唯一的区别就是StringBuffer的函数上都有synchronized关键字。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/12/08/使用SonarLint进行代码检查/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/08/使用SonarLint进行代码检查/" itemprop="url">使用SonarLint编写高质量代码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-08T18:40:25+08:00">
                2017-12-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/12/08/使用SonarLint进行代码检查/" class="leancloud_visitors" data-flag-title="使用SonarLint编写高质量代码">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Sonarqube是一个功能非常强大的代码质量检查、管理的工具。能够识别多种常用的编程语言，并能够通过设置不同的Rule<br>Sonar是一个代码质量管理的开源工具，它通过插件的形式能够识别常见的多种编程语言（例如Java, C#, PHP, Pythod等）代码质量问题。Sonar可以帮你分析出以下代码质量问题：<br>1.不遵循代码标准；<br>2.潜在的缺陷，比如空指针、bug；<br>3.代码重复；<br>4.注释率不足或过高；<br>5.糟糕的复杂度，比如if/循环嵌套太多、类/方法太大；<br>6.缺乏单元测试；</p>
<p>在公司中，一般是把SonarQube部署在服务器端，当开发人员提交代码时，Jenkins触发SonarQube进行代码检查，开发人员根据代码检查结果进行问题修复。但是这样，开发人员往往只会关注被阻断的代码问题，对于Sonar提示的设计、性能方面的问题往往视而不见。<br>所幸现在SonarSource开发了SonarLint插件，可以在IDE(Intellij Idea、Eclipse)中嵌入，这样开发人员不仅能使用SonarLint中内置的代码检查规则进行代码检查，也可以连接到远端服务器拉取远端规则。有了它，我们就可以在编写代码的过程中根据SonarLint的提示编写高质量代码了。</p>
<p>下面，将以Intellij Idea为基础介绍SonarLint插件的使用。</p>
<h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1 安装"></a>1 安装</h2><p>在Idea的Plugins界面搜索“SonarLint”，在检索结果列表页找到对应的SonarLint，点击右侧的“Install”按钮，安装完毕重启Idea后即可完成插件的安装。</p>
<p><img src="https://farm5.staticflickr.com/4634/38195936814_d3318454b4_b.jpg" alt="安装插件"></p>
<h2 id="2-代码检查"><a href="#2-代码检查" class="headerlink" title="2 代码检查"></a>2 代码检查</h2><p>SonarLint插件安装后，就可以使用它对Idea中的项目进行代码检查了。SonarLint能够对单个文件、整个项目、从VCS（版本控制系统，比如git、svn等）拉取的被修改文件这3类进行检查。</p>
<p>开启SonarLint的检查有3个入口：</p>
<p>1.Analyze-&gt;SonarLint，如下图：</p>
<p><img src="https://farm5.staticflickr.com/4558/38195610794_c63be62dd8_b.jpg" alt=""></p>
<p>2.在打开的文件编辑区域点击右键，在弹出的上下文菜单中选择，如下图：</p>
<p><img src="https://farm5.staticflickr.com/4562/38875276892_7c0f79c2a4_z.jpg" alt=""></p>
<p>此方式只能对当前文件进行检查。</p>
<p>3.编辑区底部的Panel，这里可以在”Current file” Tab区域对当前文件进行检查，也可以在“Project files”Tab区域对文件进行全量和从VCS（版本控制系统，比如git、svn等）拉取的被修改文件进行检查，如下图：</p>
<p><img src="https://farm5.staticflickr.com/4519/38196120834_fa47b16e02_b.jpg" alt=""></p>
<p>执行代码检查后，在下面的SonarLint Panel区域就能显示代码检查的结果了：</p>
<p><img src="https://farm5.staticflickr.com/4566/38024453305_b355b33948_z.jpg" alt=""></p>
<h2 id="3-远程配置"><a href="#3-远程配置" class="headerlink" title="3 远程配置"></a>3 远程配置</h2><p>前面提到的代码检查，默认使用SonarLint内置的规则。我们也可以连接远端的SonarQube服务器，拉取服务器上配置的规则对代码进行检查，这样就能与代码提交时触发的检查规则保持一致了，具体方式如下：</p>
<p>1.首先在下图的界面点击“+”创建新的SonarQube Server：</p>
<p><img src="https://farm5.staticflickr.com/4557/38024453645_871bb2cd83.jpg" alt=""></p>
<p>2.在New SonarQube Server界面中选择右侧的选项，并输入SonarQube URL，点击next：</p>
<p><img src="https://farm5.staticflickr.com/4557/27134414809_a16b3fc406_b.jpg" alt=""></p>
<p>3.在Authentication界面选择Login/Password，并输入用户名和密码：</p>
<p><img src="https://farm5.staticflickr.com/4532/27134414729_f52684145d_b.jpg" alt=""></p>
<p>验证通过后点击Finish即可完成SonarQube Server的配置。</p>
<p>4.在SonarLint界面选择Server中配置的project，要与当前项目一致，否则可能会拉取错误的规则配置。</p>
<p><img src="https://farm5.staticflickr.com/4739/38875276722_f5b65063f0_b.jpg" alt=""></p>
<p>经过上面4步，你就可以通过SonarLint拉取的服务器上的代码规则进行代码检查了。Have fun:)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/11/29/Sonar自定义插件开发指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/29/Sonar自定义插件开发指南/" itemprop="url">Sonar自定义插件开发指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-29T17:13:16+08:00">
                2017-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/11/29/Sonar自定义插件开发指南/" class="leancloud_visitors" data-flag-title="Sonar自定义插件开发指南">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Sonar简介"><a href="#1-Sonar简介" class="headerlink" title="1 Sonar简介"></a>1 Sonar简介</h2><p>SonarQube是一个非常流行和强大的静态代码检查工具。它可以针对很多语言进行分析，比如Java、C#、JavaScript、PL/SQL等。SonarQube中默认提供了很多代码检查规则，但是有时候我们需要根据自己的需求编写规则，这篇文章会涵盖如何编写自定义规则的各个步骤。</p>
<h2 id="2-环境准备"><a href="#2-环境准备" class="headerlink" title="2 环境准备"></a>2 环境准备</h2><ul>
<li>JDK 1.8</li>
<li>Intellij Idea</li>
<li>Maven 3.x或更高</li>
<li>SonarQube LTS 5.6</li>
<li>Sonar-runner-dist 2.4</li>
</ul>
<h2 id="3-开发步骤"><a href="#3-开发步骤" class="headerlink" title="3 开发步骤"></a>3 开发步骤</h2><h3 id="3-1-创建Plugin项目"><a href="#3-1-创建Plugin项目" class="headerlink" title="3.1 创建Plugin项目"></a>3.1 创建Plugin项目</h3><p> 首先创建一个SonarPlugin项目，建议从SonarSource官方github站点下载模板项目，这样不至于遗漏配置。下载的地址是：<a href="https://github.com/SonarSource/sonar-custom-plugin-example" target="_blank" rel="external">下载链接</a></p>
<h3 id="3-2-引入Pom依赖"><a href="#3-2-引入Pom依赖" class="headerlink" title="3.2 引入Pom依赖"></a>3.2 引入Pom依赖</h3><p>将模板项目中的pom文件修改为自己项目对应的名称，比如groupId、artifactId、version、name、description，其他的不必修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;</div><div class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div class="line"></div><div class="line">    &lt;groupId&gt;com.qunar.sonar&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;qunar-java&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</div><div class="line">    &lt;packaging&gt;sonar-plugin&lt;/packaging&gt;</div><div class="line"></div><div class="line">    &lt;name&gt;Qunar SonarQube Java Rules&lt;/name&gt;</div><div class="line">    &lt;description&gt;Qunar Java Rules for SonarQube&lt;/description&gt;</div><div class="line">    &lt;inceptionYear&gt;2016&lt;/inceptionYear&gt;</div><div class="line"></div><div class="line">    &lt;properties&gt;</div><div class="line">        &lt;sonar.version&gt;6.3&lt;/sonar.version&gt; &lt;!-- this 6.3 is only required to be compliant with SonarLint and it is required</div><div class="line">			even if you just want to be compliant with SonarQube 5.6 --&gt;</div><div class="line">        &lt;java.plugin.version&gt;4.10.0.10260&lt;/java.plugin.version&gt;</div><div class="line">        &lt;sslr.version&gt;1.21&lt;/sslr.version&gt;</div><div class="line">        &lt;gson.version&gt;2.6.2&lt;/gson.version&gt;</div><div class="line">    &lt;/properties&gt;</div><div class="line"></div><div class="line">    &lt;dependencies&gt;</div><div class="line">        &lt;!--请不要调整下面三项依赖的顺序，避免查看依赖的类时无法查看源码--&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.sonarqube&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;sonar-plugin-api&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;sonar.version&#125;&lt;/version&gt;</div><div class="line">            &lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.java&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;java-frontend&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;java.plugin.version&#125;&lt;/version&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.java&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;sonar-java-plugin&lt;/artifactId&gt;</div><div class="line">            &lt;!--&lt;type&gt;sonar-plugin&lt;/type&gt;--&gt;</div><div class="line">            &lt;version&gt;$&#123;java.plugin.version&#125;&lt;/version&gt;</div><div class="line">            &lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">        &lt;!--请不要调整上述三项依赖的顺序，避免查看依赖的类时无法查看源码--&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.sslr-squid-bridge&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;sslr-squid-bridge&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;2.6.1&lt;/version&gt;</div><div class="line">            &lt;exclusions&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.codehaus.sonar.sslr&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;sslr-core&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.codehaus.sonar&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;sonar-plugin-api&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.codehaus.sonar.sslr&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;sslr-xpath&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">            &lt;/exclusions&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.java&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;java-checks-testkit&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;java.plugin.version&#125;&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;gson&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;gson.version&#125;&lt;/version&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.sslr&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;sslr-testing-harness&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;sslr.version&#125;&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;1.6.2&lt;/version&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;4.11&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.assertj&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;assertj-core&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;3.6.2&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;0.9.30&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">    &lt;/dependencies&gt;</div><div class="line"></div><div class="line">    &lt;build&gt;</div><div class="line">        &lt;plugins&gt;</div><div class="line">            &lt;plugin&gt;</div><div class="line">                &lt;groupId&gt;org.sonarsource.sonar-packaging-maven-plugin&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;sonar-packaging-maven-plugin&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;1.17&lt;/version&gt;</div><div class="line">                &lt;extensions&gt;true&lt;/extensions&gt;</div><div class="line">                &lt;configuration&gt;</div><div class="line">                    &lt;pluginKey&gt;qunar-java&lt;/pluginKey&gt;</div><div class="line">                    &lt;pluginName&gt;QunarJava&lt;/pluginName&gt;</div><div class="line">                    &lt;pluginClass&gt;com.qunar.sonar.java.JavaRulesPlugin&lt;/pluginClass&gt;</div><div class="line">                    &lt;sonarLintSupported&gt;true&lt;/sonarLintSupported&gt;</div><div class="line">                    &lt;sonarQubeMinVersion&gt;5.6&lt;/sonarQubeMinVersion&gt; &lt;!-- allow to depend on API 6.x but run on LTS --&gt;</div><div class="line">                &lt;/configuration&gt;</div><div class="line">            &lt;/plugin&gt;</div><div class="line"></div><div class="line">            &lt;plugin&gt;</div><div class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;3.6.0&lt;/version&gt;</div><div class="line">                &lt;configuration&gt;</div><div class="line">                    &lt;source&gt;1.8&lt;/source&gt;</div><div class="line">                    &lt;target&gt;1.8&lt;/target&gt;</div><div class="line">                &lt;/configuration&gt;</div><div class="line">            &lt;/plugin&gt;</div><div class="line"></div><div class="line">            &lt;!-- only required to run UT - these are UT dependencies --&gt;</div><div class="line">            &lt;plugin&gt;</div><div class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;2.10&lt;/version&gt;</div><div class="line">                &lt;executions&gt;</div><div class="line">                    &lt;execution&gt;</div><div class="line">                        &lt;id&gt;copy&lt;/id&gt;</div><div class="line">                        &lt;phase&gt;test-compile&lt;/phase&gt;</div><div class="line">                        &lt;goals&gt;</div><div class="line">                            &lt;goal&gt;copy&lt;/goal&gt;</div><div class="line">                        &lt;/goals&gt;</div><div class="line">                        &lt;configuration&gt;</div><div class="line">                            &lt;artifactItems&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.0&lt;/version&gt;</div><div class="line">                                    &lt;type&gt;jar&lt;/type&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;javax&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;javaee-api&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;6.0&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.3.3.RELEASE&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.3.3.RELEASE&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;spring-web&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.3.3.RELEASE&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.3.3.RELEASE&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                            &lt;/artifactItems&gt;</div><div class="line">                            &lt;outputDirectory&gt;$&#123;project.build.directory&#125;/test-jars&lt;/outputDirectory&gt;</div><div class="line">                        &lt;/configuration&gt;</div><div class="line">                    &lt;/execution&gt;</div><div class="line">                &lt;/executions&gt;</div><div class="line">            &lt;/plugin&gt;</div><div class="line">        &lt;/plugins&gt;</div><div class="line">    &lt;/build&gt;</div><div class="line"></div><div class="line">&lt;/project&gt;</div></pre></td></tr></table></figure>
<h3 id="3-3-编写具体的Rule"><a href="#3-3-编写具体的Rule" class="headerlink" title="3.3 编写具体的Rule"></a>3.3 编写具体的Rule</h3><p>一个自定义规则的实现，首先在规则类前面使用@Rule注解声明规则的相关信息，比如key、name、description、priority、tag。其次要继承IssuableSubscriptionVisitor或者继承BaseTreeVisitor并实现JavaFileScanner接口，这两种实现方式存在一些差异，IssuableSubscriptionVisitor是一个抽象类，继承自SubscriptionVisitor，而SubscriptionVisitor则实现了JavaFileScanner接口；而BaseTreeVisitor则是实现了TreeVisitor接口。相比来说，JavaFileScanner更偏底层一些，直接是面向Java文件的分析，而TreeVisitor则是针对于Java文件的语法结构了，比如类、防止、赋值语句、catch块之类的了。一般情况下，推荐使用继承IssuableSubscriptionVisitor的方式，因为这个类的封装层次更高，更简便。在规则类中，你只需要重载nodesToVisit和visitNode方法就可以了。<br>nodesToVisit方法是说明该规则做检查的类型集合，比如METHOD_INVOCATION（方法调用）、CATCH（catch块）、MEMBER_SELECT（属性选择）等。比如下面的代码，就是对源码中的方法调用做规则检查。<br>visitNode是自定义规则中的核心部分，你所要实现的代码检查逻辑就是在这个方法中完成的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">import com.google.common.collect.ImmutableList;</div><div class="line">import com.qunar.sonar.java.util.QualifiedNameUtil;</div><div class="line">import org.sonar.check.Priority;</div><div class="line">import org.sonar.check.Rule;</div><div class="line">import org.sonar.plugins.java.api.IssuableSubscriptionVisitor;</div><div class="line">import org.sonar.plugins.java.api.tree.MethodInvocationTree;</div><div class="line">import org.sonar.plugins.java.api.tree.Tree;</div><div class="line"></div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by fengfu on 2017/11/10.</div><div class="line"> */</div><div class="line">@Rule(</div><div class="line">        key = &quot;DisallowedFDUsageCheck&quot;,</div><div class="line">        name = &quot;Qunar Flight disallowed FD usage in InfoCenter check&quot;,</div><div class="line">        description = &quot;Some kinds of usage for FD are forbidden in Flight BU of Qunar.com.&quot;,</div><div class="line">        priority = Priority.BLOCKER,</div><div class="line">        tags = &#123;&quot;bug&quot;&#125;</div><div class="line">)</div><div class="line">public class DisallowedFDUsageCheck extends IssuableSubscriptionVisitor &#123;</div><div class="line">    private static final String[] FORBIDDEN_METHODS = &#123;</div><div class="line">            &quot;Infocenter.reloadFDData&quot;, &quot;Infocenter.getFliterDateFDData&quot;,</div><div class="line">            &quot;Infocenter.getFDData&quot;, &quot;Infocenter.getValidFDPrice&quot;,</div><div class="line">            &quot;Infocenter.getFDPrice&quot;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public List&lt;Tree.Kind&gt; nodesToVisit() &#123;</div><div class="line">        return ImmutableList.of(Tree.Kind.METHOD_INVOCATION);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void visitNode(Tree tree) &#123;</div><div class="line">        MethodInvocationTree mTree = (MethodInvocationTree)tree;</div><div class="line">        String methodName = QualifiedNameUtil.fullQualifiedName(mTree.methodSelect());</div><div class="line"></div><div class="line">        if (isForbiddenMethod(methodName))&#123;</div><div class="line">            reportIssue(tree, methodName + &quot;已被禁用，详情请查看Wiki:http://wiki.corp.qunar.com/confluence/pages/viewpage.action?pageId=182623492&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        super.visitNode(tree);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static boolean isForbiddenMethod(String methodName) &#123;</div><div class="line">        for (String name : FORBIDDEN_METHODS) &#123;</div><div class="line">            if (name.equals(methodName)) &#123;</div><div class="line">                return true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void leaveNode(Tree tree) &#123;</div><div class="line">        super.leaveNode(tree);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然如果一些复杂的业务规则，可能你不得不实现JavaFileScanner接口了。如下面的代码所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">import com.qunar.sonar.java.util.QualifiedNameUtil;</div><div class="line">import org.sonar.api.utils.log.Logger;</div><div class="line">import org.sonar.api.utils.log.Loggers;</div><div class="line">import org.sonar.check.Priority;</div><div class="line">import org.sonar.check.Rule;</div><div class="line">import org.sonar.plugins.java.api.JavaFileScanner;</div><div class="line">import org.sonar.plugins.java.api.JavaFileScannerContext;</div><div class="line">import org.sonar.plugins.java.api.tree.*;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by fengfu on 2017/2/27.</div><div class="line"> */</div><div class="line">@Rule(</div><div class="line">        key = &quot;QunarFlightDisallowedClassCheck&quot;,</div><div class="line">        name = &quot;Qunar Flight disallowed class check&quot;,</div><div class="line">        description = &quot;Some classes are forbidden in Flight BU of Qunar.com.&quot;,</div><div class="line">        priority = Priority.BLOCKER,</div><div class="line">        tags = &#123;&quot;bug&quot;&#125;</div><div class="line">)</div><div class="line">public class DisallowedClassCheck extends BaseTreeVisitor implements JavaFileScanner &#123;</div><div class="line">    private static Logger logger = Loggers.get(DisallowedClassCheck.class);</div><div class="line">    private final String IMPORT_NAME = &quot;com.qunar.base.meerkat.monitor.QMonitor&quot;;</div><div class="line"></div><div class="line">    public void scanFile(JavaFileScannerContext context) &#123;</div><div class="line">        logger.info(&quot;Start to scan file &#123;&#125;&quot;, context.getFile().getName());</div><div class="line">        CompilationUnitTree cut = context.getTree();</div><div class="line"></div><div class="line">        for (ImportClauseTree importClauseTree : cut.imports())&#123;</div><div class="line">            ImportTree importTree = null;</div><div class="line">            if (importClauseTree.is(Tree.Kind.IMPORT)) &#123;</div><div class="line">                importTree = (ImportTree) importClauseTree;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (importTree == null || importTree.isStatic()) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            String importName = QualifiedNameUtil.fullQualifiedName(importTree.qualifiedIdentifier());</div><div class="line"></div><div class="line">            if (IMPORT_NAME.equals(importName))&#123;</div><div class="line">                logger.error(&quot;Disallowed class &#123;&#125; found.&quot;, IMPORT_NAME);</div><div class="line">                context.reportIssue(this, importTree, IMPORT_NAME + &quot;已被禁用.&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        scan(cut);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-4-单元测试"><a href="#3-4-单元测试" class="headerlink" title="3.4 单元测试"></a>3.4 单元测试</h3><p>规则检查代码写完之后，就可以针对这个规则进行单元测试了。单元测试的方法比较简单，就是使用JUnit框架编写test case，针对特定的目标文件，调用Sonar提供的JavaCheckVerifier.verify方法进行测试，示例代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import com.qunar.flight.sonar.java.checks.DisallowedClassCheck;</div><div class="line">import org.junit.Test;</div><div class="line">import org.sonar.java.checks.verifier.JavaCheckVerifier;</div><div class="line"></div><div class="line">public class DisallowedClassCheckTest &#123;</div><div class="line">    @Test</div><div class="line">    public void test() &#123;</div><div class="line">        JavaCheckVerifier.verify(&quot;src/test/files/flight/DisallowedClassCase.java&quot;, new DisallowedClassCheck());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果目标文件存在问题，那么控制台会打印出问题在目标文件中的位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">java.lang.AssertionError: Unexpected at [4]</div><div class="line"></div><div class="line">	at org.sonar.java.checks.verifier.CheckVerifier.assertMultipleIssue(CheckVerifier.java:209)</div><div class="line">	at org.sonar.java.checks.verifier.CheckVerifier.checkIssues(CheckVerifier.java:181)</div><div class="line">	at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:274)</div><div class="line">	at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:256)</div><div class="line">	at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:222)</div><div class="line">	at org.sonar.java.checks.verifier.JavaCheckVerifier.verify(JavaCheckVerifier.java:105)</div><div class="line">	at com.qunar.flight.sonar.java.checks.test.DisallowedClassCheckTest.test(DisallowedClassCheckTest.java:10)</div></pre></td></tr></table></figure></p>
<p>如果目标文件中不存在任何问题，会提示“java.lang.IllegalStateException: At least one issue expected”，意思就是目标文件中需要至少存在一个规则所要检查的问题。</p>
<h3 id="3-5-编写RulesList"><a href="#3-5-编写RulesList" class="headerlink" title="3.5 编写RulesList"></a>3.5 编写RulesList</h3><p>单元测试完成之后，就可以往RuleList的集合中中添加自定义规则规则了。这个RuleList只是一个简单的集合类，包含了所有你需要注册到Sonar中的规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">import com.google.common.collect.ImmutableList;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">import com.qunar.flight.sonar.java.checks.DisallowedClassCheck;</div><div class="line">import com.qunar.flight.sonar.java.checks.DisallowedFDUsageCheck;</div><div class="line">import com.qunar.flight.sonar.java.checks.GuavaCacheLoaderReturnNullCheck;</div><div class="line">import org.sonar.plugins.java.api.JavaCheck;</div><div class="line"></div><div class="line">public final class RulesList &#123;</div><div class="line"></div><div class="line">  private RulesList() &#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public static List&lt;Class&gt; getChecks() &#123;</div><div class="line">    return ImmutableList.&lt;Class&gt;builder().addAll(getJavaChecks()).addAll(getJavaTestChecks()).build();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 在此方法中添加需要注册的规则</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">  public static List&lt;Class&lt;? extends JavaCheck&gt;&gt; getJavaChecks() &#123;</div><div class="line">    return ImmutableList.&lt;Class&lt;? extends JavaCheck&gt;&gt;builder()</div><div class="line">      .add(DisallowedClassCheck.class)</div><div class="line">      .add(GuavaCacheLoaderReturnNullCheck.class)</div><div class="line">      .add(DisallowedFDUsageCheck.class)</div><div class="line"></div><div class="line">      .build();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public static List&lt;Class&lt;? extends JavaCheck&gt;&gt; getJavaTestChecks() &#123;</div><div class="line">    return ImmutableList.&lt;Class&lt;? extends JavaCheck&gt;&gt;builder()</div><div class="line">      .build();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-6-编写CustomRulesDefinition"><a href="#3-6-编写CustomRulesDefinition" class="headerlink" title="3.6 编写CustomRulesDefinition"></a>3.6 编写CustomRulesDefinition</h3><p>CustomRulesDefinition可以理解为自定义规则集的元数据，在这个类中，首先要声明自定义规则集的repository，另外还需要将相应的规则集加入到前面声明的repository中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line">mport com.google.common.annotations.VisibleForTesting;</div><div class="line">import com.google.common.collect.Iterables;</div><div class="line">import com.google.common.io.Resources;</div><div class="line">import com.google.gson.Gson;</div><div class="line">import org.apache.commons.lang.StringUtils;</div><div class="line">import org.sonar.api.rule.RuleStatus;</div><div class="line">import org.sonar.api.rules.RuleType;</div><div class="line">import org.sonar.api.server.debt.DebtRemediationFunction;</div><div class="line">import org.sonar.api.server.rule.RulesDefinition;</div><div class="line">import org.sonar.api.server.rule.RulesDefinitionAnnotationLoader;</div><div class="line">import org.sonar.api.utils.AnnotationUtils;</div><div class="line">import org.sonar.check.Cardinality;</div><div class="line">import org.sonar.squidbridge.annotations.RuleTemplate;</div><div class="line"></div><div class="line">import javax.annotation.Nullable;</div><div class="line">import java.io.IOException;</div><div class="line">import java.net.URL;</div><div class="line">import java.nio.charset.StandardCharsets;</div><div class="line">import org.sonar.plugins.java.Java;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Locale;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Declare rule metadata in server repository of rules.</div><div class="line"> * That allows to list the rules in the page &quot;Rules&quot;.</div><div class="line"> */</div><div class="line">public class JavaRulesDefinition implements RulesDefinition &#123;</div><div class="line"></div><div class="line">    // don&apos;t change that because the path is hard coded in CheckVerifier</div><div class="line">    private static final String RESOURCE_BASE_PATH = &quot;/org/sonar/l10n/java/rules/squid&quot;;</div><div class="line"></div><div class="line">    public static final String REPOSITORY_KEY = &quot;qunar-java&quot;;</div><div class="line"></div><div class="line">    private final Gson gson = new Gson();</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void define(Context context) &#123;</div><div class="line">        NewRepository repository = context</div><div class="line">                .createRepository(REPOSITORY_KEY, Java.KEY)//定义Repository key</div><div class="line">                .setName(&quot;QunarJava&quot;);//定义Repository名称</div><div class="line"></div><div class="line">        List&lt;Class&gt; checks = RulesList.getChecks();//获取自定义的check列表</div><div class="line">        new RulesDefinitionAnnotationLoader().load(repository, Iterables.toArray(checks, Class.class));//获取注解信息</div><div class="line"></div><div class="line">        for (Class ruleClass : checks) &#123;</div><div class="line">            newRule(ruleClass, repository);//将规则添加到Repository中</div><div class="line">        &#125;</div><div class="line">        repository.done();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @VisibleForTesting</div><div class="line">    protected void newRule(Class&lt;?&gt; ruleClass, NewRepository repository) &#123;</div><div class="line"></div><div class="line">        org.sonar.check.Rule ruleAnnotation = AnnotationUtils.getAnnotation(ruleClass, org.sonar.check.Rule.class);</div><div class="line">        if (ruleAnnotation == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;No Rule annotation was found on &quot; + ruleClass);</div><div class="line">        &#125;</div><div class="line">        String ruleKey = ruleAnnotation.key();</div><div class="line">        if (StringUtils.isEmpty(ruleKey)) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;No key is defined in Rule annotation of &quot; + ruleClass);</div><div class="line">        &#125;</div><div class="line">        NewRule rule = repository.rule(ruleKey);</div><div class="line">        if (rule == null) &#123;</div><div class="line">            throw new IllegalStateException(&quot;No rule was created for &quot; + ruleClass + &quot; in &quot; + repository.key());</div><div class="line">        &#125;</div><div class="line">        ruleMetadata(ruleClass, rule);</div><div class="line"></div><div class="line">        rule.setTemplate(AnnotationUtils.getAnnotation(ruleClass, RuleTemplate.class) != null);</div><div class="line">        if (ruleAnnotation.cardinality() == Cardinality.MULTIPLE) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;Cardinality is not supported, use the RuleTemplate annotation instead for &quot; + ruleClass);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private String ruleMetadata(Class&lt;?&gt; ruleClass, NewRule rule) &#123;</div><div class="line">        String metadataKey = rule.key();</div><div class="line">        org.sonar.java.RspecKey rspecKeyAnnotation = AnnotationUtils.getAnnotation(ruleClass, org.sonar.java.RspecKey.class);</div><div class="line">        if (rspecKeyAnnotation != null) &#123;</div><div class="line">            metadataKey = rspecKeyAnnotation.value();</div><div class="line">            rule.setInternalKey(metadataKey);</div><div class="line">        &#125;</div><div class="line">        addHtmlDescription(rule, metadataKey);</div><div class="line">        addMetadata(rule, metadataKey);</div><div class="line">        return metadataKey;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void addMetadata(NewRule rule, String metadataKey) &#123;</div><div class="line">        URL resource = JavaRulesDefinition.class.getResource(RESOURCE_BASE_PATH + &quot;/&quot; + metadataKey + &quot;_java.json&quot;);</div><div class="line">        if (resource != null) &#123;</div><div class="line">            RuleMetatada metatada = gson.fromJson(readResource(resource), RuleMetatada.class);</div><div class="line">            rule.setSeverity(metatada.defaultSeverity.toUpperCase(Locale.US));</div><div class="line">            rule.setName(metatada.title);</div><div class="line">            rule.addTags(metatada.tags);</div><div class="line">            rule.setType(RuleType.valueOf(metatada.type));</div><div class="line">            rule.setStatus(RuleStatus.valueOf(metatada.status.toUpperCase(Locale.US)));</div><div class="line">            if (metatada.remediation != null) &#123;</div><div class="line">                rule.setDebtRemediationFunction(metatada.remediation.remediationFunction(rule.debtRemediationFunctions()));</div><div class="line">                rule.setGapDescription(metatada.remediation.linearDesc);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static void addHtmlDescription(NewRule rule, String metadataKey) &#123;</div><div class="line">        URL resource = JavaRulesDefinition.class.getResource(RESOURCE_BASE_PATH + &quot;/&quot; + metadataKey + &quot;_java.html&quot;);</div><div class="line">        if (resource != null) &#123;</div><div class="line">            rule.setHtmlDescription(readResource(resource));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static String readResource(URL resource) &#123;</div><div class="line">        try &#123;</div><div class="line">            return Resources.toString(resource, StandardCharsets.UTF_8);</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            throw new IllegalStateException(&quot;Failed to read: &quot; + resource, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static class RuleMetatada &#123;</div><div class="line">        String title;</div><div class="line">        String status;</div><div class="line">        @Nullable</div><div class="line">        Remediation remediation;</div><div class="line"></div><div class="line">        String type;</div><div class="line">        String[] tags;</div><div class="line">        String defaultSeverity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static class Remediation &#123;</div><div class="line">        String func;</div><div class="line">        String constantCost;</div><div class="line">        String linearDesc;</div><div class="line">        String linearOffset;</div><div class="line">        String linearFactor;</div><div class="line"></div><div class="line">        public DebtRemediationFunction remediationFunction(DebtRemediationFunctions drf) &#123;</div><div class="line">            if (func.startsWith(&quot;Constant&quot;)) &#123;</div><div class="line">                return drf.constantPerIssue(constantCost.replace(&quot;mn&quot;, &quot;min&quot;));</div><div class="line">            &#125;</div><div class="line">            if (&quot;Linear&quot;.equals(func)) &#123;</div><div class="line">                return drf.linear(linearFactor.replace(&quot;mn&quot;, &quot;min&quot;));</div><div class="line">            &#125;</div><div class="line">            return drf.linearWithOffset(linearFactor.replace(&quot;mn&quot;, &quot;min&quot;), linearOffset.replace(&quot;mn&quot;, &quot;min&quot;));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-7-编写CustomJavaFileCheckRegistrar"><a href="#3-7-编写CustomJavaFileCheckRegistrar" class="headerlink" title="3.7 编写CustomJavaFileCheckRegistrar"></a>3.7 编写CustomJavaFileCheckRegistrar</h3><p>CustomJavaFileCheckRegistrar要实现CheckRegistrar接口。CustomJavaFileCheckRegistrar类的作用是注册代码扫描时需要的规则类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">import java.util.List;</div><div class="line">import org.sonar.plugins.java.api.CheckRegistrar;</div><div class="line">import org.sonar.plugins.java.api.JavaCheck;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Provide the &quot;checks&quot; (implementations of rules) classes that are going be executed during</div><div class="line"> * source code analysis.</div><div class="line"> *</div><div class="line"> * This class is a batch extension by implementing the &#123;@link org.sonar.plugins.java.api.CheckRegistrar&#125; interface.</div><div class="line"> */</div><div class="line">public class JavaFileCheckRegistrar implements CheckRegistrar &#123;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Register the classes that will be used to instantiate checks during analysis.</div><div class="line">   */</div><div class="line">  @Override</div><div class="line">  public void register(RegistrarContext registrarContext) &#123;</div><div class="line">    // Call to registerClassesForRepository to associate the classes with the correct repository key</div><div class="line">    registrarContext.registerClassesForRepository(JavaRulesDefinition.REPOSITORY_KEY, checkClasses(), testCheckClasses());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Lists all the main checks provided by the plugin</div><div class="line">   */</div><div class="line">  public static List&lt;Class&lt;? extends JavaCheck&gt;&gt; checkClasses() &#123;</div><div class="line">    return RulesList.getJavaChecks();//返回RulesList中定义的checks</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Lists all the test checks provided by the plugin</div><div class="line">   */</div><div class="line">  public static List&lt;Class&lt;? extends JavaCheck&gt;&gt; testCheckClasses() &#123;</div><div class="line">    return RulesList.getJavaTestChecks();//返回RulesList中定义的check classes</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-8-编写CustomJavaRulesPlugin"><a href="#3-8-编写CustomJavaRulesPlugin" class="headerlink" title="3.8 编写CustomJavaRulesPlugin"></a>3.8 编写CustomJavaRulesPlugin</h3><p>这个类是Sonar插件的入口，它继承了org.sonar.api.SonarPlugin类，包含了SonarQube启动时需要实例化的server扩展（CustomRulesDefinition）和代码分析时需要实例化的批量扩展（JavaFileCheckRegistrar）。</p>
<p>这个类基本不需要修改（除包名外），按照以下内容copy一份即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">import org.sonar.api.Plugin;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Entry point of your plugin containing your custom rules</div><div class="line"> */</div><div class="line">public class JavaRulesPlugin implements Plugin &#123;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public void define(Context context) &#123;</div><div class="line"></div><div class="line">    // server extensions -&gt; objects are instantiated during server startup</div><div class="line">    context.addExtension(CustomRulesDefinition.class);</div><div class="line"></div><div class="line">    // batch extensions -&gt; objects are instantiated during code analysis</div><div class="line">    context.addExtension(CustomJavaFileCheckRegistrar.class);</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，一个Sonar自定义插件所需的代码工作就结束了。剩下的就是进行整合性的测试，毕竟单元测试通过不代表插件不会对现有系统造成影响，有时候插件中的错误会导致SonarQube启动失败的。</p>
<h2 id="5-整合测试"><a href="#5-整合测试" class="headerlink" title="5 整合测试"></a>5 整合测试</h2><p>通过mvn package命令编译、打包，形成jar文件。将jar文件上传到SonarQube extensions/plugins目录下，重启SonarQube服务即可完成Sonar自定义规则插件的部署。部署结束，通过SonarQube bin目录下的脚本重启SonarQube，如果SonarQube启动成功，说明插件没问题，整合测试成功，你可以在sonar的rules模块中，搜索到自定义的规则了。</p>
<p><img src="https://farm5.staticflickr.com/4566/38001442235_a562e60306.jpg" alt=""></p>
<h2 id="6-启用规则"><a href="#6-启用规则" class="headerlink" title="6 启用规则"></a>6 启用规则</h2><p>插件部署到SonarQube之后，默认是不启用的，需要在SonarQube的管理界面中启用规则，才能让此规则在代码检查过程中生效。</p>
<p><img src="https://farm5.staticflickr.com/4524/38888239671_35af64c4bf.jpg" alt=""></p>
<p>至此，Sonar插件开发的流程就介绍完了。如前面所言，SonarQube是个强大的代码检查工具，一篇文章是无法介绍完的，尤其Sonar的语法树部分，涵盖了各种语言各种语法的方方面面，大家可以通过Sonar的<a href="https://docs.sonarqube.org/display/SONAR/" target="_blank" rel="external">官方文档</a>了解更多的细节。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/11/14/git命令大全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/14/git命令大全/" itemprop="url">git命令大全</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-14T16:58:24+08:00">
                2017-11-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/11/14/git命令大全/" class="leancloud_visitors" data-flag-title="git命令大全">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">git init</td>
<td style="text-align:left">初始化本地git仓库（创建新仓库）</td>
</tr>
<tr>
<td style="text-align:left">git config –global user.name “xxx”</td>
<td style="text-align:left">配置用户名</td>
</tr>
<tr>
<td style="text-align:left">git config –global user.email “xxx@xxx.com”</td>
<td style="text-align:left">配置邮件</td>
</tr>
<tr>
<td style="text-align:left">git config –global color.ui true</td>
<td style="text-align:left">git status等命令自动着色</td>
</tr>
<tr>
<td style="text-align:left">git config –global color.status auto</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git config –global color.diff auto</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git config –global color.branch auto</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git config –global color.interactive auto</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git config –global –unset http.proxy</td>
<td style="text-align:left">remove  proxy configuration on git</td>
</tr>
<tr>
<td style="text-align:left">git clone git+ssh://git@192.168.53.168/VT.</td>
<td style="text-align:left">clone远程仓库</td>
</tr>
<tr>
<td style="text-align:left">git status</td>
<td style="text-align:left">查看当前版本状态（是否修改）</td>
</tr>
<tr>
<td style="text-align:left">git add xyz</td>
<td style="text-align:left">添加xyz文件至index</td>
</tr>
<tr>
<td style="text-align:left">git add .</td>
<td style="text-align:left">增加当前子目录下所有更改过的文件至index</td>
</tr>
<tr>
<td style="text-align:left">git commit -m ‘xxx’</td>
<td style="text-align:left">提交</td>
</tr>
<tr>
<td style="text-align:left">git commit –amend -m ‘xxx’</td>
<td style="text-align:left">合并上一次提交（用于反复修改）</td>
</tr>
<tr>
<td style="text-align:left">git commit -am ‘xxx’</td>
<td style="text-align:left">将add和commit合为一步</td>
</tr>
<tr>
<td style="text-align:left">git rm xxx</td>
<td style="text-align:left">删除index中的文件</td>
</tr>
<tr>
<td style="text-align:left">git rm -r *</td>
<td style="text-align:left">递归删除</td>
</tr>
<tr>
<td style="text-align:left">git log</td>
<td style="text-align:left">显示提交日志</td>
</tr>
<tr>
<td style="text-align:left">git log -1</td>
<td style="text-align:left">显示1行日志 -n为n行</td>
</tr>
<tr>
<td style="text-align:left">git log -5</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git log –stat</td>
<td style="text-align:left">显示提交日志及相关变动文件</td>
</tr>
<tr>
<td style="text-align:left">git log -p -m</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git show dfb02e6e4f2f7b573337763e5c0013802e392818</td>
<td style="text-align:left">显示某个提交的详细内容</td>
</tr>
<tr>
<td style="text-align:left">git show dfb02</td>
<td style="text-align:left">可只用commitid的前几位</td>
</tr>
<tr>
<td style="text-align:left">git show HEAD</td>
<td style="text-align:left">显示HEAD提交日志</td>
</tr>
<tr>
<td style="text-align:left">git show HEAD^</td>
<td style="text-align:left">显示HEAD的父（上一个版本）的提交日志 ^^为上两个版本 ^5为上5个版本</td>
</tr>
<tr>
<td style="text-align:left">git tag</td>
<td style="text-align:left">显示已存在的tag</td>
</tr>
<tr>
<td style="text-align:left">git tag -a v2.0 -m ‘xxx’</td>
<td style="text-align:left">增加v2.0的tag</td>
</tr>
<tr>
<td style="text-align:left">git show v2.0</td>
<td style="text-align:left">显示v2.0的日志及详细内容</td>
</tr>
<tr>
<td style="text-align:left">git log v2.0</td>
<td style="text-align:left">显示v2.0的日志</td>
</tr>
<tr>
<td style="text-align:left">git diff</td>
<td style="text-align:left">显示所有未添加至index的变更</td>
</tr>
<tr>
<td style="text-align:left">git diff –cached</td>
<td style="text-align:left">显示所有已添加index但还未commit的变更</td>
</tr>
<tr>
<td style="text-align:left">git diff HEAD^</td>
<td style="text-align:left">比较与上一个版本的差异</td>
</tr>
<tr>
<td style="text-align:left">git diff HEAD – ./lib</td>
<td style="text-align:left">比较与HEAD版本lib目录的差异</td>
</tr>
<tr>
<td style="text-align:left">git diff origin/master..master</td>
<td style="text-align:left">比较远程分支master上有本地分支master上没有的</td>
</tr>
<tr>
<td style="text-align:left">git diff origin/master..master –stat</td>
<td style="text-align:left">只显示差异的文件，不显示具体内容</td>
</tr>
<tr>
<td style="text-align:left">git remote add origin git+ssh://git@192.168.53.168/VT.</td>
<td style="text-align:left">增加远程定义（用于push/pull/fetch）</td>
</tr>
<tr>
<td style="text-align:left">git branch</td>
<td style="text-align:left">显示本地分支</td>
</tr>
<tr>
<td style="text-align:left">git branch –contains 50089</td>
<td style="text-align:left">显示包含提交50089的分支</td>
</tr>
<tr>
<td style="text-align:left">git branch -a</td>
<td style="text-align:left">显示所有分支</td>
</tr>
<tr>
<td style="text-align:left">git branch -r</td>
<td style="text-align:left">显示所有原创分支</td>
</tr>
<tr>
<td style="text-align:left">git branch –merged</td>
<td style="text-align:left">显示所有已合并到当前分支的分支</td>
</tr>
<tr>
<td style="text-align:left">git branch –no-merged</td>
<td style="text-align:left">显示所有未合并到当前分支的分支</td>
</tr>
<tr>
<td style="text-align:left">git branch -m master master_copy</td>
<td style="text-align:left">本地分支改名</td>
</tr>
<tr>
<td style="text-align:left">git checkout -b master_copy</td>
<td style="text-align:left">从当前分支创建新分支master_copy并检出</td>
</tr>
<tr>
<td style="text-align:left">git checkout -b master master_copy</td>
<td style="text-align:left">上面的完整版</td>
</tr>
<tr>
<td style="text-align:left">git checkout features/performance</td>
<td style="text-align:left">检出已存在的features/performance分支</td>
</tr>
<tr>
<td style="text-align:left">git checkout –track hotfixes/BJVEP933</td>
<td style="text-align:left">检出远程分支hotfixes/BJVEP933并创建本地跟踪分支</td>
</tr>
<tr>
<td style="text-align:left">git checkout v2.0</td>
<td style="text-align:left">检出版本v2.0</td>
</tr>
<tr>
<td style="text-align:left">git checkout -b devel origin/develop</td>
<td style="text-align:left">从远程分支develop创建新本地分支devel并检出</td>
</tr>
<tr>
<td style="text-align:left">git checkout – README</td>
<td style="text-align:left">检出head版本的README文件（可用于修改错误回退）</td>
</tr>
<tr>
<td style="text-align:left">git merge origin/master</td>
<td style="text-align:left">合并远程master分支至当前分支</td>
</tr>
<tr>
<td style="text-align:left">git cherry-pick ff44785404a8e</td>
<td style="text-align:left">合并提交ff44785404a8e的修改</td>
</tr>
<tr>
<td style="text-align:left">git push origin master</td>
<td style="text-align:left">将当前分支push到远程master分支</td>
</tr>
<tr>
<td style="text-align:left">git push origin :hotfixes/BJVEP933</td>
<td style="text-align:left">删除远程仓库的hotfixes/BJVEP933分支</td>
</tr>
<tr>
<td style="text-align:left">git push –tags</td>
<td style="text-align:left">把所有tag推送到远程仓库</td>
</tr>
<tr>
<td style="text-align:left">git fetch</td>
<td style="text-align:left">获取所有远程分支（不更新本地分支，另需merge）</td>
</tr>
<tr>
<td style="text-align:left">git fetch –prune</td>
<td style="text-align:left">获取所有原创分支并清除服务器上已删掉的分支</td>
</tr>
<tr>
<td style="text-align:left">git pull origin master</td>
<td style="text-align:left">获取远程分支master并merge到当前分支</td>
</tr>
<tr>
<td style="text-align:left">git mv README README2</td>
<td style="text-align:left">重命名文件README为README2</td>
</tr>
<tr>
<td style="text-align:left">git reset –hard HEAD</td>
<td style="text-align:left">将当前版本重置为HEAD（通常用于merge失败回退）</td>
</tr>
<tr>
<td style="text-align:left">git rebase</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git branch -d hotfixes/BJVEP933</td>
<td style="text-align:left">删除分支hotfixes/BJVEP933（本分支修改已合并到其他分支）</td>
</tr>
<tr>
<td style="text-align:left">git branch -D hotfixes/BJVEP933</td>
<td style="text-align:left">强制删除分支hotfixes/BJVEP933</td>
</tr>
<tr>
<td style="text-align:left">git ls-files</td>
<td style="text-align:left">列出git index包含的文件</td>
</tr>
<tr>
<td style="text-align:left">git show-branch</td>
<td style="text-align:left">图示当前分支历史</td>
</tr>
<tr>
<td style="text-align:left">git show-branch –all</td>
<td style="text-align:left">图示所有分支历史</td>
</tr>
<tr>
<td style="text-align:left">git whatchanged</td>
<td style="text-align:left">显示提交历史对应的文件修改</td>
</tr>
<tr>
<td style="text-align:left">git revert dfb02e6e4f2f7b573337763e5c0013802e392818</td>
<td style="text-align:left">撤销提交dfb02e6e4f2f7b573337763e5c0013802e392818</td>
</tr>
<tr>
<td style="text-align:left">git ls-tree HEAD</td>
<td style="text-align:left">内部命令：显示某个git对象</td>
</tr>
<tr>
<td style="text-align:left">git rev-parse v2.0</td>
<td style="text-align:left">内部命令：显示某个ref对于的SHA1 HASH</td>
</tr>
<tr>
<td style="text-align:left">git reflog</td>
<td style="text-align:left">显示所有提交，包括孤立节点</td>
</tr>
<tr>
<td style="text-align:left">git show HEAD@{5}</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git show master@{yesterday}</td>
<td style="text-align:left">显示master分支昨天的状态</td>
</tr>
<tr>
<td style="text-align:left">git log –pretty=format:’%h %s’ –graph</td>
<td style="text-align:left">图示提交日志</td>
</tr>
<tr>
<td style="text-align:left">git show HEAD~3</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git show -s –pretty=raw 2be7fcb476</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git stash</td>
<td style="text-align:left">暂存当前修改，将所有至为HEAD状态</td>
</tr>
<tr>
<td style="text-align:left">git stash list</td>
<td style="text-align:left">查看所有暂存</td>
</tr>
<tr>
<td style="text-align:left">git stash show -p stash@{0}</td>
<td style="text-align:left">参考第一次暂存</td>
</tr>
<tr>
<td style="text-align:left">git stash apply stash@{0}</td>
<td style="text-align:left">应用第一次暂存</td>
</tr>
<tr>
<td style="text-align:left">git grep “delete from”</td>
<td style="text-align:left">文件中搜索文本“delete from”</td>
</tr>
<tr>
<td style="text-align:left">git grep -e ‘#define’ –and -e SORT_DIRENT</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git gc</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git fsck</td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/09/05/为什么Synchronized不能加在String和Integer等基本包装类型上/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/05/为什么Synchronized不能加在String和Integer等基本包装类型上/" itemprop="url">为什么Synchronized不能加在String和Integer等基本包装类型上</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-05T10:52:54+08:00">
                2017-09-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/05/为什么Synchronized不能加在String和Integer等基本包装类型上/" class="leancloud_visitors" data-flag-title="为什么Synchronized不能加在String和Integer等基本包装类型上">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>同步块不应该加在String或基本包装类型上，如Byte、Short、Integer、Long、Float、Double、Boolean、Character。</p>
<p>String不能用作同步块的参数是因为String为不可变对象，任何String对象的改变都将产生一个新的String对象，这也将导致前面加的锁不会被释放。</p>
<p>Integer、Boolean、Double、Long不能作为同步块参数的原因是他们是基本包装类型，包装类型有特殊的逻辑，用一句话说就是Java的自动封箱和解箱操作会导致这些对象在经过运算后不再是原来的对象。</p>
<p>用复杂的话说就是：当把基本变量赋值给包装类型的变量（其实编译过后的操作就是调用包装类型的静态方法valueOf）或者调用静态valueOf方法时：</p>
<ul>
<li>Boolean返回的是缓存的对象。</li>
<li>整型（Byte,Short,Integer,Long）会检查该数字是否在1个字节可表示的有符号整数范围内（-128~127），是则返回缓存对象，否则返回新对象。</li>
<li>Character会缓存整型值为0~127的字符，同样会检查字符是否落在缓存范围中，是则返回，否则返回新对象。</li>
<li>Double和Float的valueOf方法始终返回新对象。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/08/23/设计一个容错的微服务架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/23/设计一个容错的微服务架构/" itemprop="url">设计一个容错的微服务架构(转)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-23T15:21:52+08:00">
                2017-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/08/23/设计一个容错的微服务架构/" class="leancloud_visitors" data-flag-title="设计一个容错的微服务架构(转)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>摘要：转载请保留出处：<a href="https://github.com/jasonGeng88/blog" target="_blank" rel="external">https://github.com/jasonGeng88/blog</a></p>
</blockquote>
<h2 id="原文地址"><a href="#原文地址" class="headerlink" title="原文地址"></a>原文地址</h2><p><a href="https://blog.risingstack.com/designing-microservices-architecture-for-failure/" target="_blank" rel="external">https://blog.risingstack.com/designing-microservices-architecture-for-failure/</a></p>
<hr>
<p>微服务架构使得可以通过明确定义的服务边界来隔离故障。但是像在每个分布式系统中一样，发生网络、硬件、应用级别的错误都是很常见的。由于服务依赖关系，任何组件可能暂时无法提供服务。为了尽量减少部分中断的影响，我们需要构建容错服务，来优雅地处理这些中断的响应结果。</p>
<p>本文介绍了基于<a href="https://risingstack.com/" target="_blank" rel="external">RisingStack 的 Node.js 咨询和开发经验</a>构建和操作高可用性微服务系统的最常见技术和架构模式。</p>
<p>如果你不熟悉本文中的模式，那并不一定意味着你做错了。建立可靠的系统总是会带来额外的成本。</p>
<h2 id="微服务架构的风险"><a href="#微服务架构的风险" class="headerlink" title="微服务架构的风险"></a>微服务架构的风险</h2><p>微服务架构将应用程序逻辑移动到服务，并使用网络层在它们之间进行通信。这种通过网络间通信代替单应用程序内调用的做法，会带来额外的延迟，以及需要协调多个物理和逻辑组件的系统复杂度。分布式系统的复杂性增加也将导致更高的网络故障率。</p>
<p>微服务体系结构的最大优势之一是，团队可以独立设计，开发和部署他们的服务。他们对服务的生命周期拥有完全的所有权。这也意味着团队无法控制他们依赖的服务，因为它更有可能由不同的团队管理。使用微服务架构，我们需要记住，提供者服务可能会临时不可用，由于其他人员发行的错误版本，配置以及其他更改等。</p>
<h2 id="优雅的服务降级"><a href="#优雅的服务降级" class="headerlink" title="优雅的服务降级"></a>优雅的服务降级</h2><p>微服务架构的最大优点之一是您可以隔离故障，并在当组件单独故障时，进行优雅的服务降级。 例如，在中断期间，照片共享应用程序中的客户可能无法上传新图片，但仍可以浏览，编辑和共享其现有照片。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-fail-separately-in-theory.png" alt=""></p>
<p><em>微服务容错隔离</em></p>
<p>在大多数情况下，由于分布式系统中的应用程序相互依赖，因此很难实现这种优雅的服务降级，您需要应用几种故障转移的逻辑（其中一些将在本文后面介绍），以为暂时的故障和中断做准备。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/Microservices-depend-on-each-other.png" alt=""></p>
<p><em>服务间彼此依赖，再没有故障转移逻辑下，服务全部失败。</em></p>
<h2 id="变更管理"><a href="#变更管理" class="headerlink" title="变更管理"></a>变更管理</h2><p>Google的网站可靠性小组发现，大约70％的中断是由现有系统的变化引起的。当您更改服务中的某些内容时，您将部署新版本的代码或更改某些配置 - 这总有可能会造成故障，或者引入新的bug。</p>
<p>在微服务架构中，服务依赖于彼此。这就是为什么你应该尽量减少故障并限制它的负面影响。要处理变更中的问题，您可以实施变更管理策略和自动回滚机制。</p>
<p>例如，当您部署新代码或更改某些配置时，您应该先小范围的进行部分的替换，以渐进式的方式替换服务的全部实例。在这期间，需要监视它们，如果您发现它们对您的关键指标有负面影响，应立即进行服务回滚，这称为“金丝雀部署”。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-change-management.png" alt=""></p>
<p><em>变更管理 - 回滚部署</em></p>
<p>另一个解决方案可能是您运行两个生产环境。您始终只能部署其中一个，并且在验证新版本是否符合预期之后才，将负载均衡器指向新的。这称为蓝绿或红黑部署。</p>
<p>回滚代码不是坏事。你不应该在生产中遗留错误的代码，然后考虑出了什么问题。如果必要，越早回滚你的代码越好。</p>
<h2 id="健康检查与负载均衡"><a href="#健康检查与负载均衡" class="headerlink" title="健康检查与负载均衡"></a>健康检查与负载均衡</h2><p>实例由于出现故障、部署或自动缩放的情况，会进行持续启动、重新启动或停止操作。它可能导致它们暂时或永久不可用。为避免问题，您的负载均衡器应该从路由中跳过不健康的实例，因为它们当前无法为客户或子系统提供服务。</p>
<p>应用实例健康状况可以通过外部观察来确定。您可以通过重复调用<code>GET /health</code>端点或通过自我报告来实现。现在主流的服务发现解决方案，会持续从实例中收集健康信息，并配置负载均衡器，将流量仅路由到健康的组件上。</p>
<h2 id="自我修复"><a href="#自我修复" class="headerlink" title="自我修复"></a>自我修复</h2><p>自我修复可以帮助应用程序从错误中恢复过来。当应用程序可以采取必要步骤从故障状态恢复时，我们就可以说它是可以实现自我修复的。在大多数情况下，它由外部系统实现，该系统会监视实例运行状况，并在较长时间内处于故障状态时重新启动它们。自我修复在大多数情况下是非常有用的。但是在某些情况下，持续地重启应用程序可能会导致麻烦。 当您的应用程序由于超负荷或其数据库连接超时而无法给出健康的运行状况时，这种情况下的频繁的重启就可能就不太合适了。</p>
<p>对于这种特殊的场景（如丢失的数据库连接），要实现满足它的高级自我修复的解决方案可能很棘手。在这种情况下，您需要为应用程序添加额外的逻辑来处理边缘情况，并让外部系统知道实例不需要立即重新启动。</p>
<h2 id="故障转移缓存"><a href="#故障转移缓存" class="headerlink" title="故障转移缓存"></a>故障转移缓存</h2><p>由于网络问题和我们系统的变化，服务经常会失败。然而，由于自我修复和负载均衡的保障，它们中的大多数中断是临时的，我们应该找到一个解决方案，使我们的服务在这些故障时服务仍就可以工作。这就是故障转移缓存的作用，它可以帮助并为我们的应用程序在服务故障时提供必要的数据。</p>
<p>故障转移缓存通常使用两个不同的到期日期; 较短的时间告诉您在正常情况下缓存可以使用的过期时间，而较长的时间可以在服务故障时缓存依旧可用的过期时间。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-failover-caching.png" alt=""></p>
<p><em>故障转移缓存</em></p>
<p>请务必提及，只有当服务使用过时的数据比没有数据更好时，才能使用故障转移缓存。</p>
<p>要设置缓存和故障转移缓存，可以在 HTTP 中使用标准响应头。</p>
<p>例如，使用 <code>max-age</code> 属性可以指定资源被视为有效的最大时间。使用 <code>stale-if-error</code> 属性，您可以明确在出现故障的情况下，依旧可以从缓存中获取资源的最大时间。</p>
<p>现代的 CDN 和负载均衡器都提供各种缓存和故障转移行为，但您也可以为拥有标准可靠性解决方案的公司创建一个共享库。</p>
<h2 id="重试逻辑"><a href="#重试逻辑" class="headerlink" title="重试逻辑"></a>重试逻辑</h2><p>在某些情况下，我们无法缓存数据，或者我们想对其进行更改，但是我们的操作最终都失败了。对于此，我们可以重试我们的操作，因为我们可以预期资源将在一段时间后恢复，或者我们的负载均衡器将请求发送到了健康的实例上。</p>
<p>您应该小心地为您的应用程序和客户端添加重试逻辑，因为大量的重试可能会使事情更糟，甚至阻止应用程序恢复，如当服务超载时，大量的重试只能使状况更糟。</p>
<p>在分布式系统中，微服务系统重试可以触发多个其他请求或重试，并启动级联效应。为了最小化重试的影响，您应该限制它们的数量，并使用指数退避算法来持续增加重试之间的延迟，直到达到最大限制。</p>
<p>当客户端（浏览器，其他微服务等）发起重试，并且客户端不知道在处理请求之前或之后操作失败时，您应该为你的应用程序做好幂等处理的准备。例如，当您重试购买操作时，您不应该再次向客户收取费用。为每个交易使用唯一的幂等值键可以帮助处理重试。</p>
<h2 id="限流器和负载降级"><a href="#限流器和负载降级" class="headerlink" title="限流器和负载降级"></a>限流器和负载降级</h2><p>流量限制是在一段时间内定义特定客户或应用程序可以接收或处理多少个请求的技术。例如，通过流量限制，您可以过滤掉造成流量峰值的客户和服务，或者您可以确保您的应用程序在自动缩放无法满足时，依然不会超载。</p>
<p>您还可以阻止较低优先级的流量，为关键事务提供足够的资源。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-rate-limiter.png" alt=""></p>
<p><em>限流器可以阻止流量峰值产生</em></p>
<p>有一个不同类型的限流器，叫做并发请求限制器。当您有重要的端点，您不应该被调用超过指定的次数，而您仍然想要能提供服务时，这将是有用的。</p>
<p>负载降级的一系列使用，可以确保总是有足够的资源来提供关键交易。它为高优先级请求保留一些资源，不允许低优先级的事务使用它们。负载降级开关是根据系统的整体状态做出决定，而不是基于单个用户的请求量大小。负载降级有助于您的系统恢复，因为当你有一个偶发事件时（<em>可能是一个热点事件</em>），您仍能保持核心功能的正常工作。</p>
<p>要了解有关限流器和负载降级的更多信息，我建议查看这篇<a href="https://stripe.com/blog/rate-limiters" target="_blank" rel="external">Stripe的文章</a>。</p>
<h2 id="快速失败原则与独立性"><a href="#快速失败原则与独立性" class="headerlink" title="快速失败原则与独立性"></a>快速失败原则与独立性</h2><p>在微服务架构中，我们想要做到让我们的服务具备快速失败与相互独立的能力。为了在服务级别上进行故障隔离，我们可以使用舱壁模式。你可以在本文的后面阅读更多有关舱壁的内容。</p>
<p>我们也希望我们的组件能够快速失败，因为我们不希望对于有故障的服务，在请求超时后才断开。没有什么比挂起的请求和无响应的 UI 更令人失望。这不仅浪费资源，而且还会影响用户体验。我们的服务在调用链中是相互调用的，所以在这些延迟累加之前，我们应该特别注意防止挂起操作。</p>
<p>你想到的第一个想法是对每个服务调用都设置明确的超时等级。这种方法的问题是，您不能知道真正合理的超时值是多少，因为网络故障和其他问题发生的某些情况只会影响一两次操作。在这种情况下，如果只有其中一些超时，您可能不想拒绝这些请求。</p>
<p>我们可以说，在微服务种通过使用超时来达到快速失败的效果是一种反模式的，你应该避免使用它。取而代之，您可以应用断路器模式，依据操作的成功与失败统计数据决定。</p>
<h2 id="舱壁模式"><a href="#舱壁模式" class="headerlink" title="舱壁模式"></a>舱壁模式</h2><p>工业中使用舱壁将船舶划分为几个部分，以便在船体破坏的情况下，可以将船舶各个部件密封起来。</p>
<p>舱壁的概念在软件开发中可以被应用在隔离资源上。</p>
<p>通过应用舱壁模式，我们可以保护有限的资源不被耗尽。例如，对于一个有连接数限制的数据库实例来说，如果我们有两种连接它的操作，我们采用可以采用两个连接池的方式进行连接，来代替仅采用一个共享连接池的方式。由于这种客户端与资源进行了隔离，超时或过度使用池的操作页不会使其他操作失败。</p>
<p>泰坦尼克号沉没的主要原因之一是其舱壁设计失败，水可以通过上面的甲板倒在舱壁的顶部，导致整个船体淹没。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/titanic-bulkhead-microservices.png" alt=""></p>
<p><em>泰坦尼克号舱壁设计（无效的设计）</em></p>
<h2 id="断路器"><a href="#断路器" class="headerlink" title="断路器"></a>断路器</h2><p>为了限制操作的持续时间，我们可以使用超时。超时可以防止挂起操作并保持系统响应。然而，在微服务中使用静态、精细的超时是一种反模式，因为我们处于高度动态的环境中，几乎不可能提出在每种情况下都能正常工作的正确的时间限制。</p>
<p>替代这种静态超时的手段是，我们可以使用断路器来处理错误。断路器以现实世界的电子元件命名，因为它们的作用是相同的。您可以保护资源，并帮助他们使用断路器进行恢复。它们在分布式系统中非常有用，因为在分布式系统中，重复故障可能导致雪球效应并使整个系统瘫痪。</p>
<p>当特定类型的错误在短时间内多次发生时，断路器会被断开。开路的断路器可以防止进一步的请求 - 就像我们平时所说的电路跳闸一样。断路器通常在一定时间后关闭，在这期间可以为底层服务提供足够的空间来恢复。</p>
<p>请记住，并不是所有的错误都应该触发断路器。例如，您可能希望跳过客户端问题，例如具有4xx响应代码的请求，但不包括5xx服务器端故障。一些断路器也具有半开状态。在这种状态下，服务发送第一个请求以检查系统可用性，同时让其他请求失败。如果这个第一个请求成功，它将使断路器恢复到关闭状态并使流量流动。否则，它保持打开。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-circuit-breakers.png" alt=""></p>
<p><em>断路器</em></p>
<h2 id="测试故障"><a href="#测试故障" class="headerlink" title="测试故障"></a>测试故障</h2><p>您应该不断测试您系统的常见问题，以确保您的服务可以抵抗各种故障。您应经常测试故障，让您的团队具备故障处理的能力。</p>
<p>对于测试，您可以使用外部服务来标识实例组，并随机终止此组中的一个实例。这样，您可以准备单个实例故障，但您甚至可以关闭整个区域来模拟云提供商的故障。</p>
<p>最流行的测试解决方案之一是 Netflix 的 <a href="https://github.com/Netflix/chaosmonkey" target="_blank" rel="external">ChaosMonkey 弹性工具</a>。</p>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>实施和运行可靠的服务并不容易。 您需要付出很多努力，同时公司也要有相应的财力投入。</p>
<p>可靠性有很多层次和方面，因此找到最适合您团队的解决方案很重要。您应该使可靠性成为您的业务决策流程中的一个因素，并为其分配足够的预算和时间。</p>
<h2 id="主要收获"><a href="#主要收获" class="headerlink" title="主要收获"></a>主要收获</h2><ul>
<li>动态环境和分布式系统（如微服务）会导致更高的故障机率；</li>
<li>服务应该做到故障隔离，到达优雅降级，来提升用户体验；</li>
<li>70％的中断是由变化引起的，代码回滚不是一件坏事；</li>
<li>做到服务快速失败与独立性。团队是无法控制他们所依赖的服务情况；</li>
<li>缓存、舱壁、断路器和限流器等架构模式与技术有助于构建可靠的微服务架构。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="宁静·致远" />
          <p class="site-author-name" itemprop="name">宁静·致远</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">49</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">宁静·致远</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Gemini
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("pq7j7M6jaVzlRAhO3VhuFy1O-gzGzoHsz", "Fqlk4xsApzNKqC5HV87nMkix");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
