
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>宁静·致远</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="宁静·致远">
<meta property="og:url" content="http://fengfu.io/index.html">
<meta property="og:site_name" content="宁静·致远">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="宁静·致远">
  
    <link rel="alternative" href="/atom.xml" title="宁静·致远" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">宁静·致远</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="fengfu.io">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-一个HashBasedTable引发的故障" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/25/一个HashBasedTable引发的故障/" class="article-date">
  <time datetime="2017-07-25T11:32:13.000Z" itemprop="datePublished">2017-07-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/25/一个HashBasedTable引发的故障/">一个HashBasedTable引发的故障</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇故障从原因来看比较简单，但分享出来的原因是因为在分析故障原因的过程中忽略了一些关键因素，导致走了一些弯路，所以写出来供大家借鉴。</p>
<h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>上周负责的系统出现了一次故障，故障的表象是部分搜索超时严重。在对监控进行排查的时候，发现有一台服务器CPU使用率有比较大的飙升，为了不影响业务，先将此服务器重启。重启后，CPU使用率恢复正常，故障恢复（见下图）。<br><img src="https://img.alicdn.com/imgextra/i1/2657627814/TB2oeAKaVokyKJjy1zbXXXZfVXa_!!2657627814.png" alt="CPU使用率"></p>
<h1 id="故障原因分析过程"><a href="#故障原因分析过程" class="headerlink" title="故障原因分析过程"></a>故障原因分析过程</h1><p>剩下的事情就是对故障原因进行分析了，是什么原因导致了请求的超时呢？<br>于是查看其它的监控，发现CPU使用率异常的服务器在相似的时间点，出现了大量的CLOSE_WAIT，这时立马警觉起来。我们都知道，TCPIP断开连接要经历4次挥手的过程，如下图:</p>
<p><img src="https://img.alicdn.com/imgextra/i1/2657627814/TB2KN9XcnIlyKJjSZFMXXXvVXXa_!!2657627814.jpg" alt="TCPIP4次挥手过程"></p>
<p>从上面这个图我们可以看出，CLOSE_WAIT状态是由于对端主动断开了连接导致的。在我们的这个case中，我们的系统是client端，那也就意味着，是server端主动断开了与我们的连接，而正常情况client端应该继续发送ACK和FIN指令完成4次挥手过程的，但很显然我们的系统并没有继续后续的挥手，开始查找原因。</p>
<p><img src="https://img.alicdn.com/imgextra/i4/2657627814/TB2JGALa3wjyKJjSspeXXXXZXXa_!!2657627814.png" alt="CLOSE_WAIT监控"></p>
<p>由于系统中使用了AsyncHttpClient组件（以下简称AHC），开始时怀疑是AHC使用不当造成的。比如如果在AHC的时候使用流处理，而在处理流的时候出现异常，很有可能导致连接不能关闭而导致CLOSE_WAIT出现。但排查代码确认我们的系统中没有使用流，此原因排除。</p>
<p>考虑到我们的异步请求是通过继承AsyncCompletionHandler抽象类来实现异步结果的处理，于是开始确认onCompleted和onThrowable方法是不是有一些特殊处理导致连接没有关闭，但看代码也没发现有什么问题。于是“排除”了自己代码的原因。这里用双引号是因为其实并没有真正排除代码的问题，而是忽略了一处有问题的代码。这里先卖个关子。</p>
<p>后面开始怀疑是否是AHC的bug导致，于是放狗(google)查资料，在AHC的issue讨论区也看到有人反馈CLOSE_WAIT的情况，但对方是在大访问量的情况下会导致CLOSE_WAIT出现（<a href="https://github.com/AsyncHttpClient/async-http-client/issues/1027" title="issue链接" target="_blank" rel="external">issue链接</a>），但这个issue也没有得到AHC官方确认。考虑到我们的系统QPS不是很高，所以也排除了bug的可能性。</p>
<p>继续放狗，看到一篇博客(<a href="http://www.cnblogs.com/yuyijq/p/4431798.html" target="_blank" rel="external">链接</a>)讲netty里面的autoread特性会导致CLOSE_WAIT出现，但autoread是netty4里面的特性，我们使用的AHC依赖的是netty 3.10，这个原因也排除了。</p>
<p>至此，线索中断，于是求助余老师。PS：上面的那博客其实就是余老师写的，😆</p>
<p>余老师了解了情况之后，首先询问AHC是否使用的非单例（如果创建多个AsyncHttpClient实例是有可能导致大量CLOSE_WAIT的），答案是没有。<br>继续询问使用AHC的线程中是否使用了阻塞，答案是没有。<br>到这里，余老师也没给出更进一步的建议，所以继续排查。</p>
<p>第二天已经是周末，余老师继续帮忙定位问题，在看代码时发现有个地方的缓存使用了HashBasedTable，而HashBasedTable是非线程安全的，因为它使用了HashMap实现的，于是怀疑是这个地方可能会有问题。通过查看监控，发现故障时CPU、Load是同时增长的，而且CPU使用率在25%左右，基本可以确定在当时某个CPU核心使用率达到100%（服务器是4核）。</p>
<p>通过代码和监控的关联，可以确定这次故障的原因是因为使用了非线程安全的HashBasedTable，导致竞态条件下踩中了HashMap的坑导致当前线程所在CPU核心使用率100%，这样CPU也就没有时间来处理后续的网络事件了，比如断开连接，最终导致大量CLOSE_WAIT以及超时出现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Cache&lt;String, Table&lt;String,String,PackageFlightBean&gt;&gt; packageListBeanCache = CacheBuilder.from(packageListSpec).build();<span class="comment">//&lt;key,&lt;code,PackageFlightBean&gt;&gt;</span></div><div class="line"></div><div class="line"><span class="meta">@Resource</span></div><div class="line"><span class="keyword">private</span> DomesticSearchService domesticSearchService;</div><div class="line"><span class="meta">@Resource</span></div><div class="line"><span class="keyword">private</span> InterSearchService interSearchService;</div><div class="line"><span class="meta">@Resource</span></div><div class="line"><span class="keyword">private</span> PackageSearchService packageSearchService;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putPackageFlightBean</span><span class="params">(MultiQuery query,String code,PackageFlightBean packageFlightBean)</span></span>&#123;</div><div class="line">    List&lt;String&gt; codeList = splitter.splitToList(code);</div><div class="line">    <span class="keyword">if</span>(codeList.size()!=<span class="number">2</span> || packageFlightBean==<span class="keyword">null</span>)&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    String key = query.genPackageKey();</div><div class="line">    Table&lt;String,String,PackageFlightBean&gt; beanTable = packageListBeanCache.getIfPresent(key);</div><div class="line">    <span class="keyword">if</span>(beanTable==<span class="keyword">null</span>)&#123;</div><div class="line">        beanTable = HashBasedTable.create();<span class="comment">//这里使用了HashBasedTable，内部使用HashMap实现，非线程安全</span></div><div class="line">        beanTable.put(codeList.get(<span class="number">0</span>),codeList.get(<span class="number">1</span>),packageFlightBean);</div><div class="line">        packageListBeanCache.put(key,beanTable);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        beanTable.put(codeList.get(<span class="number">0</span>),codeList.get(<span class="number">1</span>),packageFlightBean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这次故障原因分析的过程走了一些弯路，原因有这么几点：</p>
<p>1.没有及时发现某个CPU核心使用率达到100%的情况：</p>
<p>如果能及时发现这一点，那么很可能就能在第一时间反应到是死循环导致的，那么定位问题会更快一些。当然如果我们的监控系统能够发现某个CPU核心使用率100%并告警就更好了，这个建议已经反馈给OPS同学，他们在想办法做了。那么在现有的情况下，如果我们发现CPU使用率平滑持续在25%左右，那么我们也需要额外注意，因为在4核的系统中，这可能代表某个CPU使用率已经在100%了；</p>
<p>2.没有保留现场如线程栈之类的信息：<br>如果在重启服务之前保留了线程栈，那么定位问题会更方便一些，可惜当时的同学急于修复故障，而未做到这一点；</p>
<p>3.没有发现HashBasedTable的坑：</p>
<p>  因为故障系统是个低频应用而且是从别的团队接手过来的，所以对代码不够熟悉，更不知道HashBasedTable是非线程安全的，最终导致故障的出现。这里也提醒一下，Guava里面的HashBasedTable、ArrayTable、TreeBasedTable、StandardTable、StandardRowSortedTable都是非线程安全的，使用的时候务必注意。另外，我们在使用在使用第三方工具的时候，务必要仔细查看相关说明，比如一些限制因素，避免踩坑。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2017/07/25/一个HashBasedTable引发的故障/" data-id="cj5kohhdp000l23x00l4j5bni" class="article-share-link" data-share="baidu" data-title="一个HashBasedTable引发的故障">分享到</a>
      

      
        <a href="http://fengfu.io/2017/07/25/一个HashBasedTable引发的故障/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Linux性能分析工具" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/13/Linux性能分析工具/" class="article-date">
  <time datetime="2017-06-13T09:28:33.000Z" itemprop="datePublished">2017-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/13/Linux性能分析工具/">Linux性能分析工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://img.alicdn.com/imgextra/i2/2657627814/TB2Fpf7w0FopuFjSZFHXXbSlXXa_!!2657627814.png" alt=""></p>
<p><img src="https://img.alicdn.com/imgextra/i1/2657627814/TB2oKsaw5RnpuFjSZFCXXX2DXXa_!!2657627814.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2017/06/13/Linux性能分析工具/" data-id="cj5kohhdq000o23x0kgobwf8f" class="article-share-link" data-share="baidu" data-title="Linux性能分析工具">分享到</a>
      

      
        <a href="http://fengfu.io/2017/06/13/Linux性能分析工具/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/性能/">性能</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-服务化架构-服务降级" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/23/服务化架构-服务降级/" class="article-date">
  <time datetime="2017-04-23T06:23:23.000Z" itemprop="datePublished">2017-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/23/服务化架构-服务降级/">服务化架构-服务降级</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-什么是降级"><a href="#1-什么是降级" class="headerlink" title="1. 什么是降级"></a>1. 什么是降级</h1><p>高可用系统为了保证自身的高可用性，会在异常情况下限制自身的一些能力，来保证核心功能的可用性。这有点类似武侠小说里面的壮士断腕，也有点类似于象棋里面的弃车保帅。</p>
<h1 id="2-为什么需要降级？"><a href="#2-为什么需要降级？" class="headerlink" title="2. 为什么需要降级？"></a>2. 为什么需要降级？</h1><p>在系统复杂度越来越高的今天，我们可能会经常遇到这样的困扰：一个非核心的功能异常最终导致了整个系统的不可用。比如一个获取非核心数据接口的超时最终导致了整个线程池全部阻塞，影响了核心功能线程的运行；业务链条中某个环节的接口不可用导致整个业务链的失败。这样的例子比比皆是，造成的损失往往也非常大，所以为了避免这种小功能搞垮大系统的情况发生，降级的概念就应运而生了。</p>
<h1 id="3-降级预案"><a href="#3-降级预案" class="headerlink" title="3. 降级预案"></a>3. 降级预案</h1><p>在要对系统制定降级策略之前，我们先对系统中的功能、服务进行梳理，识别出系统中的核心、非核心功能，这样能够梳理出哪些失败需要阻断主流程，哪些失败可以不阻断主流程。这样我们也就能确定哪些功能和服务必须死保，哪些功能和服务能够降级。<br>举个栗子：在机票的搜索流程中，报价、航班详情（如起降时间、航站楼）是关键信息，这些信息是无论如何不能缺失的；但餐食信息对于用户来讲就是可有可无的，当系统压力比较大的时候，我们就可以将餐食信息的获取给关掉，来优先保证核心数据的正常获取；<br>再举个栗子：对于机票的信息中，报价信息是经常变化的，但航班详情信息变化频率就没那么大。那么在系统压力比较大的情况下，可以将获取航班详情的方式由实时获取改为读取缓存，这样既不会导致数据准确性有太大的变化，也保证了系统核心功能的可用。</p>
<h1 id="4-降级策略"><a href="#4-降级策略" class="headerlink" title="4. 降级策略"></a>4. 降级策略</h1><h2 id="4-1-按功能降级"><a href="#4-1-按功能降级" class="headerlink" title="4.1 按功能降级"></a>4.1 按功能降级</h2><p>按功能降级是指在不影响核心功能的情况下，减少对非核心功能的使用，来保护系统的基本使用。<br>比如前面提到的例子，在机票搜索过程中，如果系统负载比较大出现超时，可以先将中转拼接报价计算功能（非核心功能）关闭，减少计算量，来降低系统负载保证用户搜索不至于失败；<br>再比如，在双11或者618的时候，系统的负载往往都比较大，这时候为了降低系统的负载，系统往往会把诸如支付后推荐、买了又买之类的非核心功能关闭。这些case我们可以参考淘宝、京东同学写的技术文章，例子不胜枚举。</p>
<h2 id="4-2-按来源降级"><a href="#4-2-按来源降级" class="headerlink" title="4.2 按来源降级"></a>4.2 按来源降级</h2><p>在某些时候，系统的QPS比较高，服务器扛不住压力的时候，可以针对请求进行限流。当然对于限流我们不能一刀切，如果能先限制某些不重要业务的访问，那是最好的。如果所有请求的重要程度是一样的，那么只能按照统一的策略进行限流了，毕竟牺牲掉部分用户请求来保证服务的可用性是第一位的。</p>
<h2 id="4-3-按质量降级"><a href="#4-3-按质量降级" class="headerlink" title="4.3 按质量降级"></a>4.3 按质量降级</h2><p>比如利用缓存。在机票行业，飞机上的舱位就相当于电商行业的库存，不同的是，电商的库存基本是自己管理，但机票的库存（舱位）是航司管理的，查询可用舱位花费的成本又很高。为了解决成本，我们可以针对某些冷门航线的舱位使用缓存，而且缓存时间设置得比较久，毕竟这些航线出票量比较少，没必要去占用过多的查询指令。</p>
<h1 id="5-降级介入方式"><a href="#5-降级介入方式" class="headerlink" title="5. 降级介入方式"></a>5. 降级介入方式</h1><p>在系统遇到异常情况时，我们需要执行事先准备的降级预案，这时候就需要额外的分支介入系统逻辑，来执行系统降级策略。降级的介入方式分为两种：人工介入和自动介入。当然有的时候在系统所处的局面比较复杂的时候，往往需要两者方式都需要使用，比如自动降级失效的情况下，那么必须进行人工介入了。</p>
<h2 id="5-1-人工介入"><a href="#5-1-人工介入" class="headerlink" title="5.1 人工介入"></a>5.1 人工介入</h2><p>人工介入的方式是指当系统维护人员在发现系统异常之后，通过人工修改参数、关闭服务等方式进行降级的方法。这种方式的好处是比较灵活，能够根据异常情况灵活应对；但弊端是对人的要求比较高，一来需要维护人员对系统有足够的了解，另外要求维护人员在系统异常时能够在第一时间进行处置。</p>
<h2 id="5-2-自动介入"><a href="#5-2-自动介入" class="headerlink" title="5.2 自动介入"></a>5.2 自动介入</h2><p>自动介入的方式一般是当系统达到某些设定的条件之后，自动执行一些策略。比如当系统以来的某个第三方数据接口的失败率达到设定的阈值，那么就使用缓存数据；再比如购买机票的时候，如果遇到航司接口维护，那么我们可以先收单，保证主流程不阻断，等航司接口恢复之后再执行出票处理。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2017/04/23/服务化架构-服务降级/" data-id="cj5kohhej001r23x0vux0yu14" class="article-share-link" data-share="baidu" data-title="服务化架构-服务降级">分享到</a>
      

      
        <a href="http://fengfu.io/2017/04/23/服务化架构-服务降级/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-使用JRebel远程热部署Class" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/11/使用JRebel远程热部署Class/" class="article-date">
  <time datetime="2017-04-11T13:08:09.000Z" itemprop="datePublished">2017-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/11/使用JRebel远程热部署Class/">使用 jrebel 远程部署开发环境的 dubbo 服务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文转自<a href="http://wulfric.me/2017/04/jrebel/" target="_blank" rel="external">http://wulfric.me/2017/04/jrebel/</a> ，如果转载请尊重原作者版权。</p>
<blockquote>
<p>声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" title="姓名标示-非商业性-禁止改作4.0国际" target="_blank" rel="external">CC BY-NC-ND 4.0</a> 授权。</p>
</blockquote>
<p><img src="https://zeroturnaround.com/wp-content/uploads/2011/02/jrebel-dl.png" alt="jrebel"></p>
<p>在开发 java 程序的时候，如果改动非常频繁，每次改动都要重新打包、部署，对于很重的应用（比如本文所说的 dubbo provider 服务），这样反复的流程十分消耗精力和热情。我们需要一个工具，当代码作改动之后能够立即看到效果。Java 在 1.4 的时候引入了 HotSwap 技术，允许调试者使用同一个类标识来更新类的字节码。这意味着所有对象都可以引用一个更新后的类，并在它们的方法被调用的时候执行新的代码，这就避免了无论何时只要有类的字节码被修改就要重载容器的这种要求<sup id="fnref:hotswap-jrebel"><a href="#fn:hotswap-jrebel">1</a></sup>。不幸的是，这种重定义仅限于修改方法体—除了方法体之外，它既不能添加方法或域，也不能修改其他任何东西。</p>
<p>和 PHP 这样的脚本语言不一样，Java 部署是一个令人心烦的问题。一个运行中的 Java 程序相当于一辆在公路上奔跑的汽车，而 HotSwap 技术只能让你更换坐垫，但是让你想要更换轮胎的时候，HotSwap 就帮不上忙了，这个时候你只能停下来，换掉轮胎，再重新启动。而对于 PHP 来说，每个请求都会新开一个进程加载所有的 .php 文件编译和执行，所以不存在这个问题。运行 PHP 程序相当于给静止的汽车拍照，你大可以换完轮胎之后再拍照，这没有任何不良影响。（这个比喻可能不太恰当，却很有趣：在比喻中，静态的语言看起来是运动的，而动态语言看起来是静止的）</p>
<p><a href="https://zeroturnaround.com/software/jrebel/" target="_blank" rel="external">JRebel</a> 是 java 的热部署插件，它监控已编译的 .class 文件，只要有变动，就立即更新在部署好的应用上，能够实现实时查看代码变化的功能。</p>
<p><img src="https://zeroturnaround.com/wp-content/uploads/2016/11/JR_devcycle_2016_c.png" alt="skip build, package and deploy"></p>
<p>skip build, package and deploy</p>
<p>HotSwap 是工作在虚拟机层面上，且依赖于 JVM 的内部运作，JRebel 用到了 JVM 的两个显著的功能特征—抽象的字节码和类加载器。类加载器允许 JRebel 辨别出类被加载的时刻，然后实时地翻译字节码，用以在虚拟机和可执行代码之间创建另一个抽象层<sup id="fnref:hotswap-jrebel:1"><a href="#fn:hotswap-jrebel">1</a></sup>。这种技术也应用在 zeroturnaround 家其他的工具，比如 xrebel。</p>
<p>如果继续使用上面的比喻，JRebel 相当于在汽车运行过程中，先额外生成一个轮胎，然后以迅雷之势替换掉目标轮胎—汽车不需要停止装载和再启动。</p>
<h2 id="安装和使用"><a href="#安装和使用" class="headerlink" title="安装和使用"></a>安装和使用</h2><p>JRebel 的安装参照官网即可，我是直接在 Intellij 的插件中心安装的，速度比较慢，插件也比较大，挂了代理才下载完成。下载完毕重启 IDE 即可使用。</p>
<p>JRebel 是收费插件，第一次打开的时候需要激活，网上有各种神奇教程可以参考。其实这个插件官方提供了免费的激活码，只要需要你注册一个<a href="https://my.jrebel.com/" target="_blank" rel="external">帐号</a>，并关联一个 twitter 或者 facebook 帐号即可。jrebel 需要这个关联帐号的写权限，会定期发送使用统计到你的 timeline，你可以使用一个小号来关联。</p>
<p>安装和激活完毕之后，就可以在 IDE 的配置页看到 JRebel 选项了。</p>
<p><a href="http://wulfric.qiniudn.com/java/jrebel-preference.png-origin.webp" target="_blank" rel="external"><img src="http://wulfric.qiniudn.com/java/jrebel-preference.png-article.webp" alt="jrebel preference"></a></p>
<p>jrebel preference</p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>为了能够比较熟悉该插件的使用，建议按照官方教程，先通过 IDE 本地启动，再通过命令行启动，然后尝试部署到远端服务器。</p>
<p>当在 console 窗口观察到这些输出之后，说明应用正确启用了 JRebel 插件。</p>
<pre><code>2017-04-01 16:27:31 JRebel:  #############################################################
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:  JRebel Agent 7.0.6 (201703201213)
2017-04-01 16:27:31 JRebel:  (c) Copyright ZeroTurnaround AS, Estonia, Tartu.
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:  Over the last 2 days JRebel prevented
2017-04-01 16:27:31 JRebel:  at least 0 redeploys/restarts saving you about 0 hours.
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:  JRebel started in remote server mode.
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:  #############################################################
</code></pre><h3 id="IDE-运行"><a href="#IDE-运行" class="headerlink" title="IDE 运行"></a>IDE 运行</h3><p>IDE 运行本地应用最简单。参见<a href="https://zeroturnaround.com/software/jrebel/quickstart/intellij/?run=ide#!/server-configuration" target="_blank" rel="external">官方教程</a>。</p>
<ol>
<li>执行<span class="codespan">mvn clean</span>清空 target 目录；</li>
<li>打开 「View &gt; Tool Windows &gt; JRebel」调出 JRebel Panel 编辑窗，点击「generate rebel.xml」按钮选中需要监控和热部署的模块。因为是本地执行，所以另外一个「generate rebel-remote.xml」 不需要选中；</li>
<li>将以前通过 「Run ‘MyApp’」或者「Debug ‘MyApp’」来运行的命令改成「Run with JRebel ‘MyApp’」或者「Debug with JRebel ‘MyApp’」即可；</li>
<li>修改代码，然后在「Build」菜单下选择合适的构建选项（只构建单个文件/构建模块/构建项目）；</li>
<li>访问接口，查看结果是否实时改变。</li>
</ol>
<h3 id="命令行运行"><a href="#命令行运行" class="headerlink" title="命令行运行"></a>命令行运行</h3><p>在 JRebel 设置页的「Startup」标签中选择「Run locally from command line」， 选择合适的 jvm 和目标环境。我的 dubbo 使用了 netty 部署，所以选择了「Standalone application」，给出的启动参数如下。</p>
<pre><code># agentpath 是必需的，foo.bar.MyApp 是你要运行的程序
java -agentpath:/Users/xxxx/Library/Application Support/IntelliJIdea2017.1/jr-ide-idea/lib/jrebel6/lib/libjrebel64.dylib foo.bar.MyApp
</code></pre><p>P.S.: 注意上面的「Application Support」需要换成「Application\ Support」。</p>
<p>dubbo 一般推荐使用 start.sh 脚本来启动应用，我们编辑 start.sh 文件，在启动的具体位置那里，将「-agentpath:…」添加在 java 后面，大致如下。</p>
<pre><code>java -agentpath:... $JAVA_OPTS $JAVA_MEM_OPTS $JAVA_DEBUG_OPTS -classpath ...
</code></pre><p>各种目标环境的配置方法有着或大或小的区别，请按照自己的目标环境跟着 JRebel 给的配置方案来设置。</p>
<ol>
<li>配置启动参数，如上所述；</li>
<li>选择需要热部署的模块；</li>
<li>执行<span class="codespan">start.sh</span>部署应用；</li>
<li>Run with JRebel ‘MyApp’；</li>
<li>修改代码，构建改动的文件；</li>
<li>访问接口，查看结果是否实时改变。</li>
</ol>
<p>从输出结果可以看到，JRebel 接管了 console。</p>
<h3 id="远程服务器运行"><a href="#远程服务器运行" class="headerlink" title="远程服务器运行"></a>远程服务器运行</h3><p>官方<a href="https://zeroturnaround.com/software/jrebel/quickstart/intellij/?run=remote#!/server-configuration" target="_blank" rel="external">教程1</a>，<a href="https://manuals.zeroturnaround.com/jrebel/remoteserver/intellij.html" target="_blank" rel="external">教程2</a>更好<sup id="fnref:jrebel-doc"><a href="#fn:jrebel-doc">2</a></sup>。</p>
<p>同上，在 JRebel 配置页选择「Run on a remote server」，根据给出的建议配置好启动项。</p>
<pre><code>java -agentpath:... -Drebel.remoting_plugin=true ... -jar ...
</code></pre><p>在 JRebel 配置页添加远程服务器地址，注意要是能够 http 访问的 url 才可以。</p>
<figure><a class="post-image" rel="post-image" href=""><img src="https://manuals.zeroturnaround.com/jrebel/_images/intellij-add-remote-server.png" alt="添加远程服务器" title="添加远程服务器"></a><br></figure>

<p>添加远程服务器</p>
<ol>
<li>配置启动参数和添加远程服务器，如上所述；</li>
<li>选择需要热部署的模块，注意这个时候「generate rebel.xml」和「generate rebel-remote.xml」 两个都要选中；</li>
<li>将包含 rebel.xml 和 rebel-remote.xml 的代码部署到远程服务器。本地打包并上传，或者代码上传并在远程服务器打包都可以；</li>
<li>在远程服务器上<span class="codespan">start.sh</span>启动应用；</li>
<li>修改代码，构建改动的文件；</li>
<li>访问接口，查看结果是否实时改变。</li>
</ol>
<p>P.S.: 教程1似乎有些问题，远端启动应用后，本地不需要再「Run with JRebel ‘MyApp’」了。</p>
<p>P.S.: 在官方教程里，「Run with JRebel ‘MyApp’」和「generate rebel.xml」checkbox 的图标一模一样，注意区分：有的是让你启动，有的是选中。</p>
<p>P.S.: JRebel 对 Spring 的 bean 注入默认就有很好的支持，参见 <a href="https://zeroturnaround.com/software/jrebel/learn/jrebel-spring-integration/" target="_blank" rel="external">JRebel Spring</a>。它可以根据 xml 文件或者注解自动重新装载 bean。还支持动态实时地在 Spring 中添加 bean 和依赖。</p>
<ol>
<li><p>HotSwap 和 JRebel 原理<a href="https://dzone.com/articles/reloading-java-classes-401" target="_blank" rel="external">原文</a>，<a href="http://www.hollischuang.com/archives/598" target="_blank" rel="external">译文</a> <a href="#fnref:hotswap-jrebel">↩</a> <a href="#fnref:hotswap-jrebel:1">↩<sup>2</sup></a></p>
</li>
<li><p>参照官方的<a href="https://manuals.zeroturnaround.com/jrebel/index.html" target="_blank" rel="external">详细使用文档</a>是更好的选择 <a href="#fnref:jrebel-doc">↩</a></p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2017/04/11/使用JRebel远程热部署Class/" data-id="cj5kohhdu000t23x0d8hu2cnx" class="article-share-link" data-share="baidu" data-title="使用 jrebel 远程部署开发环境的 dubbo 服务">分享到</a>
      

      
        <a href="http://fengfu.io/2017/04/11/使用JRebel远程热部署Class/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Spring Xml扩展机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/06/Spring Xml扩展机制/" class="article-date">
  <time datetime="2017-03-06T10:41:09.000Z" itemprop="datePublished">2017-03-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/06/Spring Xml扩展机制/">Spring xml扩展机制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Spring框架从2.0版本开始，提供了基于Schema风格的XML扩展机制，允许开发者扩展最基本的spring配置文件，这样我们就可以编写自定义的xml bean解析器然后集成到Spring IoC容器中。很多支持Spring的框架，比如Dubbo、mybatis都提供了对Spring xml扩展的支持。</p>
<p>Xml扩展大概有以下几个步骤：</p>
<ul>
<li>编写xml schema来描述自定义元素</li>
<li>编写自定义类</li>
<li>编写<code>NamespaceHandler</code>的实现类</li>
<li>编写<code>BeanDefinitionParser</code>实现类</li>
<li>把上述组件注册到Spring</li>
</ul>
<h2 id="编写自定义schema"><a href="#编写自定义schema" class="headerlink" title="编写自定义schema"></a>编写自定义schema</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns</span>=<span class="string">"http://www.mycompany.com/schema/product"</span></span></div><div class="line">        <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></div><div class="line">        <span class="attr">xmlns:beans</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></div><div class="line">        <span class="attr">targetNamespace</span>=<span class="string">"http://www.mycompany.com/schema/product"</span></div><div class="line">        <span class="attr">elementFormDefault</span>=<span class="string">"qualified"</span></div><div class="line">        <span class="attr">attributeFormDefault</span>=<span class="string">"unqualified"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"robot"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">xsd:extension</span> <span class="attr">base</span>=<span class="string">"beans:identifiedType"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"brand"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> <span class="attr">use</span>=<span class="string">"required"</span>/&gt;</span></div><div class="line">										<span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"type"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> <span class="attr">use</span>=<span class="string">"required"</span>/&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"height"</span> <span class="attr">type</span>=<span class="string">"xsd:int"</span>/&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"weight"</span> <span class="attr">type</span>=<span class="string">"xsd:float"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">xsd:extension</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="编写自定义类"><a href="#编写自定义类" class="headerlink" title="编写自定义类"></a>编写自定义类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> String brand;</div><div class="line">	<span class="keyword">private</span> String type;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> height;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">float</span> weight;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们就可以在xml中定义如下的robot元素:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">product:robot</span> <span class="attr">id</span>=<span class="string">"bb8"</span> <span class="attr">brand</span>=<span class="string">"StarWar"</span> <span class="attr">type</span>=<span class="string">"bb8"</span> <span class="attr">height</span>=<span class="string">"100"</span> <span class="attr">weight</span>=<span class="string">"20"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="编写NamespaceHandler"><a href="#编写NamespaceHandler" class="headerlink" title="编写NamespaceHandler"></a>编写NamespaceHandler</h2><p><code>NamespaceHandler</code>用于解析我们自定义名字空间下的所有元素，目前我们要解析上面的<code>product:robot</code>元素。<br><code>NamespaceHandler</code>里面只有3个方法：</p>
<ul>
<li><code>init()</code>会在<code>NamespaceHandler</code>初始化的时候被调用。</li>
<li><code>BeanDefinition parse(Element, ParserContext)</code> - 当Spring遇到一个顶层元素的时候被调用。</li>
<li><code>BeanDefinitionHolder decorate(Node, BeanDefinitionHolder, ParserContext)</code> - 当Spring遇到一个属性或嵌套元素的时候调用.</li>
</ul>
<p>Spring提供了默认实现类<code>NamespaceHandlerSupport</code>，我们只需在init的时候注册每个元素的解析器即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">//遇到robot元素的时候交给RobotBeanDefinitionParser来解析</span></div><div class="line">		registerBeanDefinitionParser(<span class="string">"robot"</span>, <span class="keyword">new</span> RobotBeanDefinitionParser());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="编写BeanDefinitionParser"><a href="#编写BeanDefinitionParser" class="headerlink" title="编写BeanDefinitionParser"></a>编写BeanDefinitionParser</h2><p>这样在解析xml过程中遇到robot元素时，Spring会交给RobotBeanDefinitionParser来解析。RobotBeanDefinitionParser取出相应的属性然后设置到bean中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RobotBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</div><div class="line">		<span class="comment">//robot元素对应Robot对象类型</span></div><div class="line">		<span class="keyword">return</span> Robot.class;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</div><div class="line"></div><div class="line">		String brand = element.getAttribute(<span class="string">"brand"</span>);</div><div class="line">		String type = element.getAttribute(<span class="string">"type"</span>);</div><div class="line">		String height = element.getAttribute(<span class="string">"height"</span>);</div><div class="line">		String weight = element.getAttribute(<span class="string">"weight"</span>);</div><div class="line"></div><div class="line">		<span class="comment">//把对应的属性设置到bean中</span></div><div class="line">		<span class="keyword">if</span>(StringUtils.hasText(brand))</div><div class="line">			builder.addPropertyValue(<span class="string">"brand"</span>, brand);</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(StringUtils.hasText(type))</div><div class="line">			builder.addPropertyValue(<span class="string">"type"</span>, type);</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(StringUtils.hasText(height))</div><div class="line">			builder.addPropertyValue(<span class="string">"height"</span>, height);</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(StringUtils.hasText(weight))</div><div class="line">			builder.addPropertyValue(<span class="string">"weight"</span>, weight);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="注册handler和schema"><a href="#注册handler和schema" class="headerlink" title="注册handler和schema"></a>注册handler和schema</h2><p>为了让Spring在解析xml的时候能够感知到我们的自定义元素，我们需要把<code>namespaceHandler</code>和xsd文件放到2个指定的配置文件中，这2个文件都位于<code>META-INF</code>目录中。</p>
<h4 id="META-INF-spring-handlers"><a href="#META-INF-spring-handlers" class="headerlink" title="META-INF/spring.handlers"></a>META-INF/spring.handlers</h4><p><code>`spring.handlers` </code>文件包含了xml schema uri和handler类的映射关系，比如：</p>
<blockquote>
<p>http\://www.mycompany.com/schema/product=spring.xml.ext.schema.ProductNamespaceHandler</p>
</blockquote>
<p>这表示遇到<code>http://www.mycompany.com/schema/product</code>命名空间的时候会交给<code>ProductNamespaceHandler</code>来处理。</p>
<p>注意上面的冒号转义。<br>key部分必须和xsd文件中的<code>targetNamespace</code>值保持一致。</p>
<h4 id="META-INF-spring-schemas"><a href="#META-INF-spring-schemas" class="headerlink" title="META-INF/spring.schemas"></a>META-INF/spring.schemas</h4><blockquote>
<p>http\://www.mycompany.com/schema/product.xsd=META-INF/product.xsd</p>
</blockquote>
<h2 id="最后测试下"><a href="#最后测试下" class="headerlink" title="最后测试下"></a>最后测试下</h2><p>写个Spring配置文件products.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> 	<span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">		<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">		<span class="attr">xmlns:my</span>=<span class="string">"http://www.mycompany.com/schema/product"</span></div><div class="line">		<span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></div><div class="line">	        http://www.springframework.org/schema/beans</div><div class="line">	        http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">	        http://www.mycompany.com/schema/product</div><div class="line">	        http://www.mycompany.com/schema/product.xsd"&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">product:robot</span> <span class="attr">id</span>=<span class="string">"bb8"</span> <span class="attr">brand</span>=<span class="string">"StarWar"</span> <span class="attr">type</span>=<span class="string">"bb8"</span> <span class="attr">height</span>=<span class="string">"100"</span> <span class="attr">weight</span>=<span class="string">"20"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(locations = &#123; <span class="string">"classpath:products.xml"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchemaTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	<span class="meta">@Qualifier</span>(<span class="string">"bb8"</span>)</div><div class="line">	<span class="keyword">private</span> Robot robot;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">propertyTest</span><span class="params">()</span> </span>&#123;</div><div class="line">		assertNotNull(robot);</div><div class="line"></div><div class="line">		String brand = robot.getBrand();</div><div class="line">		String type = robot.getType();</div><div class="line">		<span class="keyword">int</span> height = robot.getHeight();</div><div class="line">		<span class="keyword">float</span> weight = robot.getWeight();</div><div class="line"></div><div class="line">		assertEquals(<span class="string">"Brand should be bb8."</span>, <span class="string">"bb8"</span>, brand);</div><div class="line">		assertEquals(<span class="string">"Type should be bb8."</span>, <span class="string">"bb8"</span>, type);</div><div class="line">		assertEquals(<span class="string">"Height should be 100."</span>, <span class="number">100</span>, height);</div><div class="line">		assertEquals(<span class="string">"Weight should be 20."</span>, <span class="number">20</span>, weight);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://blog.csdn.net/cutesource/article/details/5864562" target="_blank">基于Spring可扩展Schema提供自定义配置支持</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2017/03/06/Spring Xml扩展机制/" data-id="cj5kohhds000q23x0y9v494dy" class="article-share-link" data-share="baidu" data-title="Spring xml扩展机制">分享到</a>
      

      
        <a href="http://fengfu.io/2017/03/06/Spring Xml扩展机制/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-jcmd命令详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/14/jcmd命令详解/" class="article-date">
  <time datetime="2016-12-14T08:28:59.000Z" itemprop="datePublished">2016-12-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/14/jcmd命令详解/">jcmd命令详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>在JDK 1.7及之后的版本，新增了一个命令行工具jcmd。它是一个多功能工具，可以做哪些事情呢？这里先卖个关子，先来看看Oracle官方对jcmd的介绍:</p>
<p><em>The jcmd utility is used to send diagnostic command requests to the JVM, where these requests are useful for controlling Java Flight Recordings, troubleshoot, and diagnose JVM and Java Applications. It must be used on the same machine where the JVM is running, and have the same effective user and group identifiers that were used to launch the JVM.</em></p>
<p>翻译成人话就是：<br>jcmd一个用来发送诊断命令请求到JVM的工具，这些请求对于控制Java飞行记录器、故障排除、JVM和Java应用诊断来说是比较有用的。jcmd必须与正在运行的JVM在同一台机器上使用，并且使用启动该JVM时的用户权限。</p>
<h1 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h1><p>jcmd的用法是:<br><code>jcmd &lt;process id/main class&gt; &lt;command&gt; [options]</code></p>
<p>其中command的说明如下：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>help</td>
<td>打印帮助信息，示例：jcmd <pid> help [<command name="">]</pid></td>
</tr>
<tr>
<td>ManagementAgent.stop</td>
<td>停止JMX Agent</td>
</tr>
<tr>
<td>ManagementAgent.start_local</td>
<td>开启本地JMX Agent</td>
</tr>
<tr>
<td>ManagementAgent.start</td>
<td>开启JMX Agent</td>
</tr>
<tr>
<td>Thread.print</td>
<td>参数-l打印java.util.concurrent锁信息，相当于：jstack <pid></pid></td>
</tr>
<tr>
<td>PerfCounter.print</td>
<td>相当于：jstat -J-Djstat.showUnsupported=true -snap <pid></pid></td>
</tr>
<tr>
<td>GC.class_histogram</td>
<td>相当于：jmap -histo <pid></pid></td>
</tr>
<tr>
<td>GC.heap_dump</td>
<td>相当于：jmap -dump:format=b,file=xxx.bin <pid></pid></td>
</tr>
<tr>
<td>GC.run_finalization</td>
<td>相当于：System.runFinalization()</td>
</tr>
<tr>
<td>GC.run</td>
<td>相当于：System.gc()</td>
</tr>
<tr>
<td>VM.uptime</td>
<td>参数-date打印当前时间，VM启动到现在的时候，以秒为单位显示</td>
</tr>
<tr>
<td>VM.flags</td>
<td>参数-all输出全部，相当于：jinfo -flags <pid>, jinfo -flag <vm flag=""> <pid></pid></vm></pid></td>
</tr>
<tr>
<td>VM.system_properties</td>
<td>相当于：jinfo -sysprops <pid></pid></td>
</tr>
<tr>
<td>VM.command_line</td>
<td>相当于：jinfo -sysprops <pid></pid></td>
<td>grep command</td>
</tr>
<tr>
<td>VM.version</td>
<td>相当于：jinfo -sysprops <pid></pid></td>
<td>grep version</td>
</tr>
</tbody>
</table>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2016/12/14/jcmd命令详解/" data-id="cj5kohhdv000v23x0a3g8bm16" class="article-share-link" data-share="baidu" data-title="jcmd命令详解">分享到</a>
      

      
        <a href="http://fengfu.io/2016/12/14/jcmd命令详解/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-服务化架构-注册与发现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/23/服务化架构-注册与发现/" class="article-date">
  <time datetime="2016-11-23T06:21:40.000Z" itemprop="datePublished">2016-11-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/23/服务化架构-注册与发现/">服务化架构-注册与发现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h1><p>在分布式系统中，服务提供端和消费端彼此不知道对方的存在，因此需要有一种机制来确保消费端能够找到提供端并进行调用。一般来说，提供端需要将自己能够提供的服务信息暴露出来，这样消费端通过检索就能找到自己需要的服务并建立连接进行调用。所以，对于服务提供端来讲，需要具备以下功能：</p>
<ol>
<li>服务注册：将服务信息暴露出来，供消费端查找和使用</li>
<li>取消注册：即注销服务的注册信息</li>
</ol>
<p>同时，对于消费端来说，则需要：</p>
<ol>
<li>服务检索：按一定条件查找服务信息，如按应用、接口、IP等检索</li>
<li>服务订阅：订阅特定的服务，为后面的服务调用和治理做前期准备</li>
<li>取消订阅：取消指定服务的订阅</li>
</ol>
<h1 id="结构组成"><a href="#结构组成" class="headerlink" title="结构组成"></a>结构组成</h1><p>在这种情况下，注册中心的概念就被提了出来。</p>
<p>同时，系统间调用需要能够根据服务的运行状态(如上下线状态、负载、响应时间、网络情况等)而灵活调整调用端与服务端的组合。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2016/11/23/服务化架构-注册与发现/" data-id="cj5kohhef001k23x0rpj2cyc5" class="article-share-link" data-share="baidu" data-title="服务化架构-注册与发现">分享到</a>
      

      
        <a href="http://fengfu.io/2016/11/23/服务化架构-注册与发现/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-服务化架构-组成" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/23/服务化架构-组成/" class="article-date">
  <time datetime="2016-11-23T06:21:06.000Z" itemprop="datePublished">2016-11-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/23/服务化架构-组成/">服务化架构-组成</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="功能结构"><a href="#功能结构" class="headerlink" title="功能结构"></a>功能结构</h1><p>既然是服务化架构，那么肯定会包含服务提供方和调用方，即provider和consumer。那么作为分布式的服务化架构，需要有一个地方存储provider的信息，便于consumer调用，那么这个角色就是注册中心(registry)。</p>
<p>另外，鉴于分布式系统的复杂性和状态多样性，我们需要对provider、consumer、registry进行管理，比如服务依赖管理、权限管理、配置管理、版本管理、流量控制、服务上下线等，那么管理端(administrator)也就成了标配。</p>
<p>所以综上所述，一个完整的分布式服务化架构，应该包含4部分：</p>
<ol>
<li>注册中心Registry</li>
<li>服务提供端Provider</li>
<li>服务消费端Consumer</li>
<li>管理端Administrator</li>
</ol>
<p><img src="https://img.alicdn.com/imgextra/i3/2657627814/TB2_wgncKNOdeFjSZFBXXctzXXa_!!2657627814.png" alt=""></p>
<p>其中，Provider将自己能够提供的服务信息登记到注册中心，同时通过心跳的方式定时更新自己的状态。Consumer从Registry获取可用服务信息后，直接与Provider建立连接进行交互。</p>
<p>这种架构，基于RPC的服务框架如dubbo/dubbox，JSF都是采用这种机制。</p>
<p>另外，一些基于REST的服务框架（比如Spring Cloud）会增加服务路由的组件，也就是说Consumer需要经过服务路由才能请求Provider，这种方式下，其架构就是由5部分组成：</p>
<ol>
<li>注册中心Registry</li>
<li>服务提供端Provider</li>
<li>服务消费端Consumer</li>
<li>服务路由Router</li>
<li>管理端Administrator</li>
</ol>
<p><img src="https://img.alicdn.com/imgextra/i4/2657627814/TB29vfhdNaJ.eBjSsziXXaJ_XXa_!!2657627814.png" alt=""></p>
<p>经由服务路由调用的方式，典型的代表是Spring Cloud，如下图：</p>
<p><img src="https://img.alicdn.com/imgextra/i3/2657627814/TB28lS_dH1J.eBjSszcXXbFzVXa_!!2657627814.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2016/11/23/服务化架构-组成/" data-id="cj5kohhei001p23x0dykez35k" class="article-share-link" data-share="baidu" data-title="服务化架构-组成">分享到</a>
      

      
        <a href="http://fengfu.io/2016/11/23/服务化架构-组成/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-服务化架构-前言" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/23/服务化架构-前言/" class="article-date">
  <time datetime="2016-11-23T03:20:00.000Z" itemprop="datePublished">2016-11-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/23/服务化架构-前言/">服务化架构-前言</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>近两年，微服务的概念逐渐火了起来，而docker的出现，更是在微服务的火上浇了一桶油。纯粹地讲，我不太认同微服务的说法。说白了，你还是一个服务，只是因为你的小微，有些地方你需要特别注意，比如高内聚、低耦合，比如团队规模的“两个披萨”原则等。但其实这些原则对于“服务”的世界来讲，早就是普世价值了。</p>
<p>那我们再往前看5年，那时候服务化的架构已经开始在业界崭露头角，比如2011年的时候，阿里把内部的dubbo框架开源了。从当前的标准来看，dubbo并不是一个非常优秀的服务化框架，它有很多缺陷和缺失，但是在5年前，这已经难能可贵了。</p>
<p>上周，在朋友的公司做了一次服务化架构的内训。为了准备这个PPT，特地将服务化框架的体系做了一个梳理，因此决定趁热打铁，写个系列博客进行更进一步的总结。</p>
<p>这个系列的文章，将从以下几个方面进行总结：</p>
<ol>
<li>服务化架构的组成</li>
<li>服务注册与发现</li>
<li>RPC</li>
<li>同步与异步</li>
<li>服务依赖管理</li>
<li>服务链路跟踪</li>
<li>服务路由</li>
<li>服务负载均衡</li>
<li>服务降级</li>
<li>服务限流</li>
<li>服务上下线</li>
<li>服务授权</li>
<li>服务监控与告警</li>
<li>服务版本管理</li>
</ol>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2016/11/23/服务化架构-前言/" data-id="cj5kohhec001f23x04vjgjugb" class="article-share-link" data-share="baidu" data-title="服务化架构-前言">分享到</a>
      

      
        <a href="http://fengfu.io/2016/11/23/服务化架构-前言/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-晋级Review归来话代码有毒" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/27/晋级Review归来话代码有毒/" class="article-date">
  <time datetime="2016-10-27T07:36:55.000Z" itemprop="datePublished">2016-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/27/晋级Review归来话代码有毒/">晋级Review归来话代码有毒</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这几天做应届生的转正定级答辩，结束后小黑哥在朋友圈里面发了下面一幅图：</p>
<p><img src="https://img.alicdn.com/imgextra/i3/2657627814/TB2qDgda71M.eBjSZPiXXawfpXa_!!2657627814.jpg" alt=""></p>
<p>并在评论里面说了一句话：网络不超时，堆外不清理，异步不回调，异常不监控。</p>
<p>上面的中毒情况总结得非常不错，这让我想起了《唐伯虎点秋香》里面的一段情节：</p>
<p><img src="https://img.alicdn.com/imgextra/i3/2657627814/TB2Poz0aHaI.eBjy1XdXXcoqXXa_!!2657627814.jpg" alt=""></p>
<p>华夫人对唐伯虎说：一日丧命散是用七种不同的毒虫再加上那鹤顶红提炼七七四十九天而成的，无色无味，杀人于无影无踪。吃了我们一日丧命散的人，一天之内会武功全失，经脉逆流，胡思乱想而至走火入魔，最后啊，会血管爆裂而死。</p>
<p>借着这个情节和小黑哥的中毒，来总结一下代码里面的七种毒虫吧。</p>
<p><img src="https://img.alicdn.com/imgextra/i1/2657627814/TB2Qegea71M.eBjSZPiXXawfpXa_!!2657627814.jpg" alt=""></p>
<h1 id="1-资源不限制"><a href="#1-资源不限制" class="headerlink" title="1.资源不限制"></a>1.资源不限制</h1><p>这是很多码农容易中的毒，典型的症状是：</p>
<h2 id="1-1-缓存不设置最大数量限制"><a href="#1-1-缓存不设置最大数量限制" class="headerlink" title="1.1 缓存不设置最大数量限制"></a>1.1 缓存不设置最大数量限制</h2><p>比如我们使用map实现了一个cache，但是没有设置cache的大小，久而久之你可以想象一下这个cache最终会膨胀到什么程度。当然有同学可能会说我使用的是Guava cache，可以设置数量限制。well done，你再回去看看你的full gc是不是比较频繁，没准是因为这个值太大导致的哟~</p>
<h2 id="1-2-线程池不设置队列大小"><a href="#1-2-线程池不设置队列大小" class="headerlink" title="1.2 线程池不设置队列大小"></a>1.2 线程池不设置队列大小</h2><p>比如我们使用newFixedThreadPool，但是我们没有设置队列的大小，而悲催的是，在java中，线程池队列的默认大小是Integer.MAX_VALUE，我想你自己也能清楚这种情况下会发生什么问题。<br>再比如Executors.newCachedThreadPool，这个接口很多人会用到，但很多用的人都没有仔细想过会不会在某种情况下这里创建出巨多的线程。</p>
<h1 id="2-网络不超时"><a href="#2-网络不超时" class="headerlink" title="2.网络不超时"></a>2.网络不超时</h1><p>这里说的是网络调用的场景不设置超时。</p>
<p>在服务化设计大行其道的今天，我们很多的服务调用都是通过网络调用进行的。设想一下，如果我们调用的某个服务性能低下或者网络异常，长时间没有返回结果，那么调用端线程就会一直阻塞在这里。如果没有使用线程池，那么应用会阻塞在这里。如果使用了线程池，那么线程就会长时间阻塞，最终导致线程池爆掉。</p>
<p>在review代码的时候，这种情况尤其常见，尤其是使用httpclient的时候，各位看官要多加注意哟。</p>
<h1 id="3-自我不保护"><a href="#3-自我不保护" class="headerlink" title="3.自我不保护"></a>3.自我不保护</h1><p>这种情况尤其常见于对外提供接口的情况。对于调用方传过来的参数，我们没有做严格的有效性检查或者限制，最终导致不符合要求的数据将程序搞挂。比如我们提供了一个用户信息批量查询的接口，参数是一个数组。结果是某个调用方传了有1000个元素的数组过来，最终可能直接导致程序内存溢出……这种情况我们能去怪罪调用方吗？严格来说，我们不能，在这里可以借鉴一句经典的话：不要相信前端传来的任何数据。我想对于接口也是一样：不要相信调用端传来的任何数据。</p>
<p>还有一种情况就是系统处理能力的保护，最典型的就是QPS。如果我们的系统能够承受的QPS是100，那么如果QPS超过这个数值，我们该怎么办？我想很多人心里已经有了答案了。</p>
<h1 id="4-连接不关闭"><a href="#4-连接不关闭" class="headerlink" title="4.连接不关闭"></a>4.连接不关闭</h1><p>这里其实是有两点要强调，连接和流。</p>
<h2 id="4-1-连接不关闭"><a href="#4-1-连接不关闭" class="headerlink" title="4.1 连接不关闭"></a>4.1 连接不关闭</h2><p>说到连接，这里所说的是网络连接。我们都知道，网络资源是一种受限资源，无限制的网络连接会给自身及对方系统带来很大的压力，因此我们会使用连接池或其他连接复用技术来降低系统压力，以此提高效率。但是如果我们忘记了关闭连接的话，就会对对端系统带来隐患。比如数据库连接，如果忘记关闭，会造成数据库服务器连接资源耗尽最终导致拒绝服务。当然有同学说，现在很多服务器都有超时检查机制，长时间不活动的连接会自动清除。那么你想过没有，如果连接被服务器断开，这种情况下客户端是感知不到的。只有你下次使用的时候才发现连接已经不可用了。</p>
<h2 id="4-2-流不关闭"><a href="#4-2-流不关闭" class="headerlink" title="4.2 流不关闭"></a>4.2 流不关闭</h2><p>流的问题很好理解，我们读写文件、网络传输，很多很多场景需要使用流，而在操作系统层面，对文件、网络的操作都是有限制的。在使用流的时候，我们首先需要进行open，最后close。如果我们忘记了close，那么系统就不会释放对此资源的占用，最终超出系统限制而导致后续的操作失败，最典型的错误就是too many open files。</p>
<h1 id="5-异步不回调"><a href="#5-异步不回调" class="headerlink" title="5.异步不回调"></a>5.异步不回调</h1><p>在分布式服务架构中，很多的服务为了提高并发处理能力，使用了异步机制。异步的好处是消费端可以不必一直等待服务端的结果，而将资源交给其他的逻辑处理。当服务端有结果返回时，通过回调机制调用消费端的逻辑进行后续的处理。但是在实际的使用过程中，发现很多人还是使用同步的方式来调用异步方法，比如：</p>
<pre><code>fooService.findFoo(fooId); //fooService.findFoo方法支持异步
Future&lt;Foo&gt; fooFuture = RpcContext.getContext().getFuture(); 

Foo foo = fooFuture.get(); // 如果foo已返回，直接拿到返回值，否则线程wait住，等待foo返回后，线程会被notify唤醒
</code></pre><p>我们知道Future对象具有如下的特性：</p>
<ol>
<li>异步执行，可用 get 方法获取执行结果；</li>
<li>如果计算还没完成，get 方法是会阻塞的，如果完成了，是可以多次获取并立即得到结果的；</li>
<li>如果计算还没完成，是可以取消计算的；</li>
<li>可以查询计算的执行状态</li>
</ol>
<p>所以上述的代码问题主要出现在第3行，如果fooService.findFoo方法还没有返回值，那么fooFuture.get()方法会被阻塞直到结果返回，这样就失去了异步调用的优势了。</p>
<p>那么针对上面的代码，正确的写法应该是通过回调机制做数据返回时的处理：</p>
<pre><code>fooService.findFoo(fooId);  

ResponseFuture future = ((FutureAdapter)RpcContext.getContext().getFuture()).getFuture();
future.setCallback(new ResponseCallback(){
    public void done(Object response){
       //调用正常的时候执行
    }

    public void caught(Throwable exception){
      //调用异常的时候执行
    }
});
</code></pre><p>当然，上面的方式只是举了个栗子，具体情况需要根据不同的RPC框架去做处理。这里推荐Google guava concurrent包里面的接口和工具类，比如ListenableFuture、Futures等，具体实例网上有很多的说明，请大家自行安利，这里就不做赘述了。</p>
<h1 id="6-异常不监控"><a href="#6-异常不监控" class="headerlink" title="6.异常不监控"></a>6.异常不监控</h1><p>当系统抛出异常被捕获后，很多同学只是通过日志记录了一下异常信息，但是并没有通过监控系统记录异常。这样带来的隐患就是我们没法在第一时间感知系统异常，只能是影响到其他监控了才会有所体现，但这样就只能靠运气了。如果被影响的监控比较敏感，或许很快就会有告警；但是如果被影响的监控不敏感，或者压根没开告警，那么你就呵呵了……</p>
<h1 id="7-堆外不清理"><a href="#7-堆外不清理" class="headerlink" title="7.堆外不清理"></a>7.堆外不清理</h1><p>在某些业务场景下，我们可能需要使用DirectByteBuffer分配字节缓冲区，或者使用MappedByteBuffer做内存映射，那么我们不可避免地需要使用堆外内存。DirectByteBuffer对象在创建过程中会先通过Unsafe接口直接通过os::malloc来分配内存，然后将内存的起始地址和大小存到DirectByteBuffer对象里，这样就可以直接操作这些内存。我们dump内存时可能会发现DirectByteBuffer对象很小，但是其实它后面可能关联了一个非常大的堆外内存，因此我们通常称之为“冰山对象”。这些内存只有在DirectByteBuffer回收掉之后才有机会被回收，因此如果这些对象大部分都移到了old，但是一直没有触发CMS GC或者Full GC，那么悲剧将会发生，因为你的物理内存被他们耗尽了，因此为了避免这种悲剧的发生，通过-XX:MaxDirectMemorySize来指定最大的堆外内存大小，当使用达到了阈值的时候将调用System.gc来做一次full gc，以此来回收掉没有被使用的堆外内存。</p>
<p>另外，当前我们的使用的服务框架、第三方组件，很多都是基于netty、mina这种NIO框架实现网络调用，而这些NIO框架基本都在使用堆外内存。而我们知道，堆外内存是无法通过JVM的垃圾回收器回收的，只能通过System.gc()来回收。但是很多同学在设置JVM参数的时候，往往选择拷贝已有的配置，而忽略了一个很重要的参数DisableExplicitGC，这个参数的意思是禁用显式GC，也就是使System.gc()失效。如果我们在jvm参数中配置了-XX:+DisableExplicitGC，那么带来的后果就是进入到老年代的堆外内存无法被回收掉，最终导致OOM。</p>
<p>至此，一日丧命散的其中毒虫就介绍完了。如果想要活得久，请远离这七条毒虫，哈哈。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://fengfu.io/2016/10/27/晋级Review归来话代码有毒/" data-id="cj5kohhee001i23x02g7y4nkq" class="article-share-link" data-share="baidu" data-title="晋级Review归来话代码有毒">分享到</a>
      

      
        <a href="http://fengfu.io/2016/10/27/晋级Review归来话代码有毒/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/杂谈/">杂谈</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/人生/">人生</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/商业/">商业</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微服务/">微服务</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能/">性能</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂谈/">杂谈</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a><span class="tag-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/人生/" style="font-size: 10px;">人生</a> <a href="/tags/商业/" style="font-size: 10px;">商业</a> <a href="/tags/微服务/" style="font-size: 12.5px;">微服务</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/杂谈/" style="font-size: 17.5px;">杂谈</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">二月 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/07/25/一个HashBasedTable引发的故障/">一个HashBasedTable引发的故障</a>
          </li>
        
          <li>
            <a href="/2017/06/13/Linux性能分析工具/">Linux性能分析工具</a>
          </li>
        
          <li>
            <a href="/2017/04/23/服务化架构-服务降级/">服务化架构-服务降级</a>
          </li>
        
          <li>
            <a href="/2017/04/11/使用JRebel远程热部署Class/">使用 jrebel 远程部署开发环境的 dubbo 服务</a>
          </li>
        
          <li>
            <a href="/2017/03/06/Spring Xml扩展机制/">Spring xml扩展机制</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://coolshell.cn" target="_blank">酷壳</a>
          </li>
        
          <li>
            <a href="http://ifeve.com" target="_blank">并发编程网</a>
          </li>
        
          <li>
            <a href="http://calvin1978.blogcn.com" target="_blank">花钱的年化</a>
          </li>
        
          <li>
            <a href="http://lovestblog.cn" target="_blank">你假笨</a>
          </li>
        
          <li>
            <a href="http://hellojava.info" target="_blank">hellojava</a>
          </li>
        
          <li>
            <a href="http://techblog.netflix.com" target="_blank">Netflix技术博客</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 宁静·致远<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"qufengfu"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js"></script>

</div>
</body>
</html>
