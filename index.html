<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="宁静·致远">
<meta property="og:url" content="http://fengfu.io/index.html">
<meta property="og:site_name" content="宁静·致远">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="宁静·致远">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://fengfu.io/"/>





  <title>宁静·致远</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">宁静·致远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-rss">
          <a href="/atom.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            RSS
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/12/08/使用SonarLint进行代码检查/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/08/使用SonarLint进行代码检查/" itemprop="url">使用SonarLint编写高质量代码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-08T18:40:25+08:00">
                2017-12-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/12/08/使用SonarLint进行代码检查/" class="leancloud_visitors" data-flag-title="使用SonarLint编写高质量代码">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Sonarqube是一个功能非常强大的代码质量检查、管理的工具。能够识别多种常用的编程语言，并能够通过设置不同的Rule<br>Sonar是一个代码质量管理的开源工具，它通过插件的形式能够识别常见的多种编程语言（例如Java, C#, PHP, Pythod等）代码质量问题。Sonar可以帮你分析出以下代码质量问题：<br>1.不遵循代码标准；<br>2.潜在的缺陷，比如空指针、bug；<br>3.代码重复；<br>4.注释率不足或过高；<br>5.糟糕的复杂度，比如if/循环嵌套太多、类/方法太大；<br>6.缺乏单元测试；</p>
<p>在公司中，一般是把SonarQube部署在服务器端，当开发人员提交代码时，Jenkins触发SonarQube进行代码检查，开发人员根据代码检查结果进行问题修复。但是这样，开发人员往往只会关注被阻断的代码问题，对于Sonar提示的设计、性能方面的问题往往视而不见。<br>所幸现在SonarSource开发了SonarLint插件，可以在IDE(Intellij Idea、Eclipse)中嵌入，这样开发人员不仅能使用SonarLint中内置的代码检查规则进行代码检查，也可以连接到远端服务器拉取远端规则。有了它，我们就可以在编写代码的过程中根据SonarLint的提示编写高质量代码了。</p>
<p>下面，将以Intellij Idea为基础介绍SonarLint插件的使用。</p>
<h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h2><p>在Idea的Plugins界面搜索“SonarLint”，在检索结果列表页找到对应的SonarLint，点击右侧的“Install”按钮，安装完毕重启Idea后即可完成插件的安装。</p>
<p><img src="https://farm5.staticflickr.com/4634/38195936814_d3318454b4_b.jpg" alt="安装插件"></p>
<h2 id="2-代码检查"><a href="#2-代码检查" class="headerlink" title="2. 代码检查"></a>2. 代码检查</h2><p>SonarLint插件安装后，就可以使用它对Idea中的项目进行代码检查了。SonarLint能够对单个文件、整个项目、从VCS（版本控制系统，比如git、svn等）拉取的被修改文件这3类进行检查。</p>
<p>开启SonarLint的检查有3个入口：</p>
<ol>
<li>Analyze-&gt;SonarLint，如下图：</li>
</ol>
<p><img src="https://farm5.staticflickr.com/4558/38195610794_c63be62dd8_b.jpg" alt=""></p>
<ol>
<li>在打开的文件编辑区域点击右键，在弹出的上下文菜单中选择，如下图：</li>
</ol>
<p><img src="https://farm5.staticflickr.com/4562/38875276892_7c0f79c2a4_z.jpg" alt=""></p>
<p>此方式只能对当前文件进行检查。</p>
<ol>
<li>编辑区底部的Panel，这里可以在”Current file” Tab区域对当前文件进行检查，也可以在“Project files”Tab区域对文件进行全量和从VCS（版本控制系统，比如git、svn等）拉取的被修改文件进行检查，如下图：</li>
</ol>
<p><img src="https://farm5.staticflickr.com/4519/38196120834_fa47b16e02_b.jpg" alt=""></p>
<p>执行代码检查后，在下面的SonarLint Panel区域就能显示代码检查的结果了：</p>
<p><img src="https://farm5.staticflickr.com/4566/38024453305_b355b33948_z.jpg" alt=""></p>
<h2 id="3-远程配置"><a href="#3-远程配置" class="headerlink" title="3. 远程配置"></a>3. 远程配置</h2><p>前面提到的代码检查，默认使用SonarLint内置的规则。我们也可以连接远端的SonarQube服务器，拉取服务器上配置的规则对代码进行检查，这样就能与代码提交时触发的检查规则保持一致了，具体方式如下：</p>
<ol>
<li>首先在下图的界面点击“+”创建新的SonarQube Server：</li>
</ol>
<p><img src="https://farm5.staticflickr.com/4557/38024453645_871bb2cd83.jpg" alt=""></p>
<ol>
<li>在New SonarQube Server界面中选择右侧的选项，并输入SonarQube URL，点击next：</li>
</ol>
<p><img src="https://farm5.staticflickr.com/4557/27134414809_a16b3fc406_b.jpg" alt=""></p>
<ol>
<li>在Authentication界面选择Login/Password，并输入用户名和密码：</li>
</ol>
<p><img src="https://farm5.staticflickr.com/4532/27134414729_f52684145d_b.jpg" alt=""></p>
<p>验证通过后点击Finish即可完成SonarQube Server的配置。</p>
<ol>
<li>在SonarLint界面选择Server中配置的project，要与当前项目一致，否则可能会拉取错误的规则配置。</li>
</ol>
<p><img src="https://farm5.staticflickr.com/4739/38875276722_f5b65063f0_b.jpg" alt=""></p>
<p>经过上面4步，你就可以通过SonarLint拉取的服务器上的代码规则进行代码检查了。Have fun:)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/11/29/Sonar自定义插件开发指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/29/Sonar自定义插件开发指南/" itemprop="url">Sonar自定义插件开发指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-29T17:13:16+08:00">
                2017-11-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/11/29/Sonar自定义插件开发指南/" class="leancloud_visitors" data-flag-title="Sonar自定义插件开发指南">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Sonar简介"><a href="#1-Sonar简介" class="headerlink" title="1 Sonar简介"></a>1 Sonar简介</h2><p>SonarQube是一个非常流行和强大的静态代码检查工具。它可以针对很多语言进行分析，比如Java、C#、JavaScript、PL/SQL等。SonarQube中默认提供了很多代码检查规则，但是有时候我们需要根据自己的需求编写规则，这篇文章会涵盖如何编写自定义规则的各个步骤。</p>
<h2 id="2-环境准备"><a href="#2-环境准备" class="headerlink" title="2 环境准备"></a>2 环境准备</h2><ul>
<li>JDK 1.8</li>
<li>Intellij Idea</li>
<li>Maven 3.x或更高</li>
<li>SonarQube LTS 5.6</li>
<li>Sonar-runner-dist 2.4</li>
</ul>
<h2 id="3-开发步骤"><a href="#3-开发步骤" class="headerlink" title="3 开发步骤"></a>3 开发步骤</h2><h3 id="3-1-创建Plugin项目"><a href="#3-1-创建Plugin项目" class="headerlink" title="3.1 创建Plugin项目"></a>3.1 创建Plugin项目</h3><p> 首先创建一个SonarPlugin项目，建议从SonarSource官方github站点下载模板项目，这样不至于遗漏配置。下载的地址是：<a href="https://github.com/SonarSource/sonar-custom-plugin-example" target="_blank" rel="external">下载链接</a></p>
<h3 id="3-2-引入Pom依赖"><a href="#3-2-引入Pom依赖" class="headerlink" title="3.2 引入Pom依赖"></a>3.2 引入Pom依赖</h3><p>将模板项目中的pom文件修改为自己项目对应的名称，比如groupId、artifactId、version、name、description，其他的不必修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;</div><div class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div class="line"></div><div class="line">    &lt;groupId&gt;com.qunar.sonar&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;qunar-java&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</div><div class="line">    &lt;packaging&gt;sonar-plugin&lt;/packaging&gt;</div><div class="line"></div><div class="line">    &lt;name&gt;Qunar SonarQube Java Rules&lt;/name&gt;</div><div class="line">    &lt;description&gt;Qunar Java Rules for SonarQube&lt;/description&gt;</div><div class="line">    &lt;inceptionYear&gt;2016&lt;/inceptionYear&gt;</div><div class="line"></div><div class="line">    &lt;properties&gt;</div><div class="line">        &lt;sonar.version&gt;6.3&lt;/sonar.version&gt; &lt;!-- this 6.3 is only required to be compliant with SonarLint and it is required</div><div class="line">			even if you just want to be compliant with SonarQube 5.6 --&gt;</div><div class="line">        &lt;java.plugin.version&gt;4.10.0.10260&lt;/java.plugin.version&gt;</div><div class="line">        &lt;sslr.version&gt;1.21&lt;/sslr.version&gt;</div><div class="line">        &lt;gson.version&gt;2.6.2&lt;/gson.version&gt;</div><div class="line">    &lt;/properties&gt;</div><div class="line"></div><div class="line">    &lt;dependencies&gt;</div><div class="line">        &lt;!--请不要调整下面三项依赖的顺序，避免查看依赖的类时无法查看源码--&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.sonarqube&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;sonar-plugin-api&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;sonar.version&#125;&lt;/version&gt;</div><div class="line">            &lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.java&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;java-frontend&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;java.plugin.version&#125;&lt;/version&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.java&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;sonar-java-plugin&lt;/artifactId&gt;</div><div class="line">            &lt;!--&lt;type&gt;sonar-plugin&lt;/type&gt;--&gt;</div><div class="line">            &lt;version&gt;$&#123;java.plugin.version&#125;&lt;/version&gt;</div><div class="line">            &lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">        &lt;!--请不要调整上述三项依赖的顺序，避免查看依赖的类时无法查看源码--&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.sslr-squid-bridge&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;sslr-squid-bridge&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;2.6.1&lt;/version&gt;</div><div class="line">            &lt;exclusions&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.codehaus.sonar.sslr&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;sslr-core&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.codehaus.sonar&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;sonar-plugin-api&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.codehaus.sonar.sslr&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;sslr-xpath&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">                &lt;exclusion&gt;</div><div class="line">                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">                    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</div><div class="line">                &lt;/exclusion&gt;</div><div class="line">            &lt;/exclusions&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.java&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;java-checks-testkit&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;java.plugin.version&#125;&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;gson&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;gson.version&#125;&lt;/version&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.sonarsource.sslr&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;sslr-testing-harness&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;$&#123;sslr.version&#125;&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;1.6.2&lt;/version&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line"></div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;4.11&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.assertj&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;assertj-core&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;3.6.2&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;</div><div class="line">            &lt;version&gt;0.9.30&lt;/version&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">    &lt;/dependencies&gt;</div><div class="line"></div><div class="line">    &lt;build&gt;</div><div class="line">        &lt;plugins&gt;</div><div class="line">            &lt;plugin&gt;</div><div class="line">                &lt;groupId&gt;org.sonarsource.sonar-packaging-maven-plugin&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;sonar-packaging-maven-plugin&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;1.17&lt;/version&gt;</div><div class="line">                &lt;extensions&gt;true&lt;/extensions&gt;</div><div class="line">                &lt;configuration&gt;</div><div class="line">                    &lt;pluginKey&gt;qunar-java&lt;/pluginKey&gt;</div><div class="line">                    &lt;pluginName&gt;QunarJava&lt;/pluginName&gt;</div><div class="line">                    &lt;pluginClass&gt;com.qunar.sonar.java.JavaRulesPlugin&lt;/pluginClass&gt;</div><div class="line">                    &lt;sonarLintSupported&gt;true&lt;/sonarLintSupported&gt;</div><div class="line">                    &lt;sonarQubeMinVersion&gt;5.6&lt;/sonarQubeMinVersion&gt; &lt;!-- allow to depend on API 6.x but run on LTS --&gt;</div><div class="line">                &lt;/configuration&gt;</div><div class="line">            &lt;/plugin&gt;</div><div class="line"></div><div class="line">            &lt;plugin&gt;</div><div class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;3.6.0&lt;/version&gt;</div><div class="line">                &lt;configuration&gt;</div><div class="line">                    &lt;source&gt;1.8&lt;/source&gt;</div><div class="line">                    &lt;target&gt;1.8&lt;/target&gt;</div><div class="line">                &lt;/configuration&gt;</div><div class="line">            &lt;/plugin&gt;</div><div class="line"></div><div class="line">            &lt;!-- only required to run UT - these are UT dependencies --&gt;</div><div class="line">            &lt;plugin&gt;</div><div class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;2.10&lt;/version&gt;</div><div class="line">                &lt;executions&gt;</div><div class="line">                    &lt;execution&gt;</div><div class="line">                        &lt;id&gt;copy&lt;/id&gt;</div><div class="line">                        &lt;phase&gt;test-compile&lt;/phase&gt;</div><div class="line">                        &lt;goals&gt;</div><div class="line">                            &lt;goal&gt;copy&lt;/goal&gt;</div><div class="line">                        &lt;/goals&gt;</div><div class="line">                        &lt;configuration&gt;</div><div class="line">                            &lt;artifactItems&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.0&lt;/version&gt;</div><div class="line">                                    &lt;type&gt;jar&lt;/type&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;javax&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;javaee-api&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;6.0&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.3.3.RELEASE&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.3.3.RELEASE&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;spring-web&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.3.3.RELEASE&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                                &lt;artifactItem&gt;</div><div class="line">                                    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">                                    &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</div><div class="line">                                    &lt;version&gt;4.3.3.RELEASE&lt;/version&gt;</div><div class="line">                                &lt;/artifactItem&gt;</div><div class="line">                            &lt;/artifactItems&gt;</div><div class="line">                            &lt;outputDirectory&gt;$&#123;project.build.directory&#125;/test-jars&lt;/outputDirectory&gt;</div><div class="line">                        &lt;/configuration&gt;</div><div class="line">                    &lt;/execution&gt;</div><div class="line">                &lt;/executions&gt;</div><div class="line">            &lt;/plugin&gt;</div><div class="line">        &lt;/plugins&gt;</div><div class="line">    &lt;/build&gt;</div><div class="line"></div><div class="line">&lt;/project&gt;</div></pre></td></tr></table></figure>
<h3 id="3-3-编写具体的Rule"><a href="#3-3-编写具体的Rule" class="headerlink" title="3.3 编写具体的Rule"></a>3.3 编写具体的Rule</h3><p>一个自定义规则的实现，首先在规则类前面使用@Rule注解声明规则的相关信息，比如key、name、description、priority、tag。其次要继承IssuableSubscriptionVisitor或者继承BaseTreeVisitor并实现JavaFileScanner接口，这两种实现方式存在一些差异，IssuableSubscriptionVisitor是一个抽象类，继承自SubscriptionVisitor，而SubscriptionVisitor则实现了JavaFileScanner接口；而BaseTreeVisitor则是实现了TreeVisitor接口。相比来说，JavaFileScanner更偏底层一些，直接是面向Java文件的分析，而TreeVisitor则是针对于Java文件的语法结构了，比如类、防止、赋值语句、catch块之类的了。一般情况下，推荐使用继承IssuableSubscriptionVisitor的方式，因为这个类的封装层次更高，更简便。在规则类中，你只需要重载nodesToVisit和visitNode方法就可以了。<br>nodesToVisit方法是说明该规则做检查的类型集合，比如METHOD_INVOCATION（方法调用）、CATCH（catch块）、MEMBER_SELECT（属性选择）等。比如下面的代码，就是对源码中的方法调用做规则检查。<br>visitNode是自定义规则中的核心部分，你所要实现的代码检查逻辑就是在这个方法中完成的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">import com.google.common.collect.ImmutableList;</div><div class="line">import com.qunar.sonar.java.util.QualifiedNameUtil;</div><div class="line">import org.sonar.check.Priority;</div><div class="line">import org.sonar.check.Rule;</div><div class="line">import org.sonar.plugins.java.api.IssuableSubscriptionVisitor;</div><div class="line">import org.sonar.plugins.java.api.tree.MethodInvocationTree;</div><div class="line">import org.sonar.plugins.java.api.tree.Tree;</div><div class="line"></div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by fengfu on 2017/11/10.</div><div class="line"> */</div><div class="line">@Rule(</div><div class="line">        key = &quot;DisallowedFDUsageCheck&quot;,</div><div class="line">        name = &quot;Qunar Flight disallowed FD usage in InfoCenter check&quot;,</div><div class="line">        description = &quot;Some kinds of usage for FD are forbidden in Flight BU of Qunar.com.&quot;,</div><div class="line">        priority = Priority.BLOCKER,</div><div class="line">        tags = &#123;&quot;bug&quot;&#125;</div><div class="line">)</div><div class="line">public class DisallowedFDUsageCheck extends IssuableSubscriptionVisitor &#123;</div><div class="line">    private static final String[] FORBIDDEN_METHODS = &#123;</div><div class="line">            &quot;Infocenter.reloadFDData&quot;, &quot;Infocenter.getFliterDateFDData&quot;,</div><div class="line">            &quot;Infocenter.getFDData&quot;, &quot;Infocenter.getValidFDPrice&quot;,</div><div class="line">            &quot;Infocenter.getFDPrice&quot;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public List&lt;Tree.Kind&gt; nodesToVisit() &#123;</div><div class="line">        return ImmutableList.of(Tree.Kind.METHOD_INVOCATION);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void visitNode(Tree tree) &#123;</div><div class="line">        MethodInvocationTree mTree = (MethodInvocationTree)tree;</div><div class="line">        String methodName = QualifiedNameUtil.fullQualifiedName(mTree.methodSelect());</div><div class="line"></div><div class="line">        if (isForbiddenMethod(methodName))&#123;</div><div class="line">            reportIssue(tree, methodName + &quot;已被禁用，详情请查看Wiki:http://wiki.corp.qunar.com/confluence/pages/viewpage.action?pageId=182623492&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        super.visitNode(tree);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static boolean isForbiddenMethod(String methodName) &#123;</div><div class="line">        for (String name : FORBIDDEN_METHODS) &#123;</div><div class="line">            if (name.equals(methodName)) &#123;</div><div class="line">                return true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void leaveNode(Tree tree) &#123;</div><div class="line">        super.leaveNode(tree);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然如果一些复杂的业务规则，可能你不得不实现JavaFileScanner接口了。如下面的代码所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">import com.qunar.sonar.java.util.QualifiedNameUtil;</div><div class="line">import org.sonar.api.utils.log.Logger;</div><div class="line">import org.sonar.api.utils.log.Loggers;</div><div class="line">import org.sonar.check.Priority;</div><div class="line">import org.sonar.check.Rule;</div><div class="line">import org.sonar.plugins.java.api.JavaFileScanner;</div><div class="line">import org.sonar.plugins.java.api.JavaFileScannerContext;</div><div class="line">import org.sonar.plugins.java.api.tree.*;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by fengfu on 2017/2/27.</div><div class="line"> */</div><div class="line">@Rule(</div><div class="line">        key = &quot;QunarFlightDisallowedClassCheck&quot;,</div><div class="line">        name = &quot;Qunar Flight disallowed class check&quot;,</div><div class="line">        description = &quot;Some classes are forbidden in Flight BU of Qunar.com.&quot;,</div><div class="line">        priority = Priority.BLOCKER,</div><div class="line">        tags = &#123;&quot;bug&quot;&#125;</div><div class="line">)</div><div class="line">public class DisallowedClassCheck extends BaseTreeVisitor implements JavaFileScanner &#123;</div><div class="line">    private static Logger logger = Loggers.get(DisallowedClassCheck.class);</div><div class="line">    private final String IMPORT_NAME = &quot;com.qunar.base.meerkat.monitor.QMonitor&quot;;</div><div class="line"></div><div class="line">    public void scanFile(JavaFileScannerContext context) &#123;</div><div class="line">        logger.info(&quot;Start to scan file &#123;&#125;&quot;, context.getFile().getName());</div><div class="line">        CompilationUnitTree cut = context.getTree();</div><div class="line"></div><div class="line">        for (ImportClauseTree importClauseTree : cut.imports())&#123;</div><div class="line">            ImportTree importTree = null;</div><div class="line">            if (importClauseTree.is(Tree.Kind.IMPORT)) &#123;</div><div class="line">                importTree = (ImportTree) importClauseTree;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (importTree == null || importTree.isStatic()) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            String importName = QualifiedNameUtil.fullQualifiedName(importTree.qualifiedIdentifier());</div><div class="line"></div><div class="line">            if (IMPORT_NAME.equals(importName))&#123;</div><div class="line">                logger.error(&quot;Disallowed class &#123;&#125; found.&quot;, IMPORT_NAME);</div><div class="line">                context.reportIssue(this, importTree, IMPORT_NAME + &quot;已被禁用.&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        scan(cut);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-4-单元测试"><a href="#3-4-单元测试" class="headerlink" title="3.4 单元测试"></a>3.4 单元测试</h3><p>规则检查代码写完之后，就可以针对这个规则进行单元测试了。单元测试的方法比较简单，就是使用JUnit框架编写test case，针对特定的目标文件，调用Sonar提供的JavaCheckVerifier.verify方法进行测试，示例代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import com.qunar.flight.sonar.java.checks.DisallowedClassCheck;</div><div class="line">import org.junit.Test;</div><div class="line">import org.sonar.java.checks.verifier.JavaCheckVerifier;</div><div class="line"></div><div class="line">public class DisallowedClassCheckTest &#123;</div><div class="line">    @Test</div><div class="line">    public void test() &#123;</div><div class="line">        JavaCheckVerifier.verify(&quot;src/test/files/flight/DisallowedClassCase.java&quot;, new DisallowedClassCheck());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果目标文件存在问题，那么控制台会打印出问题在目标文件中的位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">java.lang.AssertionError: Unexpected at [4]</div><div class="line"></div><div class="line">	at org.sonar.java.checks.verifier.CheckVerifier.assertMultipleIssue(CheckVerifier.java:209)</div><div class="line">	at org.sonar.java.checks.verifier.CheckVerifier.checkIssues(CheckVerifier.java:181)</div><div class="line">	at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:274)</div><div class="line">	at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:256)</div><div class="line">	at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:222)</div><div class="line">	at org.sonar.java.checks.verifier.JavaCheckVerifier.verify(JavaCheckVerifier.java:105)</div><div class="line">	at com.qunar.flight.sonar.java.checks.test.DisallowedClassCheckTest.test(DisallowedClassCheckTest.java:10)</div></pre></td></tr></table></figure></p>
<p>如果目标文件中不存在任何问题，会提示“java.lang.IllegalStateException: At least one issue expected”，意思就是目标文件中需要至少存在一个规则所要检查的问题。</p>
<h3 id="3-5-编写RulesList"><a href="#3-5-编写RulesList" class="headerlink" title="3.5 编写RulesList"></a>3.5 编写RulesList</h3><p>单元测试完成之后，就可以往RuleList的集合中中添加自定义规则规则了。这个RuleList只是一个简单的集合类，包含了所有你需要注册到Sonar中的规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">import com.google.common.collect.ImmutableList;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">import com.qunar.flight.sonar.java.checks.DisallowedClassCheck;</div><div class="line">import com.qunar.flight.sonar.java.checks.DisallowedFDUsageCheck;</div><div class="line">import com.qunar.flight.sonar.java.checks.GuavaCacheLoaderReturnNullCheck;</div><div class="line">import org.sonar.plugins.java.api.JavaCheck;</div><div class="line"></div><div class="line">public final class RulesList &#123;</div><div class="line"></div><div class="line">  private RulesList() &#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public static List&lt;Class&gt; getChecks() &#123;</div><div class="line">    return ImmutableList.&lt;Class&gt;builder().addAll(getJavaChecks()).addAll(getJavaTestChecks()).build();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 在此方法中添加需要注册的规则</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">  public static List&lt;Class&lt;? extends JavaCheck&gt;&gt; getJavaChecks() &#123;</div><div class="line">    return ImmutableList.&lt;Class&lt;? extends JavaCheck&gt;&gt;builder()</div><div class="line">      .add(DisallowedClassCheck.class)</div><div class="line">      .add(GuavaCacheLoaderReturnNullCheck.class)</div><div class="line">      .add(DisallowedFDUsageCheck.class)</div><div class="line"></div><div class="line">      .build();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public static List&lt;Class&lt;? extends JavaCheck&gt;&gt; getJavaTestChecks() &#123;</div><div class="line">    return ImmutableList.&lt;Class&lt;? extends JavaCheck&gt;&gt;builder()</div><div class="line">      .build();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-6-编写CustomRulesDefinition"><a href="#3-6-编写CustomRulesDefinition" class="headerlink" title="3.6 编写CustomRulesDefinition"></a>3.6 编写CustomRulesDefinition</h3><p>CustomRulesDefinition可以理解为自定义规则集的元数据，在这个类中，首先要声明自定义规则集的repository，另外还需要将相应的规则集加入到前面声明的repository中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line">mport com.google.common.annotations.VisibleForTesting;</div><div class="line">import com.google.common.collect.Iterables;</div><div class="line">import com.google.common.io.Resources;</div><div class="line">import com.google.gson.Gson;</div><div class="line">import org.apache.commons.lang.StringUtils;</div><div class="line">import org.sonar.api.rule.RuleStatus;</div><div class="line">import org.sonar.api.rules.RuleType;</div><div class="line">import org.sonar.api.server.debt.DebtRemediationFunction;</div><div class="line">import org.sonar.api.server.rule.RulesDefinition;</div><div class="line">import org.sonar.api.server.rule.RulesDefinitionAnnotationLoader;</div><div class="line">import org.sonar.api.utils.AnnotationUtils;</div><div class="line">import org.sonar.check.Cardinality;</div><div class="line">import org.sonar.squidbridge.annotations.RuleTemplate;</div><div class="line"></div><div class="line">import javax.annotation.Nullable;</div><div class="line">import java.io.IOException;</div><div class="line">import java.net.URL;</div><div class="line">import java.nio.charset.StandardCharsets;</div><div class="line">import org.sonar.plugins.java.Java;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Locale;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Declare rule metadata in server repository of rules.</div><div class="line"> * That allows to list the rules in the page &quot;Rules&quot;.</div><div class="line"> */</div><div class="line">public class JavaRulesDefinition implements RulesDefinition &#123;</div><div class="line"></div><div class="line">    // don&apos;t change that because the path is hard coded in CheckVerifier</div><div class="line">    private static final String RESOURCE_BASE_PATH = &quot;/org/sonar/l10n/java/rules/squid&quot;;</div><div class="line"></div><div class="line">    public static final String REPOSITORY_KEY = &quot;qunar-java&quot;;</div><div class="line"></div><div class="line">    private final Gson gson = new Gson();</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void define(Context context) &#123;</div><div class="line">        NewRepository repository = context</div><div class="line">                .createRepository(REPOSITORY_KEY, Java.KEY)//定义Repository key</div><div class="line">                .setName(&quot;QunarJava&quot;);//定义Repository名称</div><div class="line"></div><div class="line">        List&lt;Class&gt; checks = RulesList.getChecks();//获取自定义的check列表</div><div class="line">        new RulesDefinitionAnnotationLoader().load(repository, Iterables.toArray(checks, Class.class));//获取注解信息</div><div class="line"></div><div class="line">        for (Class ruleClass : checks) &#123;</div><div class="line">            newRule(ruleClass, repository);//将规则添加到Repository中</div><div class="line">        &#125;</div><div class="line">        repository.done();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @VisibleForTesting</div><div class="line">    protected void newRule(Class&lt;?&gt; ruleClass, NewRepository repository) &#123;</div><div class="line"></div><div class="line">        org.sonar.check.Rule ruleAnnotation = AnnotationUtils.getAnnotation(ruleClass, org.sonar.check.Rule.class);</div><div class="line">        if (ruleAnnotation == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;No Rule annotation was found on &quot; + ruleClass);</div><div class="line">        &#125;</div><div class="line">        String ruleKey = ruleAnnotation.key();</div><div class="line">        if (StringUtils.isEmpty(ruleKey)) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;No key is defined in Rule annotation of &quot; + ruleClass);</div><div class="line">        &#125;</div><div class="line">        NewRule rule = repository.rule(ruleKey);</div><div class="line">        if (rule == null) &#123;</div><div class="line">            throw new IllegalStateException(&quot;No rule was created for &quot; + ruleClass + &quot; in &quot; + repository.key());</div><div class="line">        &#125;</div><div class="line">        ruleMetadata(ruleClass, rule);</div><div class="line"></div><div class="line">        rule.setTemplate(AnnotationUtils.getAnnotation(ruleClass, RuleTemplate.class) != null);</div><div class="line">        if (ruleAnnotation.cardinality() == Cardinality.MULTIPLE) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;Cardinality is not supported, use the RuleTemplate annotation instead for &quot; + ruleClass);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private String ruleMetadata(Class&lt;?&gt; ruleClass, NewRule rule) &#123;</div><div class="line">        String metadataKey = rule.key();</div><div class="line">        org.sonar.java.RspecKey rspecKeyAnnotation = AnnotationUtils.getAnnotation(ruleClass, org.sonar.java.RspecKey.class);</div><div class="line">        if (rspecKeyAnnotation != null) &#123;</div><div class="line">            metadataKey = rspecKeyAnnotation.value();</div><div class="line">            rule.setInternalKey(metadataKey);</div><div class="line">        &#125;</div><div class="line">        addHtmlDescription(rule, metadataKey);</div><div class="line">        addMetadata(rule, metadataKey);</div><div class="line">        return metadataKey;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void addMetadata(NewRule rule, String metadataKey) &#123;</div><div class="line">        URL resource = JavaRulesDefinition.class.getResource(RESOURCE_BASE_PATH + &quot;/&quot; + metadataKey + &quot;_java.json&quot;);</div><div class="line">        if (resource != null) &#123;</div><div class="line">            RuleMetatada metatada = gson.fromJson(readResource(resource), RuleMetatada.class);</div><div class="line">            rule.setSeverity(metatada.defaultSeverity.toUpperCase(Locale.US));</div><div class="line">            rule.setName(metatada.title);</div><div class="line">            rule.addTags(metatada.tags);</div><div class="line">            rule.setType(RuleType.valueOf(metatada.type));</div><div class="line">            rule.setStatus(RuleStatus.valueOf(metatada.status.toUpperCase(Locale.US)));</div><div class="line">            if (metatada.remediation != null) &#123;</div><div class="line">                rule.setDebtRemediationFunction(metatada.remediation.remediationFunction(rule.debtRemediationFunctions()));</div><div class="line">                rule.setGapDescription(metatada.remediation.linearDesc);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static void addHtmlDescription(NewRule rule, String metadataKey) &#123;</div><div class="line">        URL resource = JavaRulesDefinition.class.getResource(RESOURCE_BASE_PATH + &quot;/&quot; + metadataKey + &quot;_java.html&quot;);</div><div class="line">        if (resource != null) &#123;</div><div class="line">            rule.setHtmlDescription(readResource(resource));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static String readResource(URL resource) &#123;</div><div class="line">        try &#123;</div><div class="line">            return Resources.toString(resource, StandardCharsets.UTF_8);</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            throw new IllegalStateException(&quot;Failed to read: &quot; + resource, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static class RuleMetatada &#123;</div><div class="line">        String title;</div><div class="line">        String status;</div><div class="line">        @Nullable</div><div class="line">        Remediation remediation;</div><div class="line"></div><div class="line">        String type;</div><div class="line">        String[] tags;</div><div class="line">        String defaultSeverity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static class Remediation &#123;</div><div class="line">        String func;</div><div class="line">        String constantCost;</div><div class="line">        String linearDesc;</div><div class="line">        String linearOffset;</div><div class="line">        String linearFactor;</div><div class="line"></div><div class="line">        public DebtRemediationFunction remediationFunction(DebtRemediationFunctions drf) &#123;</div><div class="line">            if (func.startsWith(&quot;Constant&quot;)) &#123;</div><div class="line">                return drf.constantPerIssue(constantCost.replace(&quot;mn&quot;, &quot;min&quot;));</div><div class="line">            &#125;</div><div class="line">            if (&quot;Linear&quot;.equals(func)) &#123;</div><div class="line">                return drf.linear(linearFactor.replace(&quot;mn&quot;, &quot;min&quot;));</div><div class="line">            &#125;</div><div class="line">            return drf.linearWithOffset(linearFactor.replace(&quot;mn&quot;, &quot;min&quot;), linearOffset.replace(&quot;mn&quot;, &quot;min&quot;));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-7-编写CustomJavaFileCheckRegistrar"><a href="#3-7-编写CustomJavaFileCheckRegistrar" class="headerlink" title="3.7 编写CustomJavaFileCheckRegistrar"></a>3.7 编写CustomJavaFileCheckRegistrar</h3><p>CustomJavaFileCheckRegistrar要实现CheckRegistrar接口。CustomJavaFileCheckRegistrar类的作用是注册代码扫描时需要的规则类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">import java.util.List;</div><div class="line">import org.sonar.plugins.java.api.CheckRegistrar;</div><div class="line">import org.sonar.plugins.java.api.JavaCheck;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Provide the &quot;checks&quot; (implementations of rules) classes that are going be executed during</div><div class="line"> * source code analysis.</div><div class="line"> *</div><div class="line"> * This class is a batch extension by implementing the &#123;@link org.sonar.plugins.java.api.CheckRegistrar&#125; interface.</div><div class="line"> */</div><div class="line">public class JavaFileCheckRegistrar implements CheckRegistrar &#123;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Register the classes that will be used to instantiate checks during analysis.</div><div class="line">   */</div><div class="line">  @Override</div><div class="line">  public void register(RegistrarContext registrarContext) &#123;</div><div class="line">    // Call to registerClassesForRepository to associate the classes with the correct repository key</div><div class="line">    registrarContext.registerClassesForRepository(JavaRulesDefinition.REPOSITORY_KEY, checkClasses(), testCheckClasses());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Lists all the main checks provided by the plugin</div><div class="line">   */</div><div class="line">  public static List&lt;Class&lt;? extends JavaCheck&gt;&gt; checkClasses() &#123;</div><div class="line">    return RulesList.getJavaChecks();//返回RulesList中定义的checks</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Lists all the test checks provided by the plugin</div><div class="line">   */</div><div class="line">  public static List&lt;Class&lt;? extends JavaCheck&gt;&gt; testCheckClasses() &#123;</div><div class="line">    return RulesList.getJavaTestChecks();//返回RulesList中定义的check classes</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-8-编写CustomJavaRulesPlugin"><a href="#3-8-编写CustomJavaRulesPlugin" class="headerlink" title="3.8 编写CustomJavaRulesPlugin"></a>3.8 编写CustomJavaRulesPlugin</h3><p>这个类是Sonar插件的入口，它继承了org.sonar.api.SonarPlugin类，包含了SonarQube启动时需要实例化的server扩展（CustomRulesDefinition）和代码分析时需要实例化的批量扩展（JavaFileCheckRegistrar）。</p>
<p>这个类基本不需要修改（除包名外），按照以下内容copy一份即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">import org.sonar.api.Plugin;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Entry point of your plugin containing your custom rules</div><div class="line"> */</div><div class="line">public class JavaRulesPlugin implements Plugin &#123;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public void define(Context context) &#123;</div><div class="line"></div><div class="line">    // server extensions -&gt; objects are instantiated during server startup</div><div class="line">    context.addExtension(CustomRulesDefinition.class);</div><div class="line"></div><div class="line">    // batch extensions -&gt; objects are instantiated during code analysis</div><div class="line">    context.addExtension(CustomJavaFileCheckRegistrar.class);</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，一个Sonar自定义插件所需的代码工作就结束了。剩下的就是进行整合性的测试，毕竟单元测试通过不代表插件不会对现有系统造成影响，有时候插件中的错误会导致SonarQube启动失败的。</p>
<h2 id="5-整合测试"><a href="#5-整合测试" class="headerlink" title="5 整合测试"></a>5 整合测试</h2><p>通过mvn package命令编译、打包，形成jar文件。将jar文件上传到SonarQube extensions/plugins目录下，重启SonarQube服务即可完成Sonar自定义规则插件的部署。部署结束，通过SonarQube bin目录下的脚本重启SonarQube，如果SonarQube启动成功，说明插件没问题，整合测试成功，你可以在sonar的rules模块中，搜索到自定义的规则了。</p>
<p><img src="https://farm5.staticflickr.com/4566/38001442235_a562e60306.jpg" alt=""></p>
<h2 id="6-启用规则"><a href="#6-启用规则" class="headerlink" title="6 启用规则"></a>6 启用规则</h2><p>插件部署到SonarQube之后，默认是不启用的，需要在SonarQube的管理界面中启用规则，才能让此规则在代码检查过程中生效。</p>
<p><img src="https://farm5.staticflickr.com/4524/38888239671_35af64c4bf.jpg" alt=""></p>
<p>至此，Sonar插件开发的流程就介绍完了。如前面所言，SonarQube是个强大的代码检查工具，一篇文章是无法介绍完的，尤其Sonar的语法树部分，涵盖了各种语言各种语法的方方面面，大家可以通过Sonar的<a href="https://docs.sonarqube.org/display/SONAR/" target="_blank" rel="external">官方文档</a>了解更多的细节。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/11/14/git命令大全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/14/git命令大全/" itemprop="url">git命令大全</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-14T16:58:24+08:00">
                2017-11-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/11/14/git命令大全/" class="leancloud_visitors" data-flag-title="git命令大全">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">git init</td>
<td style="text-align:left">初始化本地git仓库（创建新仓库）</td>
</tr>
<tr>
<td style="text-align:left">git config –global user.name “xxx”</td>
<td style="text-align:left">配置用户名</td>
</tr>
<tr>
<td style="text-align:left">git config –global user.email “xxx@xxx.com”</td>
<td style="text-align:left">配置邮件</td>
</tr>
<tr>
<td style="text-align:left">git config –global color.ui true</td>
<td style="text-align:left">git status等命令自动着色</td>
</tr>
<tr>
<td style="text-align:left">git config –global color.status auto</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git config –global color.diff auto</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git config –global color.branch auto</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git config –global color.interactive auto</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git config –global –unset http.proxy</td>
<td style="text-align:left">remove  proxy configuration on git</td>
</tr>
<tr>
<td style="text-align:left">git clone git+ssh://git@192.168.53.168/VT.</td>
<td style="text-align:left">clone远程仓库</td>
</tr>
<tr>
<td style="text-align:left">git status</td>
<td style="text-align:left">查看当前版本状态（是否修改）</td>
</tr>
<tr>
<td style="text-align:left">git add xyz</td>
<td style="text-align:left">添加xyz文件至index</td>
</tr>
<tr>
<td style="text-align:left">git add .</td>
<td style="text-align:left">增加当前子目录下所有更改过的文件至index</td>
</tr>
<tr>
<td style="text-align:left">git commit -m ‘xxx’</td>
<td style="text-align:left">提交</td>
</tr>
<tr>
<td style="text-align:left">git commit –amend -m ‘xxx’</td>
<td style="text-align:left">合并上一次提交（用于反复修改）</td>
</tr>
<tr>
<td style="text-align:left">git commit -am ‘xxx’</td>
<td style="text-align:left">将add和commit合为一步</td>
</tr>
<tr>
<td style="text-align:left">git rm xxx</td>
<td style="text-align:left">删除index中的文件</td>
</tr>
<tr>
<td style="text-align:left">git rm -r *</td>
<td style="text-align:left">递归删除</td>
</tr>
<tr>
<td style="text-align:left">git log</td>
<td style="text-align:left">显示提交日志</td>
</tr>
<tr>
<td style="text-align:left">git log -1</td>
<td style="text-align:left">显示1行日志 -n为n行</td>
</tr>
<tr>
<td style="text-align:left">git log -5</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git log –stat</td>
<td style="text-align:left">显示提交日志及相关变动文件</td>
</tr>
<tr>
<td style="text-align:left">git log -p -m</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git show dfb02e6e4f2f7b573337763e5c0013802e392818</td>
<td style="text-align:left">显示某个提交的详细内容</td>
</tr>
<tr>
<td style="text-align:left">git show dfb02</td>
<td style="text-align:left">可只用commitid的前几位</td>
</tr>
<tr>
<td style="text-align:left">git show HEAD</td>
<td style="text-align:left">显示HEAD提交日志</td>
</tr>
<tr>
<td style="text-align:left">git show HEAD^</td>
<td style="text-align:left">显示HEAD的父（上一个版本）的提交日志 ^^为上两个版本 ^5为上5个版本</td>
</tr>
<tr>
<td style="text-align:left">git tag</td>
<td style="text-align:left">显示已存在的tag</td>
</tr>
<tr>
<td style="text-align:left">git tag -a v2.0 -m ‘xxx’</td>
<td style="text-align:left">增加v2.0的tag</td>
</tr>
<tr>
<td style="text-align:left">git show v2.0</td>
<td style="text-align:left">显示v2.0的日志及详细内容</td>
</tr>
<tr>
<td style="text-align:left">git log v2.0</td>
<td style="text-align:left">显示v2.0的日志</td>
</tr>
<tr>
<td style="text-align:left">git diff</td>
<td style="text-align:left">显示所有未添加至index的变更</td>
</tr>
<tr>
<td style="text-align:left">git diff –cached</td>
<td style="text-align:left">显示所有已添加index但还未commit的变更</td>
</tr>
<tr>
<td style="text-align:left">git diff HEAD^</td>
<td style="text-align:left">比较与上一个版本的差异</td>
</tr>
<tr>
<td style="text-align:left">git diff HEAD – ./lib</td>
<td style="text-align:left">比较与HEAD版本lib目录的差异</td>
</tr>
<tr>
<td style="text-align:left">git diff origin/master..master</td>
<td style="text-align:left">比较远程分支master上有本地分支master上没有的</td>
</tr>
<tr>
<td style="text-align:left">git diff origin/master..master –stat</td>
<td style="text-align:left">只显示差异的文件，不显示具体内容</td>
</tr>
<tr>
<td style="text-align:left">git remote add origin git+ssh://git@192.168.53.168/VT.</td>
<td style="text-align:left">增加远程定义（用于push/pull/fetch）</td>
</tr>
<tr>
<td style="text-align:left">git branch</td>
<td style="text-align:left">显示本地分支</td>
</tr>
<tr>
<td style="text-align:left">git branch –contains 50089</td>
<td style="text-align:left">显示包含提交50089的分支</td>
</tr>
<tr>
<td style="text-align:left">git branch -a</td>
<td style="text-align:left">显示所有分支</td>
</tr>
<tr>
<td style="text-align:left">git branch -r</td>
<td style="text-align:left">显示所有原创分支</td>
</tr>
<tr>
<td style="text-align:left">git branch –merged</td>
<td style="text-align:left">显示所有已合并到当前分支的分支</td>
</tr>
<tr>
<td style="text-align:left">git branch –no-merged</td>
<td style="text-align:left">显示所有未合并到当前分支的分支</td>
</tr>
<tr>
<td style="text-align:left">git branch -m master master_copy</td>
<td style="text-align:left">本地分支改名</td>
</tr>
<tr>
<td style="text-align:left">git checkout -b master_copy</td>
<td style="text-align:left">从当前分支创建新分支master_copy并检出</td>
</tr>
<tr>
<td style="text-align:left">git checkout -b master master_copy</td>
<td style="text-align:left">上面的完整版</td>
</tr>
<tr>
<td style="text-align:left">git checkout features/performance</td>
<td style="text-align:left">检出已存在的features/performance分支</td>
</tr>
<tr>
<td style="text-align:left">git checkout –track hotfixes/BJVEP933</td>
<td style="text-align:left">检出远程分支hotfixes/BJVEP933并创建本地跟踪分支</td>
</tr>
<tr>
<td style="text-align:left">git checkout v2.0</td>
<td style="text-align:left">检出版本v2.0</td>
</tr>
<tr>
<td style="text-align:left">git checkout -b devel origin/develop</td>
<td style="text-align:left">从远程分支develop创建新本地分支devel并检出</td>
</tr>
<tr>
<td style="text-align:left">git checkout – README</td>
<td style="text-align:left">检出head版本的README文件（可用于修改错误回退）</td>
</tr>
<tr>
<td style="text-align:left">git merge origin/master</td>
<td style="text-align:left">合并远程master分支至当前分支</td>
</tr>
<tr>
<td style="text-align:left">git cherry-pick ff44785404a8e</td>
<td style="text-align:left">合并提交ff44785404a8e的修改</td>
</tr>
<tr>
<td style="text-align:left">git push origin master</td>
<td style="text-align:left">将当前分支push到远程master分支</td>
</tr>
<tr>
<td style="text-align:left">git push origin :hotfixes/BJVEP933</td>
<td style="text-align:left">删除远程仓库的hotfixes/BJVEP933分支</td>
</tr>
<tr>
<td style="text-align:left">git push –tags</td>
<td style="text-align:left">把所有tag推送到远程仓库</td>
</tr>
<tr>
<td style="text-align:left">git fetch</td>
<td style="text-align:left">获取所有远程分支（不更新本地分支，另需merge）</td>
</tr>
<tr>
<td style="text-align:left">git fetch –prune</td>
<td style="text-align:left">获取所有原创分支并清除服务器上已删掉的分支</td>
</tr>
<tr>
<td style="text-align:left">git pull origin master</td>
<td style="text-align:left">获取远程分支master并merge到当前分支</td>
</tr>
<tr>
<td style="text-align:left">git mv README README2</td>
<td style="text-align:left">重命名文件README为README2</td>
</tr>
<tr>
<td style="text-align:left">git reset –hard HEAD</td>
<td style="text-align:left">将当前版本重置为HEAD（通常用于merge失败回退）</td>
</tr>
<tr>
<td style="text-align:left">git rebase</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git branch -d hotfixes/BJVEP933</td>
<td style="text-align:left">删除分支hotfixes/BJVEP933（本分支修改已合并到其他分支）</td>
</tr>
<tr>
<td style="text-align:left">git branch -D hotfixes/BJVEP933</td>
<td style="text-align:left">强制删除分支hotfixes/BJVEP933</td>
</tr>
<tr>
<td style="text-align:left">git ls-files</td>
<td style="text-align:left">列出git index包含的文件</td>
</tr>
<tr>
<td style="text-align:left">git show-branch</td>
<td style="text-align:left">图示当前分支历史</td>
</tr>
<tr>
<td style="text-align:left">git show-branch –all</td>
<td style="text-align:left">图示所有分支历史</td>
</tr>
<tr>
<td style="text-align:left">git whatchanged</td>
<td style="text-align:left">显示提交历史对应的文件修改</td>
</tr>
<tr>
<td style="text-align:left">git revert dfb02e6e4f2f7b573337763e5c0013802e392818</td>
<td style="text-align:left">撤销提交dfb02e6e4f2f7b573337763e5c0013802e392818</td>
</tr>
<tr>
<td style="text-align:left">git ls-tree HEAD</td>
<td style="text-align:left">内部命令：显示某个git对象</td>
</tr>
<tr>
<td style="text-align:left">git rev-parse v2.0</td>
<td style="text-align:left">内部命令：显示某个ref对于的SHA1 HASH</td>
</tr>
<tr>
<td style="text-align:left">git reflog</td>
<td style="text-align:left">显示所有提交，包括孤立节点</td>
</tr>
<tr>
<td style="text-align:left">git show HEAD@{5}</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git show master@{yesterday}</td>
<td style="text-align:left">显示master分支昨天的状态</td>
</tr>
<tr>
<td style="text-align:left">git log –pretty=format:’%h %s’ –graph</td>
<td style="text-align:left">图示提交日志</td>
</tr>
<tr>
<td style="text-align:left">git show HEAD~3</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git show -s –pretty=raw 2be7fcb476</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git stash</td>
<td style="text-align:left">暂存当前修改，将所有至为HEAD状态</td>
</tr>
<tr>
<td style="text-align:left">git stash list</td>
<td style="text-align:left">查看所有暂存</td>
</tr>
<tr>
<td style="text-align:left">git stash show -p stash@{0}</td>
<td style="text-align:left">参考第一次暂存</td>
</tr>
<tr>
<td style="text-align:left">git stash apply stash@{0}</td>
<td style="text-align:left">应用第一次暂存</td>
</tr>
<tr>
<td style="text-align:left">git grep “delete from”</td>
<td style="text-align:left">文件中搜索文本“delete from”</td>
</tr>
<tr>
<td style="text-align:left">git grep -e ‘#define’ –and -e SORT_DIRENT</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git gc</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">git fsck</td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/09/05/为什么Synchronized不能加在String和Integer等基本包装类型上/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/05/为什么Synchronized不能加在String和Integer等基本包装类型上/" itemprop="url">为什么Synchronized不能加在String和Integer等基本包装类型上</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-05T10:52:54+08:00">
                2017-09-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/05/为什么Synchronized不能加在String和Integer等基本包装类型上/" class="leancloud_visitors" data-flag-title="为什么Synchronized不能加在String和Integer等基本包装类型上">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>同步块不应该加在String或基本包装类型上，如Byte、Short、Integer、Long、Float、Double、Boolean、Character。</p>
<p>String不能用作同步块的参数是因为String为不可变对象，任何String对象的改变都将产生一个新的String对象，这也将导致前面加的锁不会被释放。</p>
<p>Integer、Boolean、Double、Long不能作为同步块参数的原因是他们是基本包装类型，包装类型有特殊的逻辑，用一句话说就是Java的自动封箱和解箱操作会导致这些对象在经过运算后不再是原来的对象。</p>
<p>用复杂的话说就是：当把基本变量赋值给包装类型的变量（其实编译过后的操作就是调用包装类型的静态方法valueOf）或者调用静态valueOf方法时：</p>
<ul>
<li>Boolean返回的是缓存的对象。</li>
<li>整型（Byte,Short,Integer,Long）会检查该数字是否在1个字节可表示的有符号整数范围内（-128~127），是则返回缓存对象，否则返回新对象。</li>
<li>Character会缓存整型值为0~127的字符，同样会检查字符是否落在缓存范围中，是则返回，否则返回新对象。</li>
<li>Double和Float的valueOf方法始终返回新对象。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/08/23/设计一个容错的微服务架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/23/设计一个容错的微服务架构/" itemprop="url">设计一个容错的微服务架构(转)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-23T15:21:52+08:00">
                2017-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/08/23/设计一个容错的微服务架构/" class="leancloud_visitors" data-flag-title="设计一个容错的微服务架构(转)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>摘要：转载请保留出处：<a href="https://github.com/jasonGeng88/blog" target="_blank" rel="external">https://github.com/jasonGeng88/blog</a></p>
</blockquote>
<h2 id="原文地址"><a href="#原文地址" class="headerlink" title="原文地址"></a>原文地址</h2><p><a href="https://blog.risingstack.com/designing-microservices-architecture-for-failure/" target="_blank" rel="external">https://blog.risingstack.com/designing-microservices-architecture-for-failure/</a></p>
<hr>
<p>微服务架构使得可以通过明确定义的服务边界来隔离故障。但是像在每个分布式系统中一样，发生网络、硬件、应用级别的错误都是很常见的。由于服务依赖关系，任何组件可能暂时无法提供服务。为了尽量减少部分中断的影响，我们需要构建容错服务，来优雅地处理这些中断的响应结果。</p>
<p>本文介绍了基于<a href="https://risingstack.com/" target="_blank" rel="external">RisingStack 的 Node.js 咨询和开发经验</a>构建和操作高可用性微服务系统的最常见技术和架构模式。</p>
<p>如果你不熟悉本文中的模式，那并不一定意味着你做错了。建立可靠的系统总是会带来额外的成本。</p>
<h2 id="微服务架构的风险"><a href="#微服务架构的风险" class="headerlink" title="微服务架构的风险"></a>微服务架构的风险</h2><p>微服务架构将应用程序逻辑移动到服务，并使用网络层在它们之间进行通信。这种通过网络间通信代替单应用程序内调用的做法，会带来额外的延迟，以及需要协调多个物理和逻辑组件的系统复杂度。分布式系统的复杂性增加也将导致更高的网络故障率。</p>
<p>微服务体系结构的最大优势之一是，团队可以独立设计，开发和部署他们的服务。他们对服务的生命周期拥有完全的所有权。这也意味着团队无法控制他们依赖的服务，因为它更有可能由不同的团队管理。使用微服务架构，我们需要记住，提供者服务可能会临时不可用，由于其他人员发行的错误版本，配置以及其他更改等。</p>
<h2 id="优雅的服务降级"><a href="#优雅的服务降级" class="headerlink" title="优雅的服务降级"></a>优雅的服务降级</h2><p>微服务架构的最大优点之一是您可以隔离故障，并在当组件单独故障时，进行优雅的服务降级。 例如，在中断期间，照片共享应用程序中的客户可能无法上传新图片，但仍可以浏览，编辑和共享其现有照片。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-fail-separately-in-theory.png" alt=""></p>
<p><em>微服务容错隔离</em></p>
<p>在大多数情况下，由于分布式系统中的应用程序相互依赖，因此很难实现这种优雅的服务降级，您需要应用几种故障转移的逻辑（其中一些将在本文后面介绍），以为暂时的故障和中断做准备。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/Microservices-depend-on-each-other.png" alt=""></p>
<p><em>服务间彼此依赖，再没有故障转移逻辑下，服务全部失败。</em></p>
<h2 id="变更管理"><a href="#变更管理" class="headerlink" title="变更管理"></a>变更管理</h2><p>Google的网站可靠性小组发现，大约70％的中断是由现有系统的变化引起的。当您更改服务中的某些内容时，您将部署新版本的代码或更改某些配置 - 这总有可能会造成故障，或者引入新的bug。</p>
<p>在微服务架构中，服务依赖于彼此。这就是为什么你应该尽量减少故障并限制它的负面影响。要处理变更中的问题，您可以实施变更管理策略和自动回滚机制。</p>
<p>例如，当您部署新代码或更改某些配置时，您应该先小范围的进行部分的替换，以渐进式的方式替换服务的全部实例。在这期间，需要监视它们，如果您发现它们对您的关键指标有负面影响，应立即进行服务回滚，这称为“金丝雀部署”。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-change-management.png" alt=""></p>
<p><em>变更管理 - 回滚部署</em></p>
<p>另一个解决方案可能是您运行两个生产环境。您始终只能部署其中一个，并且在验证新版本是否符合预期之后才，将负载均衡器指向新的。这称为蓝绿或红黑部署。</p>
<p>回滚代码不是坏事。你不应该在生产中遗留错误的代码，然后考虑出了什么问题。如果必要，越早回滚你的代码越好。</p>
<h2 id="健康检查与负载均衡"><a href="#健康检查与负载均衡" class="headerlink" title="健康检查与负载均衡"></a>健康检查与负载均衡</h2><p>实例由于出现故障、部署或自动缩放的情况，会进行持续启动、重新启动或停止操作。它可能导致它们暂时或永久不可用。为避免问题，您的负载均衡器应该从路由中跳过不健康的实例，因为它们当前无法为客户或子系统提供服务。</p>
<p>应用实例健康状况可以通过外部观察来确定。您可以通过重复调用<code>GET /health</code>端点或通过自我报告来实现。现在主流的服务发现解决方案，会持续从实例中收集健康信息，并配置负载均衡器，将流量仅路由到健康的组件上。</p>
<h2 id="自我修复"><a href="#自我修复" class="headerlink" title="自我修复"></a>自我修复</h2><p>自我修复可以帮助应用程序从错误中恢复过来。当应用程序可以采取必要步骤从故障状态恢复时，我们就可以说它是可以实现自我修复的。在大多数情况下，它由外部系统实现，该系统会监视实例运行状况，并在较长时间内处于故障状态时重新启动它们。自我修复在大多数情况下是非常有用的。但是在某些情况下，持续地重启应用程序可能会导致麻烦。 当您的应用程序由于超负荷或其数据库连接超时而无法给出健康的运行状况时，这种情况下的频繁的重启就可能就不太合适了。</p>
<p>对于这种特殊的场景（如丢失的数据库连接），要实现满足它的高级自我修复的解决方案可能很棘手。在这种情况下，您需要为应用程序添加额外的逻辑来处理边缘情况，并让外部系统知道实例不需要立即重新启动。</p>
<h2 id="故障转移缓存"><a href="#故障转移缓存" class="headerlink" title="故障转移缓存"></a>故障转移缓存</h2><p>由于网络问题和我们系统的变化，服务经常会失败。然而，由于自我修复和负载均衡的保障，它们中的大多数中断是临时的，我们应该找到一个解决方案，使我们的服务在这些故障时服务仍就可以工作。这就是故障转移缓存的作用，它可以帮助并为我们的应用程序在服务故障时提供必要的数据。</p>
<p>故障转移缓存通常使用两个不同的到期日期; 较短的时间告诉您在正常情况下缓存可以使用的过期时间，而较长的时间可以在服务故障时缓存依旧可用的过期时间。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-failover-caching.png" alt=""></p>
<p><em>故障转移缓存</em></p>
<p>请务必提及，只有当服务使用过时的数据比没有数据更好时，才能使用故障转移缓存。</p>
<p>要设置缓存和故障转移缓存，可以在 HTTP 中使用标准响应头。</p>
<p>例如，使用 <code>max-age</code> 属性可以指定资源被视为有效的最大时间。使用 <code>stale-if-error</code> 属性，您可以明确在出现故障的情况下，依旧可以从缓存中获取资源的最大时间。</p>
<p>现代的 CDN 和负载均衡器都提供各种缓存和故障转移行为，但您也可以为拥有标准可靠性解决方案的公司创建一个共享库。</p>
<h2 id="重试逻辑"><a href="#重试逻辑" class="headerlink" title="重试逻辑"></a>重试逻辑</h2><p>在某些情况下，我们无法缓存数据，或者我们想对其进行更改，但是我们的操作最终都失败了。对于此，我们可以重试我们的操作，因为我们可以预期资源将在一段时间后恢复，或者我们的负载均衡器将请求发送到了健康的实例上。</p>
<p>您应该小心地为您的应用程序和客户端添加重试逻辑，因为大量的重试可能会使事情更糟，甚至阻止应用程序恢复，如当服务超载时，大量的重试只能使状况更糟。</p>
<p>在分布式系统中，微服务系统重试可以触发多个其他请求或重试，并启动级联效应。为了最小化重试的影响，您应该限制它们的数量，并使用指数退避算法来持续增加重试之间的延迟，直到达到最大限制。</p>
<p>当客户端（浏览器，其他微服务等）发起重试，并且客户端不知道在处理请求之前或之后操作失败时，您应该为你的应用程序做好幂等处理的准备。例如，当您重试购买操作时，您不应该再次向客户收取费用。为每个交易使用唯一的幂等值键可以帮助处理重试。</p>
<h2 id="限流器和负载降级"><a href="#限流器和负载降级" class="headerlink" title="限流器和负载降级"></a>限流器和负载降级</h2><p>流量限制是在一段时间内定义特定客户或应用程序可以接收或处理多少个请求的技术。例如，通过流量限制，您可以过滤掉造成流量峰值的客户和服务，或者您可以确保您的应用程序在自动缩放无法满足时，依然不会超载。</p>
<p>您还可以阻止较低优先级的流量，为关键事务提供足够的资源。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-rate-limiter.png" alt=""></p>
<p><em>限流器可以阻止流量峰值产生</em></p>
<p>有一个不同类型的限流器，叫做并发请求限制器。当您有重要的端点，您不应该被调用超过指定的次数，而您仍然想要能提供服务时，这将是有用的。</p>
<p>负载降级的一系列使用，可以确保总是有足够的资源来提供关键交易。它为高优先级请求保留一些资源，不允许低优先级的事务使用它们。负载降级开关是根据系统的整体状态做出决定，而不是基于单个用户的请求量大小。负载降级有助于您的系统恢复，因为当你有一个偶发事件时（<em>可能是一个热点事件</em>），您仍能保持核心功能的正常工作。</p>
<p>要了解有关限流器和负载降级的更多信息，我建议查看这篇<a href="https://stripe.com/blog/rate-limiters" target="_blank" rel="external">Stripe的文章</a>。</p>
<h2 id="快速失败原则与独立性"><a href="#快速失败原则与独立性" class="headerlink" title="快速失败原则与独立性"></a>快速失败原则与独立性</h2><p>在微服务架构中，我们想要做到让我们的服务具备快速失败与相互独立的能力。为了在服务级别上进行故障隔离，我们可以使用舱壁模式。你可以在本文的后面阅读更多有关舱壁的内容。</p>
<p>我们也希望我们的组件能够快速失败，因为我们不希望对于有故障的服务，在请求超时后才断开。没有什么比挂起的请求和无响应的 UI 更令人失望。这不仅浪费资源，而且还会影响用户体验。我们的服务在调用链中是相互调用的，所以在这些延迟累加之前，我们应该特别注意防止挂起操作。</p>
<p>你想到的第一个想法是对每个服务调用都设置明确的超时等级。这种方法的问题是，您不能知道真正合理的超时值是多少，因为网络故障和其他问题发生的某些情况只会影响一两次操作。在这种情况下，如果只有其中一些超时，您可能不想拒绝这些请求。</p>
<p>我们可以说，在微服务种通过使用超时来达到快速失败的效果是一种反模式的，你应该避免使用它。取而代之，您可以应用断路器模式，依据操作的成功与失败统计数据决定。</p>
<h2 id="舱壁模式"><a href="#舱壁模式" class="headerlink" title="舱壁模式"></a>舱壁模式</h2><p>工业中使用舱壁将船舶划分为几个部分，以便在船体破坏的情况下，可以将船舶各个部件密封起来。</p>
<p>舱壁的概念在软件开发中可以被应用在隔离资源上。</p>
<p>通过应用舱壁模式，我们可以保护有限的资源不被耗尽。例如，对于一个有连接数限制的数据库实例来说，如果我们有两种连接它的操作，我们采用可以采用两个连接池的方式进行连接，来代替仅采用一个共享连接池的方式。由于这种客户端与资源进行了隔离，超时或过度使用池的操作页不会使其他操作失败。</p>
<p>泰坦尼克号沉没的主要原因之一是其舱壁设计失败，水可以通过上面的甲板倒在舱壁的顶部，导致整个船体淹没。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/titanic-bulkhead-microservices.png" alt=""></p>
<p><em>泰坦尼克号舱壁设计（无效的设计）</em></p>
<h2 id="断路器"><a href="#断路器" class="headerlink" title="断路器"></a>断路器</h2><p>为了限制操作的持续时间，我们可以使用超时。超时可以防止挂起操作并保持系统响应。然而，在微服务中使用静态、精细的超时是一种反模式，因为我们处于高度动态的环境中，几乎不可能提出在每种情况下都能正常工作的正确的时间限制。</p>
<p>替代这种静态超时的手段是，我们可以使用断路器来处理错误。断路器以现实世界的电子元件命名，因为它们的作用是相同的。您可以保护资源，并帮助他们使用断路器进行恢复。它们在分布式系统中非常有用，因为在分布式系统中，重复故障可能导致雪球效应并使整个系统瘫痪。</p>
<p>当特定类型的错误在短时间内多次发生时，断路器会被断开。开路的断路器可以防止进一步的请求 - 就像我们平时所说的电路跳闸一样。断路器通常在一定时间后关闭，在这期间可以为底层服务提供足够的空间来恢复。</p>
<p>请记住，并不是所有的错误都应该触发断路器。例如，您可能希望跳过客户端问题，例如具有4xx响应代码的请求，但不包括5xx服务器端故障。一些断路器也具有半开状态。在这种状态下，服务发送第一个请求以检查系统可用性，同时让其他请求失败。如果这个第一个请求成功，它将使断路器恢复到关闭状态并使流量流动。否则，它保持打开。</p>
<p><img src="http://colobu.com/2017/08/23/Designing-a-Microservices-Architecture-for-Failure/microservices-circuit-breakers.png" alt=""></p>
<p><em>断路器</em></p>
<h2 id="测试故障"><a href="#测试故障" class="headerlink" title="测试故障"></a>测试故障</h2><p>您应该不断测试您系统的常见问题，以确保您的服务可以抵抗各种故障。您应经常测试故障，让您的团队具备故障处理的能力。</p>
<p>对于测试，您可以使用外部服务来标识实例组，并随机终止此组中的一个实例。这样，您可以准备单个实例故障，但您甚至可以关闭整个区域来模拟云提供商的故障。</p>
<p>最流行的测试解决方案之一是 Netflix 的 <a href="https://github.com/Netflix/chaosmonkey" target="_blank" rel="external">ChaosMonkey 弹性工具</a>。</p>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>实施和运行可靠的服务并不容易。 您需要付出很多努力，同时公司也要有相应的财力投入。</p>
<p>可靠性有很多层次和方面，因此找到最适合您团队的解决方案很重要。您应该使可靠性成为您的业务决策流程中的一个因素，并为其分配足够的预算和时间。</p>
<h2 id="主要收获"><a href="#主要收获" class="headerlink" title="主要收获"></a>主要收获</h2><ul>
<li>动态环境和分布式系统（如微服务）会导致更高的故障机率；</li>
<li>服务应该做到故障隔离，到达优雅降级，来提升用户体验；</li>
<li>70％的中断是由变化引起的，代码回滚不是一件坏事；</li>
<li>做到服务快速失败与独立性。团队是无法控制他们所依赖的服务情况；</li>
<li>缓存、舱壁、断路器和限流器等架构模式与技术有助于构建可靠的微服务架构。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/07/27/语义化版本2-0-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/27/语义化版本2-0-0/" itemprop="url">语义化版本2.0.0</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-27T21:36:24+08:00">
                2017-07-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/07/27/语义化版本2-0-0/" class="leancloud_visitors" data-flag-title="语义化版本2.0.0">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>本文翻译自<a href="http://semver.org/" target="_blank" rel="external">semver.org</a> ，如需看原版请点击前面的链接。</em></p>
<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>版本格式：主版本号.次版本号.修订号，版本号递增规则如下：</p>
<p>主版本号：当你做了不兼容的 API 修改，<br>次版本号：当你做了向下兼容的功能性新增，<br>修订号：当你做了向下兼容的问题修正。<br>先行版本号及版本编译信息可以加到“主版本号.次版本号.修订号”的后面，作为延伸。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>在软件管理的领域里存在着被称作“依赖地狱”的死亡之谷，系统规模越大，加入的套件越多，你就越有可能在未来的某一天发现自己已深陷绝望之中。</p>
<p>在依赖高的系统中发布新版本套件可能很快会成为恶梦。如果依赖关系过高，可能面临版本控制被锁死的风险（必须对每一个相依套件改版才能完成某次升级）。而如果依赖关系过于松散，又将无法避免版本的混乱（假设兼容于未来的多个版本已超出了合理数量）。当你专案的进展因为版本相依被锁死或版本混乱变得不够简便和可靠，就意味着你正处于依赖地狱之中。</p>
<p>作为这个问题的解决方案之一，我提议用一组简单的规则及条件来约束版本号的配置和增长。这些规则是根据（但不局限于）已经被各种封闭、开放源码软件所广泛使用的惯例所设计。为了让这套理论运作，你必须先有定义好的公共 API 。这可以透过文件定义或代码强制要求来实现。无论如何，这套 API 的清楚明了是十分重要的。一旦你定义了公共 API，你就可以透过修改相应的版本号来向大家说明你的修改。考虑使用这样的版本号格式：XYZ （主版本号.次版本号.修订号）修复问题但不影响API 时，递增修订号；API 保持向下兼容的新增及修改时，递增次版本号；进行不向下兼容的修改时，递增主版本号。</p>
<p>我称这套系统为“语义化的版本控制”，在这套约定下，版本号及其更新方式包含了相邻版本间的底层代码和修改内容的信息。</p>
<h1 id="为什么要使用语义化的版本控制？"><a href="#为什么要使用语义化的版本控制？" class="headerlink" title="为什么要使用语义化的版本控制？"></a>为什么要使用语义化的版本控制？</h1><p>这并不是一个新的或者革命性的想法。实际上，你可能已经在做一些近似的事情了。问题在于只是“近似”还不够。如果没有某个正式的规范可循，版本号对于依赖的管理并无实质意义。将上述的想法命名并给予清楚的定义，让你对软件使用者传达意向变得容易。一旦这些意向变得清楚，弹性（但又不会太弹性）的依赖规范就能达成。</p>
<p>举个简单的例子就可以展示语义化的版本控制如何让依赖地狱成为过去。假设有个名为“救火车”的函式库，它需要另一个名为“梯子”并已经有使用语义化版本控制的套件。当救火车创建时，梯子的版本号为 3.1.0。因为救火车使用了一些版本 3.1.0 所新增的功能， 你可以放心地指定相依于梯子的版本号大等于 3.1.0 但小于 4.0.0。这样，当梯子版本 3.1.1 和 3.2.0 发布时，你可以将直接它们纳入你的套件管理系统，因为它们能与原有相依的软件兼容。</p>
<p>作为一位负责任的开发者，你理当确保每次套件升级的运作与版本号的表述一致。现实世界是复杂的，我们除了提高警觉外能做的不多。你所能做的就是让语义化的版本控制为你提供一个健全的方式来发行以及升级套件，而无需推出新的相依套件，节省你的时间及烦恼。</p>
<p>如果你对此认同，希望立即开始使用语义化版本控制，你只需声明你的函式库正在使用它并遵循这些规则就可以了。请在你的 README 文件中保留此页连结，让别人也知道这些规则并从中受益。</p>
<h1 id="语义化版本控制规范（SemVer）"><a href="#语义化版本控制规范（SemVer）" class="headerlink" title="语义化版本控制规范（SemVer）"></a>语义化版本控制规范（SemVer）</h1><p>以下关键词 MUST、MUST NOT、REQUIRED、SHALL、SHALL NOT、SHOULD、SHOULD NOT、 RECOMMENDED、MAY、OPTIONAL 依照 RFC 2119 的叙述解读。（译注：为了保持语句顺畅， 以下文件遇到的关键词将依照整句语义进行翻译，在此先不进行个别翻译。）</p>
<p>1.使用语义化版本控制的软件“必须 MUST ”定义公共 API。该 API 可以在代码中被定义或出现于严谨的文件内。无论何种形式都应该力求精确且完整。</p>
<p>2.标准的版本号“必须 MUST ”采用 XYZ 的格式，其中 X、Y 和 Z 为非负的整数，且“禁止 MUST NOT”在数字前方补零。X 是主版本号、Y 是次版本号、而 Z 为修订号。每个元素“必须 MUST ”以数值来递增。例如：1.9.1 -&gt; 1.10.0 -&gt; 1.11.0。</p>
<p>3.标记版本号的软件发行后，“禁止 MUST NOT ”改变该版本软件的内容。任何修改都“必须 MUST ”以新版本发行。</p>
<p>4.主版本号为零（0.y.z）的软件处于开发初始阶段，一切都可能随时被改变。这样的公共 API 不应该被视为稳定版。</p>
<p>1.0.0 的版本号用于界定公共 API 的形成。这一版本之后所有的版本号更新都基于公共 API 及其修改内容。</p>
<p>5.修订号 Z（x.y.Z | x &gt; 0）“必须 MUST ”在只做了向下兼容的修正时才递增。这里的修正指的是针对不正确结果而进行的内部修改。</p>
<p>6.次版本号 Y（x.Y.z | x &gt; 0）“必须 MUST ”在有向下兼容的新功能出现时递增。在任何公共 API 的功能被标记为弃用时也“必须 MUST ”递增。也“可以 MAY ”在内部程序有大量新功能或改进被加入时递增，其中“可以 MAY ”包括修订级别的改变。每当次版本号递增时，修订号“必须 MUST ”归零。</p>
<p>7.主版本号 X（X.y.z | X &gt; 0）“必须 MUST ”在有任何不兼容的修改被加入公共 API 时递增。其中“可以 MAY ”包括次版本号及修订级别的改变。每当主版本号递增时，次版本号和修订号“必须 MUST ”归零。</p>
<p>8.先行版本号“可以 MAY ”被标注在修订版之后，先加上一个连接号再加上一连串以句点分隔的标识符号来修饰。标识符号“必须 MUST ”由 ASCII 码的英数字和连接号 [0-9A-Za-z-] 组成，且“禁止 MUST NOT ”留白。数字型的标识符号“禁止 MUST NOT ”在前方补零。先行版的优先级低于相关联的标准版本。被标上先行版本号则表示这个版本并非稳定而且可能无法达到兼容的需求。范例：1.0.0-alpha、1.0.0-alpha.1、1.0.0-0.3.7、1.0.0-x.7.z.92。</p>
<p>9.版本编译信息“可以 MAY ”被标注在修订版或先行版本号之后，先加上一个加号再加上一连串以句点分隔的标识符号来修饰。标识符号“必须 MUST ”由 ASCII 的英数字和连接号 [0-9A-Za-z-] 组成，且“禁止 MUST NOT ”留白。当判断版本的优先层级时，版本编译信息“可 SHOULD ”被忽略。因此当两个版本只有在版本编译信息有差别时，属于相同的优先层级。范例：1.0.0-alpha+001、1.0.0+20130313144700、1.0.0-beta+exp.sha.5114f85。</p>
<p>10.版本的优先层级指的是不同版本在排序时如何比较。判断优先层级时，“必须 MUST ”把版本依序拆分为主版本号、次版本号、修订号及先行版本号后进行比较（版本编译信息不在这份比较的列表中）。由左到右依序比较每个标识符号，第一个差异值用来决定优先层级：主版本号、次版本号及修订号以数值比较，例如：1.0.0 &lt; 2.0.0 &lt; 2.1.0 &lt; 2.1.1。当主版本号、次版本号及修订号都相同时，改以优先层级比较低的先行版本号决定。例如：1.0.0-alpha &lt; 1.0.0。有相同主版本号、次版本号及修订号的两个先行版本号，其优先层级“必须 MUST ”透过由左到右的每个被句点分隔的标识符号来比较，直到找到一个差异值后决定：只有数字的标识符号以数值高低比较，有字母或连接号时则逐字以 ASCII 的排序来比较。数字的标识符号比非数字的标识符号优先层级低。若开头的标识符号都相同时，栏位比较多的先行版本号优先层级比较高。范例：1.0.0-alpha &lt; 1.0.0-alpha.1 &lt; 1.0.0-alpha.beta &lt; 1.0.0-beta &lt; 1.0.0-beta.2 &lt; 1.0.0-beta.11 &lt; 1.0.0- rc.1 &lt; 1.0.0。</p>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p>1.在0.y.z初始开发阶段，我该如何进行版本控制？</p>
<p>最简单的做法是以 0.1.0 作为你的初始化开发版本，并在后续的每次发行时递增次版本号。</p>
<p>2.如何判断发布 1.0.0 版本的时机？</p>
<p>当你的软件被用于正式环境，它应该已经达到了 1.0.0 版。如果你已经有个稳定的 API 被使用者依赖，也会是 1.0.0 版。如果你很担心向下兼容的问题，也应该算是 1.0.0 版了。</p>
<p>3.这不会阻碍快速开发和迭代吗？</p>
<p>主版本号为零的时候就是为了做快速开发。如果你每天都在改变 API，那么你应该仍在主版本号为零的阶段（0.y.z），或是正在下个主版本的独立开发分支中。</p>
<p>4.对于公共 API，若即使是最小但不向下兼容的改变都需要产生新的主版本号，岂不是很快就达到 42.0.0 版？</p>
<p>这是开发的责任感和前瞻性的问题。不兼容的改变不应该轻易被加入到有许多依赖代码的软件中。升级所付出的代价可能是巨大的。要递增主版本号来发行不兼容的改版，意味着你必须为这些改变所带来的影响深思熟虑，并且评估所涉及的成本及效益比。</p>
<p>5.为整个公共 API 写文件太费事了！</p>
<p>为供他人使用的软件编写适当的文件，是你作为一名专业开发者应尽的职责。保持专案高效一个非常重要的部份是掌控软件的复杂度，如果没有人知道如何使用你的软件或不知道哪些函数的调用是可靠的，要掌控复杂度会是困难的。长远来看，使用语义化版本控制以及对于公共 API 有良好规范的坚持，可以让每个人及每件事都运行顺畅。</p>
<p>6.万一不小心把一个不兼容的改版当成了次版本号发行了该怎么办？</p>
<p>一旦发现自己破坏了语义化版本控制的规范，就要修正这个问题，并发行一个新的次版本号来更正这个问题并且恢复向下兼容。即使是这种情况，也不能去修改已发行的版本。可以的话，将有问题的版本号记录到文件中，告诉使用者问题所在，让他们能够意识到这是有问题的版本。</p>
<p>7.如果我更新了自己的依赖但没有改变公共 API 该怎么办？</p>
<p>由于没有影响到公共 API，这可以被认定是兼容的。若某个软件和你的套件有共同依赖，则它会有自己的依赖规范，作者也会告知可能的冲突。要判断改版是属于修订等级或是次版等级，是依据你更新的依赖关系是为了修复问题或是加入新功能。对于后者，我经常会预期伴随着更多的代码，这显然会是一个次版本号级别的递增。</p>
<p>8.如果我变更了公共 API 但无意中未遵循版本号的改动怎么办呢？（意即在修订等级的发布中，误将重大且不兼容的改变加到代码之中）</p>
<p>自行做最佳的判断。如果你有庞大的使用者群在依照公共 API 的意图而变更行为后会大受影响，那么最好做一次主版本的发布，即使严格来说这个修复仅是修订等级的发布。记住， 语义化的版本控制就是透过版本号的改变来传达意义。若这些改变对你的使用者是重要的，那就透过版本号来向他们说明。</p>
<p>9.我该如何处理即将弃用的功能？</p>
<p>弃用现存的功能是软件开发中的家常便饭，也通常是向前发展所必须的。当你弃用部份公共 API 时，你应该做两件事：（1）更新你的文件让使用者知道这个改变，（2）在适当的时机将弃用的功能透过新的次版本号发布。在新的主版本完全移除弃用功能前，至少要有一个次版本包含这个弃用信息，这样使用者才能平顺地转移到新版 API。</p>
<p>10.语义化版本对于版本的字串长度是否有限制呢？</p>
<p>没有，请自行做适当的判断。举例来说，长到 255 个字元的版本已过度夸张。再者，特定的系统对于字串长度可能会有他们自己的限制。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/07/25/一个HashBasedTable引发的故障/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/一个HashBasedTable引发的故障/" itemprop="url">一个Guava HashBasedTable引发的故障</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-25T19:32:13+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/07/25/一个HashBasedTable引发的故障/" class="leancloud_visitors" data-flag-title="一个Guava HashBasedTable引发的故障">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇故障从原因来看比较简单，但分享出来的原因是因为在分析故障原因的过程中忽略了一些关键因素，导致走了一些弯路，所以写出来供大家借鉴。</p>
<h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>上周负责的系统出现了一次故障，故障的表象是部分搜索超时严重。在对监控进行排查的时候，发现有一台服务器CPU使用率有比较大的飙升，为了不影响业务，先将此服务器重启。重启后，CPU使用率恢复正常，故障恢复（见下图）。<br><img src="https://img.alicdn.com/imgextra/i1/2657627814/TB2oeAKaVokyKJjy1zbXXXZfVXa_!!2657627814.png" alt="CPU使用率"></p>
<h1 id="故障原因分析过程"><a href="#故障原因分析过程" class="headerlink" title="故障原因分析过程"></a>故障原因分析过程</h1><p>剩下的事情就是对故障原因进行分析了，是什么原因导致了请求的超时呢？<br>于是查看其它的监控，发现CPU使用率异常的服务器在相似的时间点，出现了大量的CLOSE_WAIT，这时立马警觉起来。我们都知道，TCPIP断开连接要经历4次挥手的过程，如下图:</p>
<p><img src="https://img.alicdn.com/imgextra/i1/2657627814/TB2KN9XcnIlyKJjSZFMXXXvVXXa_!!2657627814.jpg" alt="TCPIP4次挥手过程"></p>
<p>从上面这个图我们可以看出，CLOSE_WAIT状态是由于对端主动断开了连接导致的。在我们的这个case中，我们的系统是client端，那也就意味着，是server端主动断开了与我们的连接，而正常情况client端应该继续发送ACK和FIN指令完成4次挥手过程的，但很显然我们的系统并没有继续后续的挥手，开始查找原因。</p>
<p><img src="https://img.alicdn.com/imgextra/i4/2657627814/TB2JGALa3wjyKJjSspeXXXXZXXa_!!2657627814.png" alt="CLOSE_WAIT监控"></p>
<p>由于系统中使用了AsyncHttpClient组件（以下简称AHC），开始时怀疑是AHC使用不当造成的。比如如果在AHC的时候使用流处理，而在处理流的时候出现异常，很有可能导致连接不能关闭而导致CLOSE_WAIT出现。但排查代码确认我们的系统中没有使用流，此原因排除。</p>
<p>考虑到我们的异步请求是通过继承AsyncCompletionHandler抽象类来实现异步结果的处理，于是开始确认onCompleted和onThrowable方法是不是有一些特殊处理导致连接没有关闭，但看代码也没发现有什么问题。于是“排除”了自己代码的原因。这里用双引号是因为其实并没有真正排除代码的问题，而是忽略了一处有问题的代码。这里先卖个关子。</p>
<p>后面开始怀疑是否是AHC的bug导致，于是放狗(google)查资料，在AHC的issue讨论区也看到有人反馈CLOSE_WAIT的情况，但对方是在大访问量的情况下会导致CLOSE_WAIT出现（<a href="https://github.com/AsyncHttpClient/async-http-client/issues/1027" title="issue链接" target="_blank" rel="external">issue链接</a>），但这个issue也没有得到AHC官方确认。考虑到我们的系统QPS不是很高，所以也排除了bug的可能性。</p>
<p>继续放狗，看到一篇博客(<a href="http://www.cnblogs.com/yuyijq/p/4431798.html" target="_blank" rel="external">链接</a>)讲netty里面的autoread特性会导致CLOSE_WAIT出现，但autoread是netty4里面的特性，我们使用的AHC依赖的是netty 3.10，这个原因也排除了。</p>
<p>至此，线索中断，于是求助余老师。PS：上面的那博客其实就是余老师写的，😆</p>
<p>余老师了解了情况之后，首先询问AHC是否使用的非单例（如果创建多个AsyncHttpClient实例是有可能导致大量CLOSE_WAIT的），答案是没有。<br>继续询问使用AHC的线程中是否使用了阻塞，答案是没有。<br>到这里，余老师也没给出更进一步的建议，所以继续排查。</p>
<p>第二天已经是周末，余老师继续帮忙定位问题，在看代码时发现有个地方的缓存使用了HashBasedTable，而HashBasedTable是非线程安全的，因为它使用了HashMap实现的，于是怀疑是这个地方可能会有问题。通过查看监控，发现故障时CPU、Load是同时增长的，而且CPU使用率在25%左右，基本可以确定在当时某个线程CPU使用率达到100%（服务器是4核）。</p>
<p>通过代码和监控的关联，可以确定这次故障的原因是因为使用了非线程安全的HashBasedTable，导致竞态条件下踩中了HashMap的坑导致当前线程CPU使用率100%，这样当前线程也就没有时间来处理后续的网络事件了，比如断开连接，最终导致大量CLOSE_WAIT以及超时出现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Cache&lt;String, Table&lt;String,String,PackageFlightBean&gt;&gt; packageListBeanCache = CacheBuilder.from(packageListSpec).build();<span class="comment">//&lt;key,&lt;code,PackageFlightBean&gt;&gt;</span></div><div class="line"></div><div class="line"><span class="meta">@Resource</span></div><div class="line"><span class="keyword">private</span> DomesticSearchService domesticSearchService;</div><div class="line"><span class="meta">@Resource</span></div><div class="line"><span class="keyword">private</span> InterSearchService interSearchService;</div><div class="line"><span class="meta">@Resource</span></div><div class="line"><span class="keyword">private</span> PackageSearchService packageSearchService;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putPackageFlightBean</span><span class="params">(MultiQuery query,String code,PackageFlightBean packageFlightBean)</span></span>&#123;</div><div class="line">    List&lt;String&gt; codeList = splitter.splitToList(code);</div><div class="line">    <span class="keyword">if</span>(codeList.size()!=<span class="number">2</span> || packageFlightBean==<span class="keyword">null</span>)&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    String key = query.genPackageKey();</div><div class="line">    Table&lt;String,String,PackageFlightBean&gt; beanTable = packageListBeanCache.getIfPresent(key);</div><div class="line">    <span class="keyword">if</span>(beanTable==<span class="keyword">null</span>)&#123;</div><div class="line">        beanTable = HashBasedTable.create();<span class="comment">//这里使用了HashBasedTable，内部使用HashMap实现，非线程安全</span></div><div class="line">        beanTable.put(codeList.get(<span class="number">0</span>),codeList.get(<span class="number">1</span>),packageFlightBean);</div><div class="line">        packageListBeanCache.put(key,beanTable);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        beanTable.put(codeList.get(<span class="number">0</span>),codeList.get(<span class="number">1</span>),packageFlightBean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这次故障原因分析的过程走了一些弯路，原因有这么几点：</p>
<p>1.没有及时发现某个线程CPU使用率达到100%的情况：</p>
<p>如果能及时发现这一点，那么很可能就能在第一时间反应到是死循环导致的，那么定位问题会更快一些。当然如果我们的监控系统能够发现某个线程CPU使用率100%并告警就更好了，这个建议已经反馈给OPS同学，他们在想办法做了。那么在现有的情况下，如果我们发现CPU使用率平滑持续在25%左右，那么我们也需要额外注意，因为在4核的系统中，这可能代表某个线程CPU使用率已经在100%了；</p>
<p>2.没有保留现场如线程栈之类的信息：<br>如果在重启服务之前保留了线程栈，那么定位问题会更方便一些，可惜当时的同学急于修复故障，而未做到这一点；</p>
<p>3.没有发现HashBasedTable的坑：</p>
<p>  因为故障系统是个低频应用而且是从别的团队接手过来的，所以对代码不够熟悉，更不知道HashBasedTable是非线程安全的，最终导致故障的出现。这里也提醒一下，Guava里面的HashBasedTable、ArrayTable、TreeBasedTable、StandardTable、StandardRowSortedTable都是非线程安全的，使用的时候务必注意。另外，我们在使用在使用第三方工具的时候，务必要仔细查看相关说明，比如一些限制因素，避免踩坑。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/06/13/Linux性能分析工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/13/Linux性能分析工具/" itemprop="url">Linux性能分析工具</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-13T17:28:33+08:00">
                2017-06-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/13/Linux性能分析工具/" class="leancloud_visitors" data-flag-title="Linux性能分析工具">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://img.alicdn.com/imgextra/i2/2657627814/TB2Fpf7w0FopuFjSZFHXXbSlXXa_!!2657627814.png" alt=""></p>
<p><img src="https://img.alicdn.com/imgextra/i1/2657627814/TB2oKsaw5RnpuFjSZFCXXX2DXXa_!!2657627814.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/04/26/集群限流实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/26/集群限流实现/" itemprop="url">集群限流实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-26T14:55:35+08:00">
                2017-04-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/26/集群限流实现/" class="leancloud_visitors" data-flag-title="集群限流实现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在<a href="http://fengfu.io/2017/04/22/%E6%9C%8D%E5%8A%A1%E5%8C%96%E6%9E%B6%E6%9E%84-%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%99%90%E6%B5%81/">上一篇文章</a>中，提到了限流的方式分为单机限流和集群限流，在这篇文章中，就来看一下集群限流如何实现。</p>
<p>对于集群限流，我们一般会考虑以下三方面：</p>
<ol>
<li>分布式：能够进行全局限流，尤其在访问受限制的资源的情况下。比如某个第三方接口只允许每秒100次的访问量，但我们的应用是部署在多台服务器上，在这种情况下，就需要进行全局限流了；</li>
<li>滑动窗口：能够避免流量突变(比如洪峰)对系统的影响。比如我们限制了1秒的访问量不能超过100，但很有可能出现一种情况就是前900毫秒没有任何请求，但900毫秒的时候突然来了100个请求；在第2秒的前100毫秒又来了100个请求。这也就意味着在200毫秒的时间涌入了200个请求。这种情况也很有可能把系统打挂掉。</li>
<li>最小请求间隔：为了避免请求太频繁，还需要限制调用端的请求时间间隔，如果时间间隔太短，同样也需要限制；</li>
</ol>
<p>对于分布式的限流，需要使用分布式存储来存放请求的状态数据，在这里，我们使用Redis作为存储引擎。</p>
<h2 id="第一版实现"><a href="#第一版实现" class="headerlink" title="第一版实现"></a>第一版实现</h2><p>限流的标准实现一般是使用令牌桶算法，实现思路如下：</p>
<ol>
<li>每个接口都有一个对应的令牌桶，桶中含有若干令牌；</li>
<li>当用户发起请求的时候，首先从桶中获取一个令牌。在获取令牌的时候，首先会检查桶中剩余的令牌；</li>
<li>如果桶是空的，则表明已经达到上限，请求将被阻塞住；</li>
<li>反之，从桶中移除一个令牌，执行用户请求；</li>
<li>随着时间推移，按照一定的频率往桶里放入令牌，直到达到容量上限。</li>
</ol>
<p>这种算法的好处在于占用存储空间小，每个接口只需要一个整形计数器即可，不足之处在于：需要有额外的处理程序往桶里放令牌。如果系统有很多的接口，那也就意味着系统需要有很多的桶，而且每个桶都需要按照固定的速率放入令牌，那么这不仅会增加系统的压力，也会增加系统的复杂性。于是我们可以在此基础上进行优化：</p>
<h2 id="改进实现"><a href="#改进实现" class="headerlink" title="改进实现"></a>改进实现</h2><ol>
<li>每个接口有2个对应的key：令牌桶和桶被填充满时的时间戳；</li>
<li>当接口被访问的时候，读取对应的时间戳；</li>
<li>计算从上次访问到现在该请求可以获取的令牌数量；</li>
<li>如果满足要求，请求继续执行。</li>
</ol>
<p>不幸的是，这个算法也存在缺陷：我们需要同步令牌桶和时间戳的状态，如果同步失败，这种方案将会失效。Redis可以通过批量操作来保证原子操作，但计算用户可以获取多少令牌的时候，我们需要与Redis有两次交互：第一次获取上次访问的时间戳，第二次设置令牌的数量。如果你不想钻研Redis Lua脚本，恐怕我们无法在一个原子操作中实现上述需求。鉴于此，如果有2个客户端在同一时间来校验用户请求的时候，我们可能会得到下面的执行顺序：</p>
<ol>
<li>用户有足够的令牌来执行一个请求；</li>
<li>前后请求的间隔内，并没有新的令牌放入桶中；</li>
<li>客户端1获得存储的时间戳和令牌数量；</li>
<li>客户端2获得存储的时间戳和令牌数量；</li>
<li>客户端1通过计算断定令牌足够，放行请求，通知redis清空令牌桶；</li>
<li>客户端2通过计算也断定令牌足够，放行请求，通知redis清空令牌桶；</li>
</ol>
<p>无需多言，上述方案完全失效了，显然这情况并不是我们想要的。</p>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p>幸运的是，Redis有另外一种数据结构可以避免上述竞态条件-Sorted Set。下面是实现思路：</p>
<ol>
<li>每个接口都有一个对应的Sorted Set，set中key和value是唯一的，key和value都为请求提交时的时间戳；</li>
<li>当客户端提交请求时，首先将某个时间间隔前的元素全部清除，这个操作可以使用Redis的ZREMRANGEBYSCORE命令实现；</li>
<li>使用ZRANGE(0, -1)命令获取set中剩余的所有元素；</li>
<li>使用ZADD命令将当前请求的时间戳添加到set中；</li>
<li>设置TTL给set；TTL=限制请求的时间间隔。</li>
</ol>
<p>进行完上述所有操作后，计算获取到的元素数量，如果超出限制，则拒绝请求；</p>
<p>同时，获取获取的元素中最大的时间戳，与当前请求时间做比较。如果间隔太小，则拒绝请求；</p>
<p>这种方案的好处是所有的redis请求都可以使用MULTI命令作为一个原子操作。这意味着如果两个客户端请求相同的接口，是能够避免前面提到的竞态条件出现的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/04/23/服务化架构-服务降级/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/23/服务化架构-服务降级/" itemprop="url">服务化架构-服务降级</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-23T14:23:23+08:00">
                2017-04-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/23/服务化架构-服务降级/" class="leancloud_visitors" data-flag-title="服务化架构-服务降级">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-什么是降级"><a href="#1-什么是降级" class="headerlink" title="1. 什么是降级"></a>1. 什么是降级</h1><p>高可用系统为了保证自身的高可用性，会在异常情况下限制自身的一些能力，来保证核心功能的可用性。这有点类似武侠小说里面的壮士断腕，也有点类似于象棋里面的弃车保帅。</p>
<h1 id="2-为什么需要降级？"><a href="#2-为什么需要降级？" class="headerlink" title="2. 为什么需要降级？"></a>2. 为什么需要降级？</h1><p>在系统复杂度越来越高的今天，我们可能会经常遇到这样的困扰：一个非核心的功能异常最终导致了整个系统的不可用。比如一个获取非核心数据接口的超时最终导致了整个线程池全部阻塞，影响了核心功能线程的运行；业务链条中某个环节的接口不可用导致整个业务链的失败。这样的例子比比皆是，造成的损失往往也非常大，所以为了避免这种小功能搞垮大系统的情况发生，降级的概念就应运而生了。</p>
<h1 id="3-降级预案"><a href="#3-降级预案" class="headerlink" title="3. 降级预案"></a>3. 降级预案</h1><p>在要对系统制定降级策略之前，我们先对系统中的功能、服务进行梳理，识别出系统中的核心、非核心功能，这样能够梳理出哪些失败需要阻断主流程，哪些失败可以不阻断主流程。这样我们也就能确定哪些功能和服务必须死保，哪些功能和服务能够降级。<br>举个栗子：在机票的搜索流程中，报价、航班详情（如起降时间、航站楼）是关键信息，这些信息是无论如何不能缺失的；但餐食信息对于用户来讲就是可有可无的，当系统压力比较大的时候，我们就可以将餐食信息的获取给关掉，来优先保证核心数据的正常获取；<br>再举个栗子：对于机票的信息中，报价信息是经常变化的，但航班详情信息变化频率就没那么大。那么在系统压力比较大的情况下，可以将获取航班详情的方式由实时获取改为读取缓存，这样既不会导致数据准确性有太大的变化，也保证了系统核心功能的可用。</p>
<h1 id="4-降级策略"><a href="#4-降级策略" class="headerlink" title="4. 降级策略"></a>4. 降级策略</h1><h2 id="4-1-按功能降级"><a href="#4-1-按功能降级" class="headerlink" title="4.1 按功能降级"></a>4.1 按功能降级</h2><p>按功能降级是指在不影响核心功能的情况下，减少对非核心功能的使用，来保护系统的基本使用。<br>比如前面提到的例子，在机票搜索过程中，如果系统负载比较大出现超时，可以先将中转拼接报价计算功能（非核心功能）关闭，减少计算量，来降低系统负载保证用户搜索不至于失败；<br>再比如，在双11或者618的时候，系统的负载往往都比较大，这时候为了降低系统的负载，系统往往会把诸如支付后推荐、买了又买之类的非核心功能关闭。这些case我们可以参考淘宝、京东同学写的技术文章，例子不胜枚举。</p>
<h2 id="4-2-按来源降级"><a href="#4-2-按来源降级" class="headerlink" title="4.2 按来源降级"></a>4.2 按来源降级</h2><p>在某些时候，系统的QPS比较高，服务器扛不住压力的时候，可以针对请求进行限流。当然对于限流我们不能一刀切，如果能先限制某些不重要业务的访问，那是最好的。如果所有请求的重要程度是一样的，那么只能按照统一的策略进行限流了，毕竟牺牲掉部分用户请求来保证服务的可用性是第一位的。</p>
<h2 id="4-3-按质量降级"><a href="#4-3-按质量降级" class="headerlink" title="4.3 按质量降级"></a>4.3 按质量降级</h2><p>比如利用缓存。在机票行业，飞机上的舱位就相当于电商行业的库存，不同的是，电商的库存基本是自己管理，但机票的库存（舱位）是航司管理的，查询可用舱位花费的成本又很高。为了解决成本，我们可以针对某些冷门航线的舱位使用缓存，而且缓存时间设置得比较久，毕竟这些航线出票量比较少，没必要去占用过多的查询指令。</p>
<h1 id="5-降级介入方式"><a href="#5-降级介入方式" class="headerlink" title="5. 降级介入方式"></a>5. 降级介入方式</h1><p>在系统遇到异常情况时，我们需要执行事先准备的降级预案，这时候就需要额外的分支介入系统逻辑，来执行系统降级策略。降级的介入方式分为两种：人工介入和自动介入。当然有的时候在系统所处的局面比较复杂的时候，往往需要两者方式都需要使用，比如自动降级失效的情况下，那么必须进行人工介入了。</p>
<h2 id="5-1-人工介入"><a href="#5-1-人工介入" class="headerlink" title="5.1 人工介入"></a>5.1 人工介入</h2><p>人工介入的方式是指当系统维护人员在发现系统异常之后，通过人工修改参数、关闭服务等方式进行降级的方法。这种方式的好处是比较灵活，能够根据异常情况灵活应对；但弊端是对人的要求比较高，一来需要维护人员对系统有足够的了解，另外要求维护人员在系统异常时能够在第一时间进行处置。</p>
<h2 id="5-2-自动介入"><a href="#5-2-自动介入" class="headerlink" title="5.2 自动介入"></a>5.2 自动介入</h2><p>自动介入的方式一般是当系统达到某些设定的条件之后，自动执行一些策略。比如当系统以来的某个第三方数据接口的失败率达到设定的阈值，那么就使用缓存数据；再比如购买机票的时候，如果遇到航司接口维护，那么我们可以先收单，保证主流程不阻断，等航司接口恢复之后再执行出票处理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="宁静·致远" />
          <p class="site-author-name" itemprop="name">宁静·致远</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">44</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">宁静·致远</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Gemini
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("pq7j7M6jaVzlRAhO3VhuFy1O-gzGzoHsz", "Fqlk4xsApzNKqC5HV87nMkix");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
