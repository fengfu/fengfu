<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="宁静·致远">
<meta property="og:url" content="http://fengfu.io/page/2/index.html">
<meta property="og:site_name" content="宁静·致远">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="宁静·致远">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://fengfu.io/page/2/"/>





  <title>宁静·致远</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">宁静·致远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-rss">
          <a href="/atom.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            RSS
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/06/13/Linux性能分析工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/13/Linux性能分析工具/" itemprop="url">Linux性能分析工具</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-13T17:28:33+08:00">
                2017-06-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/13/Linux性能分析工具/" class="leancloud_visitors" data-flag-title="Linux性能分析工具">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://img.alicdn.com/imgextra/i2/2657627814/TB2Fpf7w0FopuFjSZFHXXbSlXXa_!!2657627814.png" alt=""></p>
<p><img src="https://img.alicdn.com/imgextra/i1/2657627814/TB2oKsaw5RnpuFjSZFCXXX2DXXa_!!2657627814.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/04/26/集群限流实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/26/集群限流实现/" itemprop="url">集群限流实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-26T14:55:35+08:00">
                2017-04-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/26/集群限流实现/" class="leancloud_visitors" data-flag-title="集群限流实现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在<a href="http://fengfu.io/2017/04/22/%E6%9C%8D%E5%8A%A1%E5%8C%96%E6%9E%B6%E6%9E%84-%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%99%90%E6%B5%81/">上一篇文章</a>中，提到了限流的方式分为单机限流和集群限流，在这篇文章中，就来看一下集群限流如何实现。</p>
<p>对于集群限流，我们一般会考虑以下三方面：</p>
<ol>
<li>分布式：能够进行全局限流，尤其在访问受限制的资源的情况下。比如某个第三方接口只允许每秒100次的访问量，但我们的应用是部署在多台服务器上，在这种情况下，就需要进行全局限流了；</li>
<li>滑动窗口：能够避免流量突变(比如洪峰)对系统的影响。比如我们限制了1秒的访问量不能超过100，但很有可能出现一种情况就是前900毫秒没有任何请求，但900毫秒的时候突然来了100个请求；在第2秒的前100毫秒又来了100个请求。这也就意味着在200毫秒的时间涌入了200个请求。这种情况也很有可能把系统打挂掉。</li>
<li>最小请求间隔：为了避免请求太频繁，还需要限制调用端的请求时间间隔，如果时间间隔太短，同样也需要限制；</li>
</ol>
<p>对于分布式的限流，需要使用分布式存储来存放请求的状态数据，在这里，我们使用Redis作为存储引擎。</p>
<h2 id="第一版实现"><a href="#第一版实现" class="headerlink" title="第一版实现"></a>第一版实现</h2><p>限流的标准实现一般是使用令牌桶算法，实现思路如下：</p>
<ol>
<li>每个接口都有一个对应的令牌桶，桶中含有若干令牌；</li>
<li>当用户发起请求的时候，首先从桶中获取一个令牌。在获取令牌的时候，首先会检查桶中剩余的令牌；</li>
<li>如果桶是空的，则表明已经达到上限，请求将被阻塞住；</li>
<li>反之，从桶中移除一个令牌，执行用户请求；</li>
<li>随着时间推移，按照一定的频率往桶里放入令牌，直到达到容量上限。</li>
</ol>
<p>这种算法的好处在于占用存储空间小，每个接口只需要一个整形计数器即可，不足之处在于：需要有额外的处理程序往桶里放令牌。如果系统有很多的接口，那也就意味着系统需要有很多的桶，而且每个桶都需要按照固定的速率放入令牌，那么这不仅会增加系统的压力，也会增加系统的复杂性。于是我们可以在此基础上进行优化：</p>
<h2 id="改进实现"><a href="#改进实现" class="headerlink" title="改进实现"></a>改进实现</h2><ol>
<li>每个接口有2个对应的key：令牌桶和桶被填充满时的时间戳；</li>
<li>当接口被访问的时候，读取对应的时间戳；</li>
<li>计算从上次访问到现在该请求可以获取的令牌数量；</li>
<li>如果满足要求，请求继续执行。</li>
</ol>
<p>不幸的是，这个算法也存在缺陷：我们需要同步令牌桶和时间戳的状态，如果同步失败，这种方案将会失效。Redis可以通过批量操作来保证原子操作，但计算用户可以获取多少令牌的时候，我们需要与Redis有两次交互：第一次获取上次访问的时间戳，第二次设置令牌的数量。如果你不想钻研Redis Lua脚本，恐怕我们无法在一个原子操作中实现上述需求。鉴于此，如果有2个客户端在同一时间来校验用户请求的时候，我们可能会得到下面的执行顺序：</p>
<ol>
<li>用户有足够的令牌来执行一个请求；</li>
<li>前后请求的间隔内，并没有新的令牌放入桶中；</li>
<li>客户端1获得存储的时间戳和令牌数量；</li>
<li>客户端2获得存储的时间戳和令牌数量；</li>
<li>客户端1通过计算断定令牌足够，放行请求，通知redis清空令牌桶；</li>
<li>客户端2通过计算也断定令牌足够，放行请求，通知redis清空令牌桶；</li>
</ol>
<p>无需多言，上述方案完全失效了，显然这情况并不是我们想要的。</p>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p>幸运的是，Redis有另外一种数据结构可以避免上述竞态条件-Sorted Set。下面是实现思路：</p>
<ol>
<li>每个接口都有一个对应的Sorted Set，set中key和value是唯一的，key和value都为请求提交时的时间戳；</li>
<li>当客户端提交请求时，首先将某个时间间隔前的元素全部清除，这个操作可以使用Redis的ZREMRANGEBYSCORE命令实现；</li>
<li>使用ZRANGE(0, -1)命令获取set中剩余的所有元素；</li>
<li>使用ZADD命令将当前请求的时间戳添加到set中；</li>
<li>设置TTL给set；TTL=限制请求的时间间隔。</li>
</ol>
<p>进行完上述所有操作后，计算获取到的元素数量，如果超出限制，则拒绝请求；</p>
<p>同时，获取获取的元素中最大的时间戳，与当前请求时间做比较。如果间隔太小，则拒绝请求；</p>
<p>这种方案的好处是所有的redis请求都可以使用MULTI命令作为一个原子操作。这意味着如果两个客户端请求相同的接口，是能够避免前面提到的竞态条件出现的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/04/23/服务化架构-服务降级/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/23/服务化架构-服务降级/" itemprop="url">服务化架构-服务降级</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-23T14:23:23+08:00">
                2017-04-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/23/服务化架构-服务降级/" class="leancloud_visitors" data-flag-title="服务化架构-服务降级">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-什么是降级"><a href="#1-什么是降级" class="headerlink" title="1. 什么是降级"></a>1. 什么是降级</h1><p>高可用系统为了保证自身的高可用性，会在异常情况下限制自身的一些能力，来保证核心功能的可用性。这有点类似武侠小说里面的壮士断腕，也有点类似于象棋里面的弃车保帅。</p>
<h1 id="2-为什么需要降级？"><a href="#2-为什么需要降级？" class="headerlink" title="2. 为什么需要降级？"></a>2. 为什么需要降级？</h1><p>在系统复杂度越来越高的今天，我们可能会经常遇到这样的困扰：一个非核心的功能异常最终导致了整个系统的不可用。比如一个获取非核心数据接口的超时最终导致了整个线程池全部阻塞，影响了核心功能线程的运行；业务链条中某个环节的接口不可用导致整个业务链的失败。这样的例子比比皆是，造成的损失往往也非常大，所以为了避免这种小功能搞垮大系统的情况发生，降级的概念就应运而生了。</p>
<h1 id="3-降级预案"><a href="#3-降级预案" class="headerlink" title="3. 降级预案"></a>3. 降级预案</h1><p>在要对系统制定降级策略之前，我们先对系统中的功能、服务进行梳理，识别出系统中的核心、非核心功能，这样能够梳理出哪些失败需要阻断主流程，哪些失败可以不阻断主流程。这样我们也就能确定哪些功能和服务必须死保，哪些功能和服务能够降级。<br>举个栗子：在机票的搜索流程中，报价、航班详情（如起降时间、航站楼）是关键信息，这些信息是无论如何不能缺失的；但餐食信息对于用户来讲就是可有可无的，当系统压力比较大的时候，我们就可以将餐食信息的获取给关掉，来优先保证核心数据的正常获取；<br>再举个栗子：对于机票的信息中，报价信息是经常变化的，但航班详情信息变化频率就没那么大。那么在系统压力比较大的情况下，可以将获取航班详情的方式由实时获取改为读取缓存，这样既不会导致数据准确性有太大的变化，也保证了系统核心功能的可用。</p>
<h1 id="4-降级策略"><a href="#4-降级策略" class="headerlink" title="4. 降级策略"></a>4. 降级策略</h1><h2 id="4-1-按功能降级"><a href="#4-1-按功能降级" class="headerlink" title="4.1 按功能降级"></a>4.1 按功能降级</h2><p>按功能降级是指在不影响核心功能的情况下，减少对非核心功能的使用，来保护系统的基本使用。<br>比如前面提到的例子，在机票搜索过程中，如果系统负载比较大出现超时，可以先将中转拼接报价计算功能（非核心功能）关闭，减少计算量，来降低系统负载保证用户搜索不至于失败；<br>再比如，在双11或者618的时候，系统的负载往往都比较大，这时候为了降低系统的负载，系统往往会把诸如支付后推荐、买了又买之类的非核心功能关闭。这些case我们可以参考淘宝、京东同学写的技术文章，例子不胜枚举。</p>
<h2 id="4-2-按来源降级"><a href="#4-2-按来源降级" class="headerlink" title="4.2 按来源降级"></a>4.2 按来源降级</h2><p>在某些时候，系统的QPS比较高，服务器扛不住压力的时候，可以针对请求进行限流。当然对于限流我们不能一刀切，如果能先限制某些不重要业务的访问，那是最好的。如果所有请求的重要程度是一样的，那么只能按照统一的策略进行限流了，毕竟牺牲掉部分用户请求来保证服务的可用性是第一位的。</p>
<h2 id="4-3-按质量降级"><a href="#4-3-按质量降级" class="headerlink" title="4.3 按质量降级"></a>4.3 按质量降级</h2><p>比如利用缓存。在机票行业，飞机上的舱位就相当于电商行业的库存，不同的是，电商的库存基本是自己管理，但机票的库存（舱位）是航司管理的，查询可用舱位花费的成本又很高。为了解决成本，我们可以针对某些冷门航线的舱位使用缓存，而且缓存时间设置得比较久，毕竟这些航线出票量比较少，没必要去占用过多的查询指令。</p>
<h1 id="5-降级介入方式"><a href="#5-降级介入方式" class="headerlink" title="5. 降级介入方式"></a>5. 降级介入方式</h1><p>在系统遇到异常情况时，我们需要执行事先准备的降级预案，这时候就需要额外的分支介入系统逻辑，来执行系统降级策略。降级的介入方式分为两种：人工介入和自动介入。当然有的时候在系统所处的局面比较复杂的时候，往往需要两者方式都需要使用，比如自动降级失效的情况下，那么必须进行人工介入了。</p>
<h2 id="5-1-人工介入"><a href="#5-1-人工介入" class="headerlink" title="5.1 人工介入"></a>5.1 人工介入</h2><p>人工介入的方式是指当系统维护人员在发现系统异常之后，通过人工修改参数、关闭服务等方式进行降级的方法。这种方式的好处是比较灵活，能够根据异常情况灵活应对；但弊端是对人的要求比较高，一来需要维护人员对系统有足够的了解，另外要求维护人员在系统异常时能够在第一时间进行处置。</p>
<h2 id="5-2-自动介入"><a href="#5-2-自动介入" class="headerlink" title="5.2 自动介入"></a>5.2 自动介入</h2><p>自动介入的方式一般是当系统达到某些设定的条件之后，自动执行一些策略。比如当系统以来的某个第三方数据接口的失败率达到设定的阈值，那么就使用缓存数据；再比如购买机票的时候，如果遇到航司接口维护，那么我们可以先收单，保证主流程不阻断，等航司接口恢复之后再执行出票处理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/04/22/服务化架构-服务的限流/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/22/服务化架构-服务的限流/" itemprop="url">服务化架构-服务的限流</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-22T11:20:23+08:00">
                2017-04-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/22/服务化架构-服务的限流/" class="leancloud_visitors" data-flag-title="服务化架构-服务的限流">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-什么是限流"><a href="#1-什么是限流" class="headerlink" title="1. 什么是限流"></a>1. 什么是限流</h1><p>顾名思义，限流就是限制请求量，当用户请求量达到设定的阈值之后，对超出部分的请求进行拒绝或者延时处理。</p>
<h1 id="2-为什么要限流"><a href="#2-为什么要限流" class="headerlink" title="2.为什么要限流"></a>2.为什么要限流</h1><p>限流是服务提供方进行自我保护的一种手段。如果对用户请求量不做限制，那么过多的请求很有可能会将服务器有限的资源消耗殆尽，最终导致服务器宕机，进而引发雪崩。所以对于高可用的系统来讲，限流是一种必不可少的手段。</p>
<h1 id="3-限流算法"><a href="#3-限流算法" class="headerlink" title="3. 限流算法"></a>3. 限流算法</h1><h2 id="3-1-令牌桶-Token-bucket"><a href="#3-1-令牌桶-Token-bucket" class="headerlink" title="3.1 令牌桶(Token bucket)"></a>3.1 令牌桶(Token bucket)</h2><p>令牌桶算法的基本过程如下:</p>
<ol>
<li>每秒会有 r 个令牌放入桶中，或者说，每过 1/r 秒桶中增加一个令牌;</li>
<li>桶中最多存放 b 个令牌，如果桶满了，新放入的令牌会被丢弃;</li>
<li>当一个 n 字节的数据包到达时，消耗 n 个令牌，然后发送该数据包;</li>
<li>如果桶中可用令牌小于 n，则该数据包将被缓存或丢弃;</li>
</ol>
<p><img src="https://farm5.staticflickr.com/4584/38326639342_90a3a6881d.jpg" alt=""></p>
<p>令牌桶算法的实现，可以借助于Google guava的RateLimiter实现，使用SmoothBursty模式。具体实现将在后面的blog中进行详细说明。</p>
<h2 id="3-2-漏桶-Leaky-bucket"><a href="#3-2-漏桶-Leaky-bucket" class="headerlink" title="3.2 漏桶(Leaky bucket)"></a>3.2 漏桶(Leaky bucket)</h2><p>漏桶算法强制一个常量的输出速率而不管输入数据流的突发性,当输入空闲时，该算法不执行任何动作.就像用一个底部开了个洞的漏桶接水一样,水进入到漏桶里,桶里的水通过下面的孔以固定的速率流出,当水流入速度过大会直接溢出,可以看出漏桶算法能强行限制数据的传输速率.如下图所示:<br><img src="https://farm5.staticflickr.com/4583/37643209824_71df07e1e7.jpg" alt=""></p>
<p>漏桶的实现，可以使用Guava RateLimiter的SmoothWarmingUp模式实现。</p>
<h2 id="3-3-令牌桶与漏桶算法的比较"><a href="#3-3-令牌桶与漏桶算法的比较" class="headerlink" title="3.3 令牌桶与漏桶算法的比较"></a>3.3 令牌桶与漏桶算法的比较</h2><p>令牌桶算法能够允许一定程度的流量突增，要令牌桶中存在令牌，那么就允许突发地传输数据直到达到用户配置的上限，因此它适合于具有突发特性的流量。<br>漏桶算法能够强行限制数据的传输速率，因此更适合进行平滑限流的应用场景，比如限制下载速率。</p>
<h1 id="4-限流方式"><a href="#4-限流方式" class="headerlink" title="4. 限流方式"></a>4. 限流方式</h1><h2 id="4-1-单机限流"><a href="#4-1-单机限流" class="headerlink" title="4.1 单机限流"></a>4.1 单机限流</h2><p>单机限流一般使用在对硬件资源进行保护的场景中，避免服务器过载而宕机，引发进一步的雪崩。比如对访问量进行限流。有同学可能会问了，我评估一个集群总体的阈值，用集群限流不也可以吗？这里面存在的隐患是，如果负载均衡策略不够均衡，可能会导致部分服务器存在热点，那么那些流量仍然有可能将这台热点服务器打挂掉，从而引发雪崩。</p>
<h2 id="4-2-集群限流"><a href="#4-2-集群限流" class="headerlink" title="4.2 集群限流"></a>4.2 集群限流</h2><p>集群限流的方式一般会使用在某些外部资源存在访问限制的情况下，比如依赖的第三方系统限制了请求的访问量，那么上游的系统就需要在请求第三方系统前进行全局的限流，避免对方因过载而拒绝服务。比如说抓取。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/04/11/使用JRebel远程热部署Class/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/11/使用JRebel远程热部署Class/" itemprop="url">使用 jrebel 远程部署开发环境的 dubbo 服务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-11T21:08:09+08:00">
                2017-04-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/11/使用JRebel远程热部署Class/" class="leancloud_visitors" data-flag-title="使用 jrebel 远程部署开发环境的 dubbo 服务">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文转自<a href="http://wulfric.me/2017/04/jrebel/" target="_blank" rel="external">http://wulfric.me/2017/04/jrebel/</a> ，如果转载请尊重原作者版权。</p>
<blockquote>
<p>声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" title="姓名标示-非商业性-禁止改作4.0国际" target="_blank" rel="external">CC BY-NC-ND 4.0</a> 授权。</p>
</blockquote>
<p><img src="https://zeroturnaround.com/wp-content/uploads/2011/02/jrebel-dl.png" alt="jrebel"></p>
<p>在开发 java 程序的时候，如果改动非常频繁，每次改动都要重新打包、部署，对于很重的应用（比如本文所说的 dubbo provider 服务），这样反复的流程十分消耗精力和热情。我们需要一个工具，当代码作改动之后能够立即看到效果。Java 在 1.4 的时候引入了 HotSwap 技术，允许调试者使用同一个类标识来更新类的字节码。这意味着所有对象都可以引用一个更新后的类，并在它们的方法被调用的时候执行新的代码，这就避免了无论何时只要有类的字节码被修改就要重载容器的这种要求<sup id="fnref:hotswap-jrebel"><a href="#fn:hotswap-jrebel">1</a></sup>。不幸的是，这种重定义仅限于修改方法体—除了方法体之外，它既不能添加方法或域，也不能修改其他任何东西。</p>
<p>和 PHP 这样的脚本语言不一样，Java 部署是一个令人心烦的问题。一个运行中的 Java 程序相当于一辆在公路上奔跑的汽车，而 HotSwap 技术只能让你更换坐垫，但是让你想要更换轮胎的时候，HotSwap 就帮不上忙了，这个时候你只能停下来，换掉轮胎，再重新启动。而对于 PHP 来说，每个请求都会新开一个进程加载所有的 .php 文件编译和执行，所以不存在这个问题。运行 PHP 程序相当于给静止的汽车拍照，你大可以换完轮胎之后再拍照，这没有任何不良影响。（这个比喻可能不太恰当，却很有趣：在比喻中，静态的语言看起来是运动的，而动态语言看起来是静止的）</p>
<p><a href="https://zeroturnaround.com/software/jrebel/" target="_blank" rel="external">JRebel</a> 是 java 的热部署插件，它监控已编译的 .class 文件，只要有变动，就立即更新在部署好的应用上，能够实现实时查看代码变化的功能。</p>
<p><img src="https://zeroturnaround.com/wp-content/uploads/2016/11/JR_devcycle_2016_c.png" alt="skip build, package and deploy"></p>
<p>skip build, package and deploy</p>
<p>HotSwap 是工作在虚拟机层面上，且依赖于 JVM 的内部运作，JRebel 用到了 JVM 的两个显著的功能特征—抽象的字节码和类加载器。类加载器允许 JRebel 辨别出类被加载的时刻，然后实时地翻译字节码，用以在虚拟机和可执行代码之间创建另一个抽象层<sup id="fnref:hotswap-jrebel:1"><a href="#fn:hotswap-jrebel">1</a></sup>。这种技术也应用在 zeroturnaround 家其他的工具，比如 xrebel。</p>
<p>如果继续使用上面的比喻，JRebel 相当于在汽车运行过程中，先额外生成一个轮胎，然后以迅雷之势替换掉目标轮胎—汽车不需要停止装载和再启动。</p>
<h2 id="安装和使用"><a href="#安装和使用" class="headerlink" title="安装和使用"></a>安装和使用</h2><p>JRebel 的安装参照官网即可，我是直接在 Intellij 的插件中心安装的，速度比较慢，插件也比较大，挂了代理才下载完成。下载完毕重启 IDE 即可使用。</p>
<p>JRebel 是收费插件，第一次打开的时候需要激活，网上有各种神奇教程可以参考。其实这个插件官方提供了免费的激活码，只要需要你注册一个<a href="https://my.jrebel.com/" target="_blank" rel="external">帐号</a>，并关联一个 twitter 或者 facebook 帐号即可。jrebel 需要这个关联帐号的写权限，会定期发送使用统计到你的 timeline，你可以使用一个小号来关联。</p>
<p>安装和激活完毕之后，就可以在 IDE 的配置页看到 JRebel 选项了。</p>
<p><a href="http://wulfric.qiniudn.com/java/jrebel-preference.png-origin.webp" target="_blank" rel="external"><img src="http://wulfric.qiniudn.com/java/jrebel-preference.png-article.webp" alt="jrebel preference"></a></p>
<p>jrebel preference</p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>为了能够比较熟悉该插件的使用，建议按照官方教程，先通过 IDE 本地启动，再通过命令行启动，然后尝试部署到远端服务器。</p>
<p>当在 console 窗口观察到这些输出之后，说明应用正确启用了 JRebel 插件。</p>
<pre><code>2017-04-01 16:27:31 JRebel:  #############################################################
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:  JRebel Agent 7.0.6 (201703201213)
2017-04-01 16:27:31 JRebel:  (c) Copyright ZeroTurnaround AS, Estonia, Tartu.
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:  Over the last 2 days JRebel prevented
2017-04-01 16:27:31 JRebel:  at least 0 redeploys/restarts saving you about 0 hours.
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:  JRebel started in remote server mode.
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:
2017-04-01 16:27:31 JRebel:  #############################################################
</code></pre><h3 id="IDE-运行"><a href="#IDE-运行" class="headerlink" title="IDE 运行"></a>IDE 运行</h3><p>IDE 运行本地应用最简单。参见<a href="https://zeroturnaround.com/software/jrebel/quickstart/intellij/?run=ide#!/server-configuration" target="_blank" rel="external">官方教程</a>。</p>
<ol>
<li>执行<span class="codespan">mvn clean</span>清空 target 目录；</li>
<li>打开 「View &gt; Tool Windows &gt; JRebel」调出 JRebel Panel 编辑窗，点击「generate rebel.xml」按钮选中需要监控和热部署的模块。因为是本地执行，所以另外一个「generate rebel-remote.xml」 不需要选中；</li>
<li>将以前通过 「Run ‘MyApp’」或者「Debug ‘MyApp’」来运行的命令改成「Run with JRebel ‘MyApp’」或者「Debug with JRebel ‘MyApp’」即可；</li>
<li>修改代码，然后在「Build」菜单下选择合适的构建选项（只构建单个文件/构建模块/构建项目）；</li>
<li>访问接口，查看结果是否实时改变。</li>
</ol>
<h3 id="命令行运行"><a href="#命令行运行" class="headerlink" title="命令行运行"></a>命令行运行</h3><p>在 JRebel 设置页的「Startup」标签中选择「Run locally from command line」， 选择合适的 jvm 和目标环境。我的 dubbo 使用了 netty 部署，所以选择了「Standalone application」，给出的启动参数如下。</p>
<pre><code># agentpath 是必需的，foo.bar.MyApp 是你要运行的程序
java -agentpath:/Users/xxxx/Library/Application Support/IntelliJIdea2017.1/jr-ide-idea/lib/jrebel6/lib/libjrebel64.dylib foo.bar.MyApp
</code></pre><p>P.S.: 注意上面的「Application Support」需要换成「Application\ Support」。</p>
<p>dubbo 一般推荐使用 start.sh 脚本来启动应用，我们编辑 start.sh 文件，在启动的具体位置那里，将「-agentpath:…」添加在 java 后面，大致如下。</p>
<pre><code>java -agentpath:... $JAVA_OPTS $JAVA_MEM_OPTS $JAVA_DEBUG_OPTS -classpath ...
</code></pre><p>各种目标环境的配置方法有着或大或小的区别，请按照自己的目标环境跟着 JRebel 给的配置方案来设置。</p>
<ol>
<li>配置启动参数，如上所述；</li>
<li>选择需要热部署的模块；</li>
<li>执行<span class="codespan">start.sh</span>部署应用；</li>
<li>Run with JRebel ‘MyApp’；</li>
<li>修改代码，构建改动的文件；</li>
<li>访问接口，查看结果是否实时改变。</li>
</ol>
<p>从输出结果可以看到，JRebel 接管了 console。</p>
<h3 id="远程服务器运行"><a href="#远程服务器运行" class="headerlink" title="远程服务器运行"></a>远程服务器运行</h3><p>官方<a href="https://zeroturnaround.com/software/jrebel/quickstart/intellij/?run=remote#!/server-configuration" target="_blank" rel="external">教程1</a>，<a href="https://manuals.zeroturnaround.com/jrebel/remoteserver/intellij.html" target="_blank" rel="external">教程2</a>更好<sup id="fnref:jrebel-doc"><a href="#fn:jrebel-doc">2</a></sup>。</p>
<p>同上，在 JRebel 配置页选择「Run on a remote server」，根据给出的建议配置好启动项。</p>
<pre><code>java -agentpath:... -Drebel.remoting_plugin=true ... -jar ...
</code></pre><p>在 JRebel 配置页添加远程服务器地址，注意要是能够 http 访问的 url 才可以。</p>
<figure><a class="post-image" rel="post-image" href=""><img src="https://manuals.zeroturnaround.com/jrebel/_images/intellij-add-remote-server.png" alt="添加远程服务器" title="添加远程服务器"></a><br></figure>

<p>添加远程服务器</p>
<ol>
<li>配置启动参数和添加远程服务器，如上所述；</li>
<li>选择需要热部署的模块，注意这个时候「generate rebel.xml」和「generate rebel-remote.xml」 两个都要选中；</li>
<li>将包含 rebel.xml 和 rebel-remote.xml 的代码部署到远程服务器。本地打包并上传，或者代码上传并在远程服务器打包都可以；</li>
<li>在远程服务器上<span class="codespan">start.sh</span>启动应用；</li>
<li>修改代码，构建改动的文件；</li>
<li>访问接口，查看结果是否实时改变。</li>
</ol>
<p>P.S.: 教程1似乎有些问题，远端启动应用后，本地不需要再「Run with JRebel ‘MyApp’」了。</p>
<p>P.S.: 在官方教程里，「Run with JRebel ‘MyApp’」和「generate rebel.xml」checkbox 的图标一模一样，注意区分：有的是让你启动，有的是选中。</p>
<p>P.S.: JRebel 对 Spring 的 bean 注入默认就有很好的支持，参见 <a href="https://zeroturnaround.com/software/jrebel/learn/jrebel-spring-integration/" target="_blank" rel="external">JRebel Spring</a>。它可以根据 xml 文件或者注解自动重新装载 bean。还支持动态实时地在 Spring 中添加 bean 和依赖。</p>
<ol>
<li><p>HotSwap 和 JRebel 原理<a href="https://dzone.com/articles/reloading-java-classes-401" target="_blank" rel="external">原文</a>，<a href="http://www.hollischuang.com/archives/598" target="_blank" rel="external">译文</a> <a href="#fnref:hotswap-jrebel">↩</a> <a href="#fnref:hotswap-jrebel:1">↩<sup>2</sup></a></p>
</li>
<li><p>参照官方的<a href="https://manuals.zeroturnaround.com/jrebel/index.html" target="_blank" rel="external">详细使用文档</a>是更好的选择 <a href="#fnref:jrebel-doc">↩</a></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2017/03/06/Spring Xml扩展机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/06/Spring Xml扩展机制/" itemprop="url">Spring xml扩展机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-06T18:41:09+08:00">
                2017-03-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/03/06/Spring Xml扩展机制/" class="leancloud_visitors" data-flag-title="Spring xml扩展机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Spring框架从2.0版本开始，提供了基于Schema风格的XML扩展机制，允许开发者扩展最基本的spring配置文件，这样我们就可以编写自定义的xml bean解析器然后集成到Spring IoC容器中。很多支持Spring的框架，比如Dubbo、mybatis都提供了对Spring xml扩展的支持。</p>
<p>Xml扩展大概有以下几个步骤：</p>
<ul>
<li>编写xml schema来描述自定义元素</li>
<li>编写自定义类</li>
<li>编写<code>NamespaceHandler</code>的实现类</li>
<li>编写<code>BeanDefinitionParser</code>实现类</li>
<li>把上述组件注册到Spring</li>
</ul>
<h2 id="编写自定义schema"><a href="#编写自定义schema" class="headerlink" title="编写自定义schema"></a>编写自定义schema</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns</span>=<span class="string">"http://www.mycompany.com/schema/product"</span></span></div><div class="line">        <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></div><div class="line">        <span class="attr">xmlns:beans</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></div><div class="line">        <span class="attr">targetNamespace</span>=<span class="string">"http://www.mycompany.com/schema/product"</span></div><div class="line">        <span class="attr">elementFormDefault</span>=<span class="string">"qualified"</span></div><div class="line">        <span class="attr">attributeFormDefault</span>=<span class="string">"unqualified"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"robot"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">xsd:extension</span> <span class="attr">base</span>=<span class="string">"beans:identifiedType"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"brand"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> <span class="attr">use</span>=<span class="string">"required"</span>/&gt;</span></div><div class="line">										<span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"type"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> <span class="attr">use</span>=<span class="string">"required"</span>/&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"height"</span> <span class="attr">type</span>=<span class="string">"xsd:int"</span>/&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"weight"</span> <span class="attr">type</span>=<span class="string">"xsd:float"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">xsd:extension</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="编写自定义类"><a href="#编写自定义类" class="headerlink" title="编写自定义类"></a>编写自定义类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> String brand;</div><div class="line">	<span class="keyword">private</span> String type;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> height;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">float</span> weight;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们就可以在xml中定义如下的robot元素:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">product:robot</span> <span class="attr">id</span>=<span class="string">"bb8"</span> <span class="attr">brand</span>=<span class="string">"StarWar"</span> <span class="attr">type</span>=<span class="string">"bb8"</span> <span class="attr">height</span>=<span class="string">"100"</span> <span class="attr">weight</span>=<span class="string">"20"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="编写NamespaceHandler"><a href="#编写NamespaceHandler" class="headerlink" title="编写NamespaceHandler"></a>编写NamespaceHandler</h2><p><code>NamespaceHandler</code>用于解析我们自定义名字空间下的所有元素，目前我们要解析上面的<code>product:robot</code>元素。<br><code>NamespaceHandler</code>里面只有3个方法：</p>
<ul>
<li><code>init()</code>会在<code>NamespaceHandler</code>初始化的时候被调用。</li>
<li><code>BeanDefinition parse(Element, ParserContext)</code> - 当Spring遇到一个顶层元素的时候被调用。</li>
<li><code>BeanDefinitionHolder decorate(Node, BeanDefinitionHolder, ParserContext)</code> - 当Spring遇到一个属性或嵌套元素的时候调用.</li>
</ul>
<p>Spring提供了默认实现类<code>NamespaceHandlerSupport</code>，我们只需在init的时候注册每个元素的解析器即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">//遇到robot元素的时候交给RobotBeanDefinitionParser来解析</span></div><div class="line">		registerBeanDefinitionParser(<span class="string">"robot"</span>, <span class="keyword">new</span> RobotBeanDefinitionParser());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="编写BeanDefinitionParser"><a href="#编写BeanDefinitionParser" class="headerlink" title="编写BeanDefinitionParser"></a>编写BeanDefinitionParser</h2><p>这样在解析xml过程中遇到robot元素时，Spring会交给RobotBeanDefinitionParser来解析。RobotBeanDefinitionParser取出相应的属性然后设置到bean中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RobotBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</div><div class="line">		<span class="comment">//robot元素对应Robot对象类型</span></div><div class="line">		<span class="keyword">return</span> Robot.class;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</div><div class="line"></div><div class="line">		String brand = element.getAttribute(<span class="string">"brand"</span>);</div><div class="line">		String type = element.getAttribute(<span class="string">"type"</span>);</div><div class="line">		String height = element.getAttribute(<span class="string">"height"</span>);</div><div class="line">		String weight = element.getAttribute(<span class="string">"weight"</span>);</div><div class="line"></div><div class="line">		<span class="comment">//把对应的属性设置到bean中</span></div><div class="line">		<span class="keyword">if</span>(StringUtils.hasText(brand))</div><div class="line">			builder.addPropertyValue(<span class="string">"brand"</span>, brand);</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(StringUtils.hasText(type))</div><div class="line">			builder.addPropertyValue(<span class="string">"type"</span>, type);</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(StringUtils.hasText(height))</div><div class="line">			builder.addPropertyValue(<span class="string">"height"</span>, height);</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(StringUtils.hasText(weight))</div><div class="line">			builder.addPropertyValue(<span class="string">"weight"</span>, weight);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="注册handler和schema"><a href="#注册handler和schema" class="headerlink" title="注册handler和schema"></a>注册handler和schema</h2><p>为了让Spring在解析xml的时候能够感知到我们的自定义元素，我们需要把<code>namespaceHandler</code>和xsd文件放到2个指定的配置文件中，这2个文件都位于<code>META-INF</code>目录中。</p>
<h4 id="META-INF-spring-handlers"><a href="#META-INF-spring-handlers" class="headerlink" title="META-INF/spring.handlers"></a>META-INF/spring.handlers</h4><p><code>`spring.handlers` </code>文件包含了xml schema uri和handler类的映射关系，比如：</p>
<blockquote>
<p>http\://www.mycompany.com/schema/product=spring.xml.ext.schema.ProductNamespaceHandler</p>
</blockquote>
<p>这表示遇到<code>http://www.mycompany.com/schema/product</code>命名空间的时候会交给<code>ProductNamespaceHandler</code>来处理。</p>
<p>注意上面的冒号转义。<br>key部分必须和xsd文件中的<code>targetNamespace</code>值保持一致。</p>
<h4 id="META-INF-spring-schemas"><a href="#META-INF-spring-schemas" class="headerlink" title="META-INF/spring.schemas"></a>META-INF/spring.schemas</h4><blockquote>
<p>http\://www.mycompany.com/schema/product.xsd=META-INF/product.xsd</p>
</blockquote>
<h2 id="最后测试下"><a href="#最后测试下" class="headerlink" title="最后测试下"></a>最后测试下</h2><p>写个Spring配置文件products.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> 	<span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">		<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">		<span class="attr">xmlns:my</span>=<span class="string">"http://www.mycompany.com/schema/product"</span></div><div class="line">		<span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></div><div class="line">	        http://www.springframework.org/schema/beans</div><div class="line">	        http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">	        http://www.mycompany.com/schema/product</div><div class="line">	        http://www.mycompany.com/schema/product.xsd"&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">product:robot</span> <span class="attr">id</span>=<span class="string">"bb8"</span> <span class="attr">brand</span>=<span class="string">"StarWar"</span> <span class="attr">type</span>=<span class="string">"bb8"</span> <span class="attr">height</span>=<span class="string">"100"</span> <span class="attr">weight</span>=<span class="string">"20"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(locations = &#123; <span class="string">"classpath:products.xml"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchemaTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	<span class="meta">@Qualifier</span>(<span class="string">"bb8"</span>)</div><div class="line">	<span class="keyword">private</span> Robot robot;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">propertyTest</span><span class="params">()</span> </span>&#123;</div><div class="line">		assertNotNull(robot);</div><div class="line"></div><div class="line">		String brand = robot.getBrand();</div><div class="line">		String type = robot.getType();</div><div class="line">		<span class="keyword">int</span> height = robot.getHeight();</div><div class="line">		<span class="keyword">float</span> weight = robot.getWeight();</div><div class="line"></div><div class="line">		assertEquals(<span class="string">"Brand should be bb8."</span>, <span class="string">"bb8"</span>, brand);</div><div class="line">		assertEquals(<span class="string">"Type should be bb8."</span>, <span class="string">"bb8"</span>, type);</div><div class="line">		assertEquals(<span class="string">"Height should be 100."</span>, <span class="number">100</span>, height);</div><div class="line">		assertEquals(<span class="string">"Weight should be 20."</span>, <span class="number">20</span>, weight);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://blog.csdn.net/cutesource/article/details/5864562" target="_blank">基于Spring可扩展Schema提供自定义配置支持</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2016/12/14/jcmd命令详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/14/jcmd命令详解/" itemprop="url">jcmd命令详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-14T16:28:59+08:00">
                2016-12-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2016/12/14/jcmd命令详解/" class="leancloud_visitors" data-flag-title="jcmd命令详解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>在JDK 1.7及之后的版本，新增了一个命令行工具jcmd。它是一个多功能工具，可以做哪些事情呢？这里先卖个关子，先来看看Oracle官方对jcmd的介绍:</p>
<p><em>The jcmd utility is used to send diagnostic command requests to the JVM, where these requests are useful for controlling Java Flight Recordings, troubleshoot, and diagnose JVM and Java Applications. It must be used on the same machine where the JVM is running, and have the same effective user and group identifiers that were used to launch the JVM.</em></p>
<p>翻译成人话就是：<br>jcmd一个用来发送诊断命令请求到JVM的工具，这些请求对于控制Java飞行记录器、故障排除、JVM和Java应用诊断来说是比较有用的。jcmd必须与正在运行的JVM在同一台机器上使用，并且使用启动该JVM时的用户权限。</p>
<h1 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h1><p>jcmd的用法是:<br><code>jcmd &lt;process id/main class&gt; &lt;command&gt; [options]</code></p>
<p>其中command的说明如下：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>help</td>
<td>打印帮助信息，示例：jcmd <pid> help [<command name="">]</pid></td>
</tr>
<tr>
<td>ManagementAgent.stop</td>
<td>停止JMX Agent</td>
</tr>
<tr>
<td>ManagementAgent.start_local</td>
<td>开启本地JMX Agent</td>
</tr>
<tr>
<td>ManagementAgent.start</td>
<td>开启JMX Agent</td>
</tr>
<tr>
<td>Thread.print</td>
<td>参数-l打印java.util.concurrent锁信息，相当于：jstack <pid></pid></td>
</tr>
<tr>
<td>PerfCounter.print</td>
<td>相当于：jstat -J-Djstat.showUnsupported=true -snap <pid></pid></td>
</tr>
<tr>
<td>GC.class_histogram</td>
<td>相当于：jmap -histo <pid></pid></td>
</tr>
<tr>
<td>GC.heap_dump</td>
<td>相当于：jmap -dump:format=b,file=xxx.bin <pid></pid></td>
</tr>
<tr>
<td>GC.run_finalization</td>
<td>相当于：System.runFinalization()</td>
</tr>
<tr>
<td>GC.run</td>
<td>相当于：System.gc()</td>
</tr>
<tr>
<td>VM.uptime</td>
<td>参数-date打印当前时间，VM启动到现在的时候，以秒为单位显示</td>
</tr>
<tr>
<td>VM.flags</td>
<td>参数-all输出全部，相当于：jinfo -flags <pid>, jinfo -flag <vm flag=""> <pid></pid></vm></pid></td>
</tr>
<tr>
<td>VM.system_properties</td>
<td>相当于：jinfo -sysprops <pid></pid></td>
</tr>
<tr>
<td>VM.command_line</td>
<td>相当于：jinfo -sysprops <pid></pid></td>
<td>grep command</td>
</tr>
<tr>
<td>VM.version</td>
<td>相当于：jinfo -sysprops <pid></pid></td>
<td>grep version</td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2016/11/23/服务化架构-注册与发现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/23/服务化架构-注册与发现/" itemprop="url">服务化架构-注册与发现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-23T14:21:40+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2016/11/23/服务化架构-注册与发现/" class="leancloud_visitors" data-flag-title="服务化架构-注册与发现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h1><p>在分布式系统中，服务提供端和消费端彼此不知道对方的存在，因此需要有一种机制来确保消费端能够找到提供端并进行调用。一般来说，提供端需要将自己能够提供的服务信息暴露出来，这样消费端通过检索就能找到自己需要的服务并建立连接进行调用。所以，对于服务提供端来讲，需要具备以下功能：</p>
<ol>
<li>服务注册：将服务信息暴露出来，供消费端查找和使用</li>
<li>取消注册：即注销服务的注册信息</li>
</ol>
<p>同时，对于消费端来说，则需要：</p>
<ol>
<li>服务检索：按一定条件查找服务信息，如按应用、接口、IP等检索</li>
<li>服务订阅：订阅特定的服务，为后面的服务调用和治理做前期准备</li>
<li>取消订阅：取消指定服务的订阅</li>
</ol>
<h1 id="结构组成"><a href="#结构组成" class="headerlink" title="结构组成"></a>结构组成</h1><p>在这种情况下，注册中心的概念就被提了出来。</p>
<p>同时，系统间调用需要能够根据服务的运行状态(如上下线状态、负载、响应时间、网络情况等)而灵活调整调用端与服务端的组合。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2016/11/23/服务化架构-组成/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/23/服务化架构-组成/" itemprop="url">服务化架构-组成</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-23T14:21:06+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2016/11/23/服务化架构-组成/" class="leancloud_visitors" data-flag-title="服务化架构-组成">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="功能结构"><a href="#功能结构" class="headerlink" title="功能结构"></a>功能结构</h1><p>既然是服务化架构，那么肯定会包含服务提供方和调用方，即provider和consumer。那么作为分布式的服务化架构，需要有一个地方存储provider的信息，便于consumer调用，那么这个角色就是注册中心(registry)。</p>
<p>另外，鉴于分布式系统的复杂性和状态多样性，我们需要对provider、consumer、registry进行管理，比如服务依赖管理、权限管理、配置管理、版本管理、流量控制、服务上下线等，那么管理端(administrator)也就成了标配。</p>
<p>所以综上所述，一个完整的分布式服务化架构，应该包含4部分：</p>
<ol>
<li>注册中心Registry</li>
<li>服务提供端Provider</li>
<li>服务消费端Consumer</li>
<li>管理端Administrator</li>
</ol>
<p><img src="https://img.alicdn.com/imgextra/i3/2657627814/TB2_wgncKNOdeFjSZFBXXctzXXa_!!2657627814.png" alt=""></p>
<p>其中，Provider将自己能够提供的服务信息登记到注册中心，同时通过心跳的方式定时更新自己的状态。Consumer从Registry获取可用服务信息后，直接与Provider建立连接进行交互。</p>
<p>这种架构，基于RPC的服务框架如dubbo/dubbox，JSF都是采用这种机制。</p>
<p>另外，一些基于REST的服务框架（比如Spring Cloud）会增加服务路由的组件，也就是说Consumer需要经过服务路由才能请求Provider，这种方式下，其架构就是由5部分组成：</p>
<ol>
<li>注册中心Registry</li>
<li>服务提供端Provider</li>
<li>服务消费端Consumer</li>
<li>服务路由Router</li>
<li>管理端Administrator</li>
</ol>
<p><img src="https://img.alicdn.com/imgextra/i4/2657627814/TB29vfhdNaJ.eBjSsziXXaJ_XXa_!!2657627814.png" alt=""></p>
<p>经由服务路由调用的方式，典型的代表是Spring Cloud，如下图：</p>
<p><img src="https://img.alicdn.com/imgextra/i3/2657627814/TB28lS_dH1J.eBjSszcXXbFzVXa_!!2657627814.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fengfu.io/2016/11/23/服务化架构-前言/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宁静·致远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宁静·致远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/23/服务化架构-前言/" itemprop="url">服务化架构-前言</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-23T11:20:00+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2016/11/23/服务化架构-前言/" class="leancloud_visitors" data-flag-title="服务化架构-前言">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>近两年，微服务的概念逐渐火了起来，而docker的出现，更是在微服务的火上浇了一桶油。纯粹地讲，我不太认同微服务的说法。说白了，你还是一个服务，只是因为你的小微，有些地方你需要特别注意，比如高内聚、低耦合，比如团队规模的“两个披萨”原则等。但其实这些原则对于“服务”的世界来讲，早就是普世价值了。</p>
<p>那我们再往前看5年，那时候服务化的架构已经开始在业界崭露头角，比如2011年的时候，阿里把内部的dubbo框架开源了。从当前的标准来看，dubbo并不是一个非常优秀的服务化框架，它有很多缺陷和缺失，但是在5年前，这已经难能可贵了。</p>
<p>上周，在朋友的公司做了一次服务化架构的内训。为了准备这个PPT，特地将服务化框架的体系做了一个梳理，因此决定趁热打铁，写个系列博客进行更进一步的总结。</p>
<p>这个系列的文章，将从以下几个方面进行总结：</p>
<ol>
<li>服务化架构的组成</li>
<li>服务注册与发现</li>
<li>RPC</li>
<li>同步与异步</li>
<li>服务依赖管理</li>
<li>服务链路跟踪</li>
<li>服务路由</li>
<li>服务负载均衡</li>
<li>服务降级</li>
<li>服务限流</li>
<li>服务上下线</li>
<li>服务授权</li>
<li>服务监控与告警</li>
<li>服务版本管理</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="宁静·致远" />
          <p class="site-author-name" itemprop="name">宁静·致远</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">47</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">宁静·致远</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Gemini
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("pq7j7M6jaVzlRAhO3VhuFy1O-gzGzoHsz", "Fqlk4xsApzNKqC5HV87nMkix");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
